<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6"/>
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">
  
  <meta name="generator" content="Hexo 7.0.0">

  

  

  
    <meta name="author" content="Blair Ren">
  

  

  

  <title>Androidå›¾å½¢æ˜¾ç¤ºç®€è¿° | Renaissance</title>

  

  
    <link rel="shortcut icon" href="/Tom.ico">
  

  <!--mathjax latexæ•°å­¦å…¬å¼æ˜¾ç¤ºæ”¯æŒ-->
  
  

  

  

  
<link rel="stylesheet" href="/css/style.css">

</head>
<body>
  <div class="root-container">
    
<!-- header container -->
<header class="header-container post">
  
    <div class="post-image" style="background-image: url(https://github.com/BlairRenaissance/ImageHost/blob/main/WechatIMG61.jpg?raw=true)"></div>
  

  <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          Renaissance
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">Home</a></li>
        
          <li class="navbar-list-item"><a href="/archives/">Archives</a></li>
        
          <li class="navbar-list-item"><a href="/category/">Categories</a></li>
        
          <li class="navbar-list-item"><a href="/tag/">Tags</a></li>
        
          <li class="navbar-list-item"><a href="/about">About</a></li>
        
      </ul>
    </div>
  </div>
</nav>

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-text layout-block">
        <div class="layout-margin">
          <h1 class="title-wrap">Androidå›¾å½¢æ˜¾ç¤ºç®€è¿°</h1>
          <h2 class="title-sub-wrap">
            <strong>Blair Ren</strong>
            <span>å‘å¸ƒäº</span>
            <time  class="article-date" datetime="2024-01-09T16:00:00.000Z" itemprop="datePublished">2024-01-10</time>
          </h2>
          
            <h2 class="last-time">
              <span>æœ€åæ›´æ–°äº</span>
              <time  class="article-updated" datetime="2024-02-01T06:55:34.370Z" itemprop="dateUpdated">2024-02-01</time>
            </h2>
          
          
          <ul class="wrap-list dark">
  
    <li><a href="/category/Android/">ğŸ“’ Android</a></li>
  
</ul>
          <ul class="wrap-list dark">
  
    <li><a href="/tag/Android/">ğŸ·ï¸ Android</a></li>
  
</ul>
        </div>
      </div>
    </div>
  

  
  
  
</header>

    <!-- æ–‡ç«  -->

<!-- æ–‡ç« å†…å®¹ -->
<div class="body-container">
  <article class="content-container layout-block post-container">
    <div class="article-info">
      
      
      
      
      <section class="article-entry markdown-body layout-margin content-padding--large soft-size--large soft-style--box">
        <p><code>Android</code>Â å›¾å½¢Â <code>Graphic</code>Â å’Œæ˜¾ç¤ºÂ <code>Display</code>Â æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œè¿™é‡Œæ”¾åœ¨ä¸€èµ·ç®€è¿°ï¼›ä»‹ç»äº†å›¾åƒå’Œæ˜¾ç¤ºç›¸å…³çš„åŸºæœ¬æ¦‚å¿µï¼Œæ¯”å¦‚Â <code>BufferQueue</code>Â ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ŒÂ <code>Surface/SurfaceFlinger</code>Â å›¾å½¢åˆæˆç­‰ç­‰ã€‚</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>åº”ç”¨å¼€å‘è€…å¯é€šè¿‡ä¸¤ç§æ–¹å¼å°†å›¾åƒç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼šä½¿ç”¨Â <code>Canvas</code>Â æˆ–Â <code>OpenGL</code>Â ï¼š</p>
<ul>
<li><code>android.graphics.Canvas</code>Â æ˜¯ä¸€ä¸ªÂ <code>2D</code>Â å›¾å½¢Â <code>API</code>Â ï¼ŒÂ <code>Canvas API</code>Â é€šè¿‡ä¸€ä¸ªåä¸ºÂ <code>OpenGLRenderer</code>Â çš„ç»˜åˆ¶åº“å®ç°ç¡¬ä»¶åŠ é€Ÿï¼Œè¯¥ç»˜åˆ¶åº“å°†Â <code>Canvas</code>Â è¿ç®—è½¬æ¢ä¸ºÂ <code>OpenGL</code>Â è¿ç®—ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨Â <code>GPU</code>Â ä¸Šæ‰§è¡Œã€‚ä»Â <code>Android 4.0</code>Â å¼€å§‹ï¼Œç¡¬ä»¶åŠ é€Ÿçš„Â <code>Canvas</code>Â é»˜è®¤æƒ…å†µä¸‹å¤„äºå¯ç”¨çŠ¶æ€</li>
<li>é™¤äº†Â <code>Canvas</code>ï¼Œå¼€å‘è€…æ¸²æŸ“å›¾å½¢çš„å¦ä¸€ä¸ªä¸»è¦æ–¹å¼æ˜¯ä½¿ç”¨Â <code>OpenGL ES</code>Â ç›´æ¥æ¸²æŸ“åˆ°Â <code>Surface</code>Â ã€‚Â <code>Android</code>Â åœ¨Â <code>Android.opengl</code>Â è½¯ä»¶åŒ…ä¸­æä¾›äº†Â <code>OpenGL ES</code>Â æ¥å£</li>
</ul>
<h3 id="EGL"><a href="#EGL" class="headerlink" title="EGL"></a>EGL</h3><p>å…ˆç†Ÿæ‚‰Â <code>Android</code>Â å¹³å°å›¾å½¢å¤„ç†Â <code>API</code>Â çš„æ ‡å‡†ï¼š</p>
<ul>
<li><code>OpenGL</code><br>  æ˜¯ç”±Â <code>SGI</code>Â å…¬å¸å¼€å‘çš„ä¸€å¥—Â <code>3D</code>Â å›¾å½¢è½¯ä»¶æ¥å£æ ‡å‡†ï¼Œç”±äºå…·æœ‰ä½“ç³»ç»“æ„ç®€å•åˆç†ã€ä½¿ç”¨æ–¹ä¾¿ã€ä¸æ“ä½œå¹³å°æ— å…³ç­‰ä¼˜ç‚¹ï¼ŒÂ <code>OpenGL</code>Â è¿…é€Ÿæˆä¸ºÂ <code>3D</code>Â å›¾å½¢æ¥å£çš„å·¥ä¸šæ ‡å‡†ï¼Œå¹¶é™†ç»­åœ¨å„ç§å¹³å°ä¸Šå¾—ä»¥å®ç°ã€‚</li>
<li><code>OpenGL ES</code><br>  æ˜¯ç”±Â <code>khronos</code>Â ç»„ç»‡æ ¹æ®æ‰‹æŒåŠç§»åŠ¨å¹³å°çš„ç‰¹ç‚¹ï¼Œå¯¹Â <code>OpenGL 3D</code>Â å›¾å½¢Â <code>API</code>Â æ ‡å‡†è¿›è¡Œè£å‰ªå®šåˆ¶è€Œå½¢æˆçš„ã€‚</li>
<li><code>Vulkan</code><br>  æ˜¯ç”±Â <code>khronos</code>Â ç»„ç»‡åœ¨ 2016 å¹´æ­£å¼å‘å¸ƒçš„ï¼Œæ˜¯Â <code>OpenGL ES</code>Â çš„ç»§ä»»è€…ã€‚Â <code>API</code>Â æ˜¯è½»é‡çº§ã€æ›´è´´è¿‘åº•å±‚ç¡¬ä»¶Â <code>close-to-the-metal</code>Â çš„æ¥å£ï¼Œå¯ä½¿Â <code>GPU</code>Â é©±åŠ¨è½¯ä»¶è¿ç”¨å¤šæ ¸ä¸å¤šçº¿ç¨‹Â <code>CPU</code>Â æ€§èƒ½ã€‚</li>
</ul>
<p><code>OpenGL ES</code>Â å®šä¹‰äº†ä¸€ä¸ªæ¸²æŸ“å›¾å½¢çš„Â <code>API</code>Â ï¼Œä½†æ²¡æœ‰å®šä¹‰çª—å£ç³»ç»Ÿã€‚ä¸ºäº†è®©å®ƒèƒ½å¤Ÿé€‚åˆå„ç§å¹³å°ï¼Œå®ƒå°†ä¸çŸ¥é“å¦‚ä½•é€šè¿‡æ“ä½œç³»ç»Ÿåˆ›å»ºå’Œè®¿é—®çª—å£çš„åº“ç»“åˆä½¿ç”¨ã€‚è€Œåœ¨Â <code>Android</code>Â ä¸­ï¼Œè¿™ä¸ªåº“è¢«ç§°ä¸ºÂ <code>EGL</code>Â ï¼›ä¹Ÿå°±æ˜¯è¯´Â <code>EGL</code>Â ä¸»è¦æ˜¯é€‚é…ç³»ç»Ÿå’Œå…³è”çª—å£å±æ€§ã€‚å¦‚æœè¦ç»˜åˆ¶çº¹ç†å¤šè¾¹å½¢ï¼Œåº”ä½¿ç”¨Â <code>OpenGL ES</code>Â è°ƒç”¨ï¼›å¦‚æœè¦åœ¨å±å¹•ä¸Šè¿›è¡Œæ¸²æŸ“ï¼Œåº”ä½¿ç”¨Â <code>EGL</code>Â è°ƒç”¨ã€‚<br><code>OpenGL ES</code>Â æ˜¯Â <code>Android</code>Â ç»˜å›¾Â <code>API</code>Â ï¼Œä½†Â <code>OpenGL ES</code>Â æ˜¯å¹³å°é€šç”¨çš„ï¼Œåœ¨ç‰¹å®šè®¾å¤‡ä¸Šä½¿ç”¨éœ€è¦ä¸€ä¸ªä¸­é—´å±‚åšé€‚é…ï¼ŒÂ <code>Android</code>Â ä¸­è¿™ä¸ªä¸­é—´å±‚å°±æ˜¯Â <code>EGL</code>Â ã€‚</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-android-egl.jpg"></p>
<h3 id="Surface-SurfaceFlinger"><a href="#Surface-SurfaceFlinger" class="headerlink" title="SurfaceÂ &amp;Â SurfaceFlinger"></a><code>Surface</code>Â &amp;Â <code>SurfaceFlinger</code></h3><p>æ— è®ºå¼€å‘è€…ä½¿ç”¨ä»€ä¹ˆæ¸²æŸ“Â <code>API</code>ï¼Œä¸€åˆ‡å†…å®¹éƒ½ä¼šæ¸²æŸ“åˆ°Â <code>Surface</code>Â ã€‚Â <code>Surface</code>Â è¡¨ç¤ºç¼“å†²é˜Ÿåˆ—ä¸­çš„ç”Ÿäº§è€…ï¼Œè€Œç¼“å†²é˜Ÿåˆ—é€šå¸¸ä¼šè¢«Â <code>SurfaceFlinger</code>Â æ¶ˆè€—ã€‚åœ¨Â <code>Android</code>Â å¹³å°ä¸Šåˆ›å»ºçš„æ¯ä¸ªçª—å£éƒ½ç”±Â <code>Surface</code>Â æä¾›æ”¯æŒã€‚æ‰€æœ‰è¢«æ¸²æŸ“çš„å¯è§Â <code>Surface</code>Â éƒ½è¢«Â <code>SurfaceFlinger</code>Â åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚å®ƒä»¬éµå¾ªç”Ÿäº§è€… &#x2F; æ¶ˆè´¹è€…æ¨¡å‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-ape_fwk_graphics.png"></p>
<ul>
<li>å›¾åƒæµç”Ÿäº§è€…<br>  å›¾åƒæµç”Ÿäº§è€…å¯ä»¥æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºä»¥ä¾›æ¶ˆè€—çš„ä»»ä½•å†…å®¹ã€‚ä¾‹å¦‚Â <code>OpenGL ES, Canvas 2D, mediaserver</code>Â è§†é¢‘è§£ç å™¨ã€‚</li>
<li>å›¾åƒæµæ¶ˆè´¹è€…<br>  å›¾åƒæµçš„æœ€å¸¸è§æ¶ˆè´¹è€…æ˜¯Â <code>SurfaceFlinger</code>Â ï¼Œè¯¥ç³»ç»ŸæœåŠ¡ä¼šæ¶ˆè€—å½“å‰å¯è§çš„Â <code>Surface</code>Â ï¼Œå¹¶ä½¿ç”¨çª—å£ç®¡ç†å™¨ä¸­æä¾›çš„ä¿¡æ¯å°†å®ƒä»¬åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚Â <code>SurfaceFlinger</code>Â æ˜¯å¯ä»¥ä¿®æ”¹æ‰€æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹çš„å”¯ä¸€æœåŠ¡ã€‚Â <code>SurfaceFlinger</code>Â ä½¿ç”¨Â <code>OpenGL</code>Â å’ŒÂ <code>Hardware Composer</code>Â æ¥åˆæˆä¸€ç»„Â <code>Surface</code>Â ã€‚<br>  å…¶ä»–Â <code>OpenGL ES</code>Â åº”ç”¨ä¹Ÿå¯ä»¥æ¶ˆè€—å›¾åƒæµï¼Œä¾‹å¦‚ç›¸æœºåº”ç”¨ä¼šæ¶ˆè€—ç›¸æœºé¢„è§ˆå›¾åƒæµã€‚éÂ <code>GL</code>Â åº”ç”¨ä¹Ÿå¯ä»¥æ˜¯æ¶ˆè´¹è€…ï¼Œä¾‹å¦‚Â <code>ImageReader</code>Â ç±»ã€‚</li>
</ul>
<h3 id="WMS"><a href="#WMS" class="headerlink" title="WMS"></a><code>WMS</code></h3><p>çª—å£ç®¡ç†å™¨ï¼ˆ WindowManagerServicesï¼‰ï¼Œæ§åˆ¶çª—å£çš„Â <code>Android</code>Â ç³»ç»ŸæœåŠ¡ï¼Œå®ƒæ˜¯è§†å›¾å®¹å™¨ã€‚çª—å£æ€»æ˜¯ç”±Â <code>Surface</code>Â æä¾›æ”¯æŒã€‚è¯¥æœåŠ¡ä¼šç›‘ç£ç”Ÿå‘½å‘¨æœŸã€è¾“å…¥å’Œèšç„¦äº‹ä»¶ã€å±å¹•æ–¹å‘ã€è½¬æ¢ã€åŠ¨ç”»ã€ä½ç½®ã€å˜å½¢ã€Â <code>Z-Order</code>Â ä»¥åŠçª—å£çš„å…¶ä»–è®¸å¤šæ–¹é¢ã€‚çª—å£ç®¡ç†å™¨ä¼šå°†æ‰€æœ‰çª—å£å…ƒæ•°æ®å‘é€åˆ°Â <code>SurfaceFlinger</code>Â ï¼Œä»¥ä¾¿Â <code>SurfaceFlinger</code>Â å¯ä»¥ä½¿ç”¨è¯¥æ•°æ®åœ¨æ˜¾ç¤ºéƒ¨åˆ†åˆæˆÂ <code>Surface</code>Â ã€‚</p>
<h3 id="FrameBuffer"><a href="#FrameBuffer" class="headerlink" title="FrameBuffer"></a><code>FrameBuffer</code></h3><p><code>FrameBuffer</code>Â å¸§ç¼“å†²é©±åŠ¨ï¼Œå®ƒæ˜¯Â <code>Linux</code>Â çš„ä¸€ç§é©±åŠ¨ç¨‹åºæ¥å£ã€‚Â <code>Linux</code>Â æ˜¯å·¥ä½œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥ç”¨æˆ·æ€è¿›ç¨‹æ˜¯æ— æ³•åƒÂ <code>DOS</code>Â é‚£æ ·ä½¿ç”¨æ˜¾å¡Â <code>BIOS</code>Â é‡Œæä¾›çš„ä¸­æ–­è°ƒç”¨æ¥å®ç°ç›´æ¥å†™å±ï¼ŒÂ <code>Linux</code>Â æŠ½è±¡å‡ºÂ <code>FrameBuffer</code>Â è¿™ä¸ªè®¾å¤‡æ¥ä¾›ç”¨æˆ·æ€è¿›ç¨‹å®ç°ç›´æ¥å†™å±ã€‚Â <code>FrameBuffer</code>Â æœºåˆ¶æ¨¡ä»¿æ˜¾å¡çš„åŠŸèƒ½ï¼Œå°†æ˜¾å¡ç¡¬ä»¶ç»“æ„æŠ½è±¡æ‰ï¼Œå¯ä»¥é€šè¿‡Â <code>FrameBuffer</code>Â çš„è¯»å†™ç›´æ¥å¯¹æ˜¾å­˜è¿›è¡Œæ“ä½œã€‚ç”¨æˆ·å¯ä»¥å°†Â <code>FrameBuffer</code>Â çœ‹æˆæ˜¯æ˜¾ç¤ºå†…å­˜çš„ä¸€ä¸ªæ˜ åƒï¼Œå°†å…¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œå†™æ“ä½œå¯ä»¥ç«‹å³ååº”åœ¨å±å¹•ä¸Šã€‚è¿™ç§æ“ä½œæ˜¯æŠ½è±¡çš„ç»Ÿä¸€çš„ã€‚ç”¨æˆ·ä¸å¿…å…³å¿ƒç‰©ç†æ˜¾å­˜çš„ä½ç½®ã€æ¢é¡µæœºåˆ¶ç­‰ç­‰å…·ä½“ç»†èŠ‚ï¼Œè¿™äº›éƒ½æ˜¯ç”±Â <code>FrameBuffer</code>Â è®¾å¤‡é©±åŠ¨æ¥å®Œæˆçš„ã€‚ä½†Â <code>FrameBuffer</code>Â æœ¬èº«ä¸å…·å¤‡ä»»ä½•è¿ç®—æ•°æ®çš„èƒ½åŠ›ï¼Œå°±åªå¥½æ¯”æ˜¯ä¸€ä¸ªæš‚æ—¶å­˜æ”¾æ°´çš„æ°´æ± ã€‚Â <code>CPU</code>Â å°†è¿ç®—åçš„ç»“æœæ”¾åˆ°è¿™ä¸ªæ°´æ± , æ°´æ± å†å°†ç»“æœæµåˆ°æ˜¾ç¤ºå™¨ï¼Œä¸­é—´ä¸ä¼šå¯¹æ•°æ®åšå¤„ç†ã€‚åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ç›´æ¥è¯»å†™è¿™ä¸ªæ°´æ± çš„å†…å®¹åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œå°½ç®¡Â <code>FrameBuffer</code>Â éœ€è¦çœŸæ­£çš„æ˜¾å¡é©±åŠ¨çš„æ”¯æŒï¼Œä½†æ‰€æœ‰æ˜¾ç¤ºä»»åŠ¡éƒ½æœ‰Â <code>CPU</code>Â å®Œæˆï¼Œå› æ­¤Â <code>CPU</code>Â è´Ÿæ‹…å¾ˆé‡ã€‚</p>
<p>åœ¨å¼€å‘è€…çœ‹æ¥ï¼ŒÂ <code>FrameBuffer</code>Â æœ¬è´¨ä¸Šæ˜¯ä¸€å—æ˜¾ç¤ºç¼“å­˜ï¼Œå¾€æ˜¾ç¤ºç¼“å­˜ä¸­å†™å…¥ç‰¹å®šæ ¼å¼çš„æ•°æ®å°±æ„å‘³ç€å‘å±å¹•è¾“å‡ºå†…å®¹ã€‚æ‰€ä»¥è¯´Â <code>FrameBuffer</code>Â å°±æ˜¯ä¸€å—ç™½æ¿ã€‚ä¾‹å¦‚å¯¹äºåˆå§‹åŒ–ä¸º 16 ä½è‰²çš„Â <code>FrameBuffer</code>Â æ¥è¯´ï¼ŒÂ <code>FrameBuffer</code>Â ä¸­çš„ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨å±å¹•ä¸Šä¸€ä¸ªç‚¹ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦è‡³å³ï¼Œå±å¹•ä½ç½®ä¸å†…å­˜åœ°å€æ˜¯é¡ºåºçš„çº¿æ€§å…³ç³»ã€‚<br>å¸§ç¼“å­˜å¯ä»¥åœ¨ç³»ç»Ÿå­˜å‚¨å™¨ (å†…å­˜) çš„ä»»æ„ä½ç½®ï¼Œè§†é¢‘æ§åˆ¶å™¨é€šè¿‡è®¿é—®å¸§ç¼“å­˜æ¥åˆ·æ–°å±å¹•ã€‚å¸§ç¼“å­˜ä¹Ÿå«åˆ·æ–°ç¼“å­˜Â <code>FrameBuffer</code>Â æˆ–Â <code>RefreshBuffer</code>Â ï¼Œè¿™é‡Œçš„å¸§Â <code>Frame</code>Â æ˜¯æŒ‡æ•´ä¸ªå±å¹•èŒƒå›´ã€‚å¸§ç¼“å­˜æœ‰ä¸ªåœ°å€ï¼Œæ˜¯åœ¨å†…å­˜é‡Œã€‚æˆ‘ä»¬é€šè¿‡ä¸åœçš„å‘Â <code>FrameBuffer</code>Â ä¸­å†™å…¥æ•°æ®ï¼Œæ˜¾ç¤ºæ§åˆ¶å™¨å°±è‡ªåŠ¨çš„ä»Â <code>FrameBuffer</code>Â ä¸­å–æ•°æ®å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚å…¨éƒ¨çš„å›¾å½¢éƒ½å…±äº«å†…å­˜ä¸­åŒä¸€ä¸ªå¸§ç¼“å­˜ã€‚</p>
<p><code>FrameBuffer</code>Â å¸§ç¼“å†²å®é™…ä¸ŠåŒ…æ‹¬ä¸¤ä¸ªä¸åŒçš„æ–¹é¢ï¼š</p>
<ul>
<li><code>Frame</code>Â ï¼šå¸§ï¼Œå°±æ˜¯æŒ‡ä¸€å¹…å›¾åƒï¼Œåœ¨å±å¹•ä¸Šçœ‹åˆ°çš„é‚£å¹…å›¾åƒå°±æ˜¯ä¸€å¸§</li>
<li><code>Buffer</code>Â ï¼šç¼“å†²ï¼Œå°±æ˜¯ä¸€æ®µå­˜å‚¨åŒºåŸŸï¼Œå¯è¿™ä¸ªåŒºåŸŸå­˜å‚¨çš„æ˜¯å¸§</li>
</ul>
<p><code>FrameBuffer</code>Â å°±æ˜¯ä¸€ä¸ªå­˜å‚¨å›¾å½¢ &#x2F; å›¾åƒå¸§æ•°æ®çš„ç¼“å†²ã€‚<code>Linux</code>Â å†…æ ¸æä¾›äº†ç»Ÿä¸€çš„Â <code>Framebuffer</code>Â æ˜¾ç¤ºé©±åŠ¨ï¼Œè®¾å¤‡èŠ‚ç‚¹Â <code>/dev/graphics/fb*</code>Â æˆ–è€…Â <code>/dev/fb*</code>Â ï¼Œä»¥Â <code>fb0</code>Â è¡¨ç¤ºç¬¬ä¸€ä¸ªÂ <code>Monitor</code>Â ï¼Œå½“å‰å®ç°ä¸­åªç”¨åˆ°äº†ä¸€ä¸ªæ˜¾ç¤ºå±ã€‚è¿™ä¸ªè™šæ‹Ÿè®¾å¤‡å°†ä¸åŒç¡¬ä»¶å‚å•†å®ç°çš„çœŸå®è®¾å¤‡ç»Ÿä¸€åœ¨ä¸€ä¸ªæ¡†æ¶ä¸‹ï¼Œè¿™æ ·åº”ç”¨å±‚å°±å¯ä»¥é€šè¿‡æ ‡å‡†çš„æ¥å£è¿›è¡Œå›¾å½¢ &#x2F; å›¾åƒçš„è¾“å…¥å’Œè¾“å‡ºäº†ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-linux-framebuffer.png"></p>
<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨å±‚é€šè¿‡æ ‡å‡†çš„Â <code>ioctl, mmap</code>Â ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¯ä»¥æ“ä½œæ˜¾ç¤ºè®¾å¤‡ï¼Œç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚è¿™é‡ŒÂ <code>mmap</code>Â æŠŠè®¾å¤‡ä¸­çš„æ˜¾å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„ï¼Œåœ¨è¿™å—ç¼“å†²ä¸Šå†™æ•°æ®ï¼Œå°±ç›¸å½“äºåœ¨å±å¹•ä¸Šç»˜ç”»ã€‚</p>
<h3 id="Gralloc"><a href="#Gralloc" class="headerlink" title="Gralloc"></a><code>Gralloc</code></h3><p><code>Gralloc</code>Â çš„å«ä¹‰ä¸ºæ˜¯Â <code>Graphics Alloc</code>Â å›¾å½¢åˆ†é… ã€‚Â <code>Android</code>Â ç³»ç»Ÿåœ¨ç¡¬ä»¶æŠ½è±¡å±‚ä¸­æä¾›äº†ä¸€ä¸ªÂ <code>Gralloc</code>Â æ¨¡å—ï¼Œå°è£…äº†å¯¹Â <code>Framebuffer</code>Â çš„æ‰€æœ‰è®¿é—®æ“ä½œã€‚</p>
<p><code>Gralloc</code>Â æ¨¡å—ç¬¦åˆÂ <code>Android</code>Â æ ‡å‡†çš„Â <code>HAL</code>Â æ¶æ„è®¾è®¡ï¼›å®ƒåˆ†ä¸ºÂ <code>fb</code>Â å’ŒÂ <code>gralloc</code>Â ä¸¤ä¸ªè®¾å¤‡ï¼šå‰è€…è´Ÿè´£æ‰“å¼€å†…æ ¸ä¸­çš„Â <code>Framebuffer</code>Â ã€åˆå§‹åŒ–é…ç½®ï¼Œä»¥åŠæä¾›Â <code>post, setSwapInterval</code>Â ç­‰æ“ä½œï¼›åè€…åˆ™ç®¡ç†å¸§ç¼“å†²åŒºçš„åˆ†é…å’Œé‡Šæ”¾ã€‚ä¸Šå±‚åªèƒ½é€šè¿‡Â <code>Gralloc</code>Â è®¿é—®å¸§ç¼“å†²åŒºï¼Œè¿™æ ·ä¸€æ¥å°±å®ç°äº†æœ‰åºçš„å°è£…ä¿æŠ¤ã€‚</p>
<p><code>Gralloc</code>Â å›¾å½¢å†…å­˜åˆ†é…å™¨ï¼Œåˆ†é…å›¾åƒç”Ÿäº§è€…è¯·æ±‚çš„å†…å­˜ã€‚å®ƒä¸ä»…ä»…æ˜¯åœ¨åŸç”Ÿå †ä¸Šåˆ†é…å†…å­˜çš„å¦ä¸€ç§æ–¹æ³•ï¼›åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåˆ†é…çš„å†…å­˜å¯èƒ½å¹¶éç¼“å­˜ä¸€è‡´ï¼Œæˆ–è€…å¯èƒ½å®Œå…¨æ— æ³•ä»ç”¨æˆ·ç©ºé—´è®¿é—®ã€‚åˆ†é…çš„æ€§è´¨ç”±ç”¨æ³•æ ‡è®°ç¡®å®šï¼Œè¿™äº›æ ‡è®°åŒ…æ‹¬ä»¥ä¸‹å±æ€§ï¼š</p>
<ul>
<li>ä»è½¯ä»¶Â <code>CPU</code>Â è®¿é—®å†…å­˜çš„é¢‘ç‡</li>
<li>ä»ç¡¬ä»¶Â <code>GPU</code>Â è®¿é—®å†…å­˜çš„é¢‘ç‡</li>
<li>æ˜¯å¦å°†å†…å­˜ç”¨ä½œÂ <code>OpenGL ES: GLES</code>Â çº¹ç†</li>
<li>è§†é¢‘ç¼–ç å™¨æ˜¯å¦ä¼šä½¿ç”¨å†…å­˜</li>
</ul>
<p>ä¾‹å¦‚å¦‚æœæ ¼å¼æŒ‡å®šä¸ºÂ <code>RGBA 8888</code>Â åƒç´ ï¼Œå¹¶ä¸”æŒ‡æ˜å°†ä»è½¯ä»¶è®¿é—®ç¼“å†²åŒºï¼ˆè¿™æ„å‘³ç€åº”ç”¨å°†ç›´æ¥è§¦æ‘¸åƒç´ ï¼‰ï¼Œåˆ™åˆ†é…å™¨å¿…é¡»æŒ‰ç…§Â <code>R-G-B-A</code>Â çš„é¡ºåºä¸ºæ¯ä¸ªåƒç´ åˆ›å»º 4 ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºã€‚ç›¸åå¦‚æœæŒ‡æ˜ä»…ä»ç¡¬ä»¶è®¿é—®ç¼“å†²åŒºä¸”ç¼“å†²åŒºä½œä¸ºÂ <code>GLES</code>Â çº¹ç†ï¼Œåˆ™åˆ†é…å™¨å¯ä»¥æ‰§è¡ŒÂ <code>GLES</code>Â é©±åŠ¨ç¨‹åºæ‰€éœ€çš„ä»»ä½•æ“ä½œ -Â <code>BGRA</code>Â æ’åºã€éçº¿æ€§æ…å’Œå¸ƒå±€ã€æ›¿ä»£é¢œè‰²æ ¼å¼ç­‰ã€‚å…è®¸ç¡¬ä»¶ä½¿ç”¨å…¶é¦–é€‰æ ¼å¼å¯ä»¥æé«˜æ€§èƒ½ã€‚æŸäº›å€¼åœ¨ç‰¹å®šå¹³å°ä¸Šæ— æ³•ç»„åˆï¼Œä¾‹å¦‚è§†é¢‘ç¼–ç å™¨æ ‡è®°å¯èƒ½éœ€è¦Â <code>YUV</code>Â åƒç´ ï¼Œå› æ­¤å°†æ— æ³•æ·»åŠ è½¯ä»¶è®¿é—®æƒå¹¶æŒ‡å®šÂ <code>RGBA 8888</code>Â ã€‚</p>
<p><code>Gralloc</code>Â åˆ†é…å™¨è¿”å›çš„å¥æŸ„å¯ä»¥é€šè¿‡Â <code>Binder</code>Â åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ã€‚</p>
<h3 id="HWC"><a href="#HWC" class="headerlink" title="HWC"></a><code>HWC</code></h3><p><code>HWC: Hardware Composer</code>Â ç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨ï¼Œæ˜¾ç¤ºå­ç³»ç»Ÿçš„ç¡¬ä»¶æŠ½è±¡å®ç°ã€‚Â <code>SurfaceFlinger</code>Â å¯ä»¥å°†æŸäº›åˆæˆå·¥ä½œå§”æ‰˜ç»™Â <code>Hardware Composer</code>ï¼Œä»¥åˆ†æ‹…Â <code>OpenGL</code>Â å’ŒÂ <code>GPU</code>Â ä¸Šçš„å·¥ä½œé‡ã€‚Â <code>SurfaceFlinger</code>Â åªæ˜¯å……å½“å¦ä¸€ä¸ªÂ <code>OpenGL ES</code>Â å®¢æˆ·ç«¯ã€‚å› æ­¤åœ¨Â <code>SurfaceFlinger</code>Â å°†ä¸€ä¸ªæˆ–ä¸¤ä¸ªç¼“å†²åŒºåˆæˆåˆ°ç¬¬ä¸‰ä¸ªç¼“å†²åŒºä¸­çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä½¿ç”¨Â <code>OpenGL ES</code>Â ã€‚è¿™æ ·ä½¿åˆæˆçš„åŠŸè€—æ¯”é€šè¿‡Â <code>GPU</code>Â æ‰§è¡Œæ‰€æœ‰è®¡ç®—æ›´ä½ã€‚<br><code>Hardware Composer HAL</code>Â åˆ™è¿›è¡Œå¦ä¸€åŠçš„å·¥ä½œï¼Œå¹¶ä¸”æ˜¯æ‰€æœ‰Â <code>Android</code>Â å›¾å½¢æ¸²æŸ“çš„æ ¸å¿ƒã€‚Â <code>Hardware Composer</code>Â å¿…é¡»æ”¯æŒäº‹ä»¶ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯Â <code>VSYNC</code>ï¼ˆå¦ä¸€ä¸ªæ˜¯æ”¯æŒå³æ’å³ç”¨Â <code>HDMI</code>Â çš„çƒ­æ’æ‹”Â <code>hotplug</code>Â ï¼‰ã€‚</p>
<h3 id="VSYNC-å‚ç›´åˆ·æ–°"><a href="#VSYNC-å‚ç›´åˆ·æ–°" class="headerlink" title="VSYNC å‚ç›´åˆ·æ–°"></a>VSYNC å‚ç›´åˆ·æ–°</h3><p>å…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼š</p>
<p>æ˜¾å¡å¤„ç†å›¾åƒçš„å¸§é€Ÿç‡å’Œå±å¹•åˆ·æ–°é¢‘ç‡æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå½“ä¸¤è€…ä¸ä¸€è‡´æ—¶ä¼šå‡ºç°Â <code>tearing</code>Â é—®é¢˜ï¼Œä¸ºäº†è§£å†³ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¼•å…¥äº†Â <code>Vsync</code>Â ä¿¡å·ï¼šå½“æ•´ä¸ªå±å¹•åˆ·æ–°å®Œæ¯•ï¼Œå³ä¸€ä¸ªå‚ç›´åˆ·æ–°å‘¨æœŸå®Œæˆï¼Œä¼šæœ‰çŸ­æš‚çš„ç©ºç™½æœŸï¼Œç­‰å¾…å®šæœŸåŒæ­¥ä¿¡å·Â <code>VSync</code>Â ä¿¡å·ï¼Œæ”¶åˆ°åæ‰å¼€å§‹ä¸‹ä¸€æ¬¡å±å¹•åˆ·æ–°ï¼›æ‰€ä»¥Â <code>VSync</code>Â ä¸­çš„Â <code>V</code>Â æŒ‡çš„æ˜¯å‚ç›´åˆ·æ–°ä¸­çš„å‚ç›´Â <code>Vertical</code>Â ã€‚<br><code>Vsync</code>Â æŠ€æœ¯æ„å‘³ç€ï¼Œæ˜¾å¡æ˜¾ç¤ºæ€§èƒ½æé™è¢«é™åˆ¶åœ¨å±å¹•åˆ·æ–°ç‡ä»¥å†…äº†ï¼šåœ¨ç³»ç»Ÿæ˜¾å¡å¤„ç†çš„Â <code>FPS</code>Â é«˜äºå±å¹•åˆ·æ–°ç‡æ—¶ï¼Œæ˜¾å¡ä¼šå°†ä¸€éƒ¨åˆ†æ—¶é—´æµªè´¹åœ¨ç­‰å¾…ä¸Šï¼›å› ä¸ºæ²¡æœ‰å¯ç”¨çš„å†…å­˜ç”¨äºç»˜åˆ¶ï¼Œæ˜¾å¡éœ€è¦ç­‰å¾…Â <code>Vsync</code>Â ä¿¡å·æ‰èƒ½ç»˜åˆ¶ä¸‹ä¸€å¸§ã€‚</p>
<ul>
<li><p>å•ç¼“å­˜ç¼“å­˜æ¨¡å‹<br>  ç†æƒ³çš„æƒ…å†µæ˜¯å¸§ç‡å’Œåˆ·æ–°é¢‘ç‡ç›¸ç­‰ï¼Œæ¯ç»˜åˆ¶ä¸€å¸§ï¼Œå±å¹•æ˜¾ç¤ºä¸€å¸§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›ä½†æ˜¯å¦‚æœä¸ä¸€è‡´ï¼Œå°±ä¼šå‡ºç°Â <code>tearing</code>Â ã€‚</p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-vsync-single-buffer.png"></p>
</li>
<li><p>åŒé‡ç¼“å­˜Â <code>Double Buffer</code><br>  ä¸¤ä¸ªç¼“å­˜åŒºåˆ†åˆ«ä¸ºÂ <code>Back Buffer</code>Â å’ŒÂ <code>Frame Buffer</code>Â ã€‚Â <code>GPU</code>Â å‘Â <code>Back Buffer</code>Â ä¸­å†™æ•°æ®ï¼Œå±å¹•ä»Â <code>Frame Buffer</code>Â ä¸­è¯»æ•°æ®ã€‚å½“å±å¹•åˆ·æ–°å®Œæˆåäº§ç”ŸÂ <code>VSync</code>Â ä¿¡å·ï¼Œæ­¤æ—¶å°†æ•°æ®ä»Â <code>Back Buffer</code>Â å¤åˆ¶åˆ°Â <code>Frame Buffer</code>ï¼Œå¯è®¤ä¸ºè¯¥å¤åˆ¶æ“ä½œåœ¨ç¬é—´å®Œæˆï¼›å¤åˆ¶å®Œåæ˜¾ç¤ºè®¾å¤‡å¼€å§‹æ˜¾ç¤ºè¿™å¸§æ•°æ®ï¼ŒåŒæ—¶é€šçŸ¥Â <code>CPU/GPU</code>Â ç»˜åˆ¶ä¸‹ä¸€å¸§å›¾åƒã€‚</p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-vsync-double-buffer.png"></p>
<p>  ä½†æ˜¯å½“Â <code>GPU/CPU</code>Â ç»˜åˆ¶ä¸€å¸§çš„æ—¶é—´è¶…è¿‡äº†Â <code>Vsync</code>Â æ—¶ï¼Œå±å¹•åˆ·æ–°ä»Â <code>Frame Buffer</code>Â å–åˆ°çš„æ•°æ®ä»ç„¶æ˜¯ä¸Šä¸€å¸§æ•°æ®ï¼Œå³ä¸¤ä¸ªÂ <code>Vsync</code>Â å‘¨æœŸæ˜¾ç¤ºåŒä¸€å¸§æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¸ºå‘ç”Ÿäº†æ‰å¸§Â <code>Dropped Frame, Skipped Frame, Jank</code>Â ç°è±¡ã€‚  </p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-vsync-double-buffer-jank.png"></p>
</li>
<li><p>ä¸‰é‡ç¼“å­˜Â <code>Triple Buffer</code><br>  åœ¨åŒé‡ç¼“å­˜æ¨¡å‹ä¸­ï¼Œå½“Â <code>Jank</code>Â ç°è±¡å‡ºç°æ—¶ï¼ŒÂ <code>GPU/CPU</code>Â æ­¤æ—¶éƒ½å¤„äºé—²ç½®çŠ¶æ€ï¼Œæ‰€ä»¥å¼•å…¥äº†ä¸‰é‡ç¼“å­˜çš„æ¦‚å¿µï¼šåœ¨Â <code>Jank</code>Â æ—¶ï¼ŒÂ <code>GPU/CPU</code>Â åœ¨ç¬¬ä¸‰ä¸ªÂ <code>Buffer</code>Â ä¸­ç»˜åˆ¶æ•°æ®ï¼š  </p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-vsync-triple-buffer.png"></p>
<p>  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸‰ä¸ªç¼“å­˜å¹¶ä¸æ˜¯æ€»æ˜¯å­˜åœ¨çš„ï¼Œåªè¦å½“éœ€è¦çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼›è€Œä¸”ä¹Ÿæ— æ³•å®Œå…¨è§£å†³Â <code>Jank</code>Â ç°è±¡ï¼Œä½†æ˜¯èƒ½ç¼“è§£ã€‚  </p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-vsync-triple-buffer-jank.png"></p>
</li>
</ul>
<h3 id="60Hz-å’Œ-16-ms"><a href="#60Hz-å’Œ-16-ms" class="headerlink" title="60Hz å’Œ 16 ms"></a>60Hz å’Œ 16 ms</h3><p>ä»ä¸Šé¢è§£é‡Šå¸§é€Ÿç‡æ—¶æåˆ°ï¼Œè™½ç„¶äººçœ¼æ„ŸçŸ¥ç”Ÿç†çš„æé™Â <code>85fps</code>Â ï¼Œä½†è¾¾åˆ°Â <code>60fps</code>Â æ—¶åŠ¨ç”»å°±å·²ç»æœ‰å¾ˆå¥½çš„ä½“éªŒï¼Œä¸ä¼šå‡ºç°å¡é¡¿å’Œè¿Ÿæ»ç°è±¡ï¼›è€Œæœ€ä¸ºå…³é”®çš„æ˜¯Â <code>60Hz</code>Â æ˜¯ç¾å›½äº¤æµç”µçš„é¢‘ç‡ï¼Œå¦‚æœå±å¹•åˆ·æ–°é¢‘ç‡èƒ½å¤ŸåŒ¹é…äº¤æµç”µçš„é¢‘ç‡å°±å¯ä»¥æœ‰æ•ˆçš„é¢„é˜²å±å¹•ä¸­å‡ºç°æ»šåŠ¨æ¡ï¼›æ‰€ä»¥ï¼š</p>
<ul>
<li><code>60Hz</code>Â çš„å±å¹•åˆ·æ–°ç‡æˆ–è€…Â <code>60fps</code>Â çš„å¸§ç‡ï¼Œæ˜¯äººçœ¼èƒ½å¤Ÿæ„ŸçŸ¥åˆ°æ¯”è¾ƒæµç•…çš„æ•°å€¼</li>
<li><code>1000ms/60=16ms</code>Â ï¼ŒÂ <code>16ms</code>Â æ˜¯æŒ‡Â <code>GPU/CPU</code>Â åœ¨ç»˜åˆ¶å›¾å½¢æ—¶ï¼Œå¿…é¡»åœ¨è¿™ä¸ªåˆ·æ–°é¢‘ç‡å†…ç»˜åˆ¶å®Œæˆï¼Œå¦åˆ™ä¼šå‡ºç°ä¸¢å¸§ç°è±¡</li>
</ul>
<h3 id="BufferQueue"><a href="#BufferQueue" class="headerlink" title="BufferQueue"></a><code>BufferQueue</code></h3><p>å®ç°äº†æ•´ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚Â <code>BufferQueues</code>Â æ˜¯Â <code>Android</code>Â å›¾å½¢ç»„ä»¶ä¹‹é—´çš„ç²˜åˆå‰‚ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹é˜Ÿåˆ—ï¼Œå¯ä»¥è°ƒè§£ç¼“å†²åŒºä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„å›ºå®šå‘¨æœŸã€‚ä¸€æ—¦ç”Ÿäº§è€…ç§»äº¤å…¶ç¼“å†²åŒºï¼ŒÂ <code>SurfaceFlinger</code>Â ä¾¿ä¼šè´Ÿè´£å°†æ‰€æœ‰å†…å®¹åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚<br><code>BufferQueue</code>Â æ°¸è¿œä¸ä¼šå¤åˆ¶ç¼“å†²åŒºå†…å®¹ï¼ˆç§»åŠ¨å¦‚æ­¤å¤šçš„æ•°æ®æ˜¯éå¸¸ä½æ•ˆçš„æ“ä½œï¼‰ï¼›ç›¸å<strong>ç¼“å†²åŒºå§‹ç»ˆé€šè¿‡å¥æŸ„è¿›è¡Œä¼ é€’</strong>ã€‚</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-bufferqueue.png"></p>
<p><code>BufferQueue</code>Â åŒ…å«å°†å›¾åƒæµç”Ÿäº§è€…ä¸å›¾åƒæµæ¶ˆè´¹è€…ç»“åˆåœ¨ä¸€èµ·çš„é€»è¾‘ã€‚å›¾åƒç”Ÿäº§è€…çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬ç”±ç›¸æœºÂ <code>HAL</code>Â æˆ–Â <code>OpenGL ES</code>Â æ¸¸æˆç”Ÿæˆçš„ç›¸æœºé¢„è§ˆã€‚å›¾åƒæ¶ˆè´¹è€…çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬Â <code>SurfaceFlinger</code>Â æˆ–æ˜¾ç¤ºÂ <code>OpenGL ES</code>Â æµçš„å¦ä¸€ä¸ªåº”ç”¨ï¼Œå¦‚æ˜¾ç¤ºç›¸æœºå–æ™¯å™¨çš„ç›¸æœºåº”ç”¨ã€‚<br><code>BufferQueue</code>Â æ˜¯å°†ç¼“å†²åŒºæ± ä¸é˜Ÿåˆ—ç›¸ç»“åˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒä½¿ç”¨Â <code>Binder IPC</code>Â åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ç¼“å†²åŒºã€‚ç”Ÿäº§è€…æ¥å£ï¼Œæˆ–è€…æ‚¨ä¼ é€’ç»™æƒ³è¦ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºçš„æŸä¸ªäººçš„å†…å®¹ï¼Œå³æ˜¯Â <code>IGraphicBufferProducer</code>Â ï¼ˆÂ <code>SurfaceTexture</code>Â çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚Â <code>BufferQueue</code>Â é€šå¸¸ç”¨äºæ¸²æŸ“åˆ°Â <code>Surface</code>Â ï¼Œå¹¶ä¸”ä¸Â <code>GL</code>Â æ¶ˆè´¹è€…åŠå…¶ä»–ä»»åŠ¡ä¸€èµ·æ¶ˆè€—å†…å®¹ã€‚Â <code>BufferQueue</code>Â å¯ä»¥åœ¨ä¸‰ç§ä¸åŒçš„æ¨¡å¼ä¸‹è¿è¡Œï¼š</p>
<ul>
<li>ç±»åŒæ­¥æ¨¡å¼<br>  é»˜è®¤æƒ…å†µä¸‹ï¼ŒÂ <code>BufferQueue</code>Â åœ¨ç±»åŒæ­¥æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä»ç”Ÿäº§è€…è¿›å…¥çš„æ¯ä¸ªç¼“å†²åŒºéƒ½åœ¨æ¶ˆè´¹è€…é‚£é€€å‡ºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¸ä¼šèˆå¼ƒä»»ä½•ç¼“å†²åŒºã€‚å¦‚æœç”Ÿäº§è€…é€Ÿåº¦å¤ªå¿«ï¼Œåˆ›å»ºç¼“å†²åŒºçš„é€Ÿåº¦æ¯”æ¶ˆè€—ç¼“å†²åŒºçš„é€Ÿåº¦æ›´å¿«ï¼Œå®ƒå°†é˜»å¡å¹¶ç­‰å¾…å¯ç”¨çš„ç¼“å†²åŒºã€‚</li>
<li>éé˜»å¡æ¨¡å¼<br>  <code>BufferQueue</code>Â è¿˜å¯ä»¥åœ¨éé˜»å¡æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨æ­¤ç±»æƒ…å†µä¸‹ï¼Œå®ƒä¼šç”Ÿæˆé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰å¾…ç¼“å†²åŒºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¹Ÿä¸ä¼šèˆå¼ƒç¼“å†²åŒºã€‚è¿™æœ‰åŠ©äºé¿å…å¯èƒ½ä¸äº†è§£å›¾å½¢æ¡†æ¶çš„å¤æ‚ä¾èµ–é¡¹çš„åº”ç”¨è½¯ä»¶å‡ºç°æ½œåœ¨æ­»é”ç°è±¡ã€‚</li>
<li>èˆå¼ƒæ¨¡å¼<br>  <code>BufferQueue</code>Â å¯ä»¥é…ç½®ä¸ºä¸¢å¼ƒæ—§ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç”Ÿæˆé”™è¯¯æˆ–è¿›è¡Œç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¯¹çº¹ç†è§†å›¾æ‰§è¡ŒÂ <code>GL</code>Â æ¸²æŸ“å¹¶å°½å¿«ç»˜åˆ¶ï¼Œåˆ™å¿…é¡»ä¸¢å¼ƒç¼“å†²åŒºã€‚</li>
</ul>
<p>ä¸ºäº†æ‰§è¡Œè¿™é¡¹å·¥ä½œçš„å¤§éƒ¨åˆ†ç¯èŠ‚ï¼ŒÂ <code>SurfaceFlinger</code>Â å°±åƒå¦ä¸€ä¸ªÂ <code>OpenGL ES</code>Â å®¢æˆ·ç«¯ä¸€æ ·å·¥ä½œã€‚ä¾‹å¦‚å½“Â <code>SurfaceFlinger</code>Â æ­£åœ¨ç§¯æåœ°å°†ä¸€ä¸ªç¼“å†²åŒºæˆ–ä¸¤ä¸ªç¼“å†²åŒºåˆæˆåˆ°ç¬¬ä¸‰ä¸ªç¼“å†²åŒºä¸­æ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯Â <code>OpenGL ES</code>Â ã€‚</p>
<h3 id="æ•°æ®æµ"><a href="#æ•°æ®æµ" class="headerlink" title="æ•°æ®æµ"></a>æ•°æ®æµ</h3><p><code>Android</code>Â å›¾å½¢ç®¡é“æ•°æ®æµå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/01113-android-graphics-display-graphics_pipeline.png"></p>
<p>å·¦ä¾§çš„å¯¹è±¡æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºçš„æ¸²æŸ“å™¨ï¼Œå¦‚ä¸»å±å¹•ã€çŠ¶æ€æ å’Œç³»ç»Ÿç•Œé¢ã€‚Â <code>SurfaceFlinger</code>Â æ˜¯åˆæˆå™¨ï¼Œè€Œç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨æ˜¯åˆ¶ä½œå™¨ã€‚</p>
<h3 id="ç»„ä»¶å°ç»“"><a href="#ç»„ä»¶å°ç»“" class="headerlink" title="ç»„ä»¶å°ç»“"></a>ç»„ä»¶å°ç»“</h3><ul>
<li>ä½çº§åˆ«ç»„ä»¶<ul>
<li><code>BufferQueue</code>Â å’ŒÂ <code>gralloc</code>Â ã€‚Â <code>BufferQueue</code>Â å°†å¯ç”Ÿæˆå›¾å½¢æ•°æ®ç¼“å†²åŒºçš„ç»„ä»¶ï¼ˆç”Ÿäº§è€…ï¼‰è¿æ¥åˆ°æ¥å—æ•°æ®ä»¥ä¾¿è¿›è¡Œæ˜¾ç¤ºæˆ–è¿›ä¸€æ­¥å¤„ç†çš„ç»„ä»¶ï¼ˆæ¶ˆè´¹è€…ï¼‰ã€‚é€šè¿‡ä¾›åº”å•†ä¸“ç”¨Â <code>HAL</code>Â æ¥å£å®ç°çš„Â <code>gralloc</code>Â å†…å­˜åˆ†é…å™¨å°†ç”¨äºæ‰§è¡Œç¼“å†²åŒºåˆ†é…ä»»åŠ¡ã€‚</li>
<li><code>SurfaceFlinger, Hardware Composer</code>Â å’Œè™šæ‹Ÿæ˜¾ç¤ºå±ã€‚Â <code>SurfaceFlinger</code>Â æ¥å—æ¥è‡ªå¤šä¸ªæºçš„æ•°æ®ç¼“å†²åŒºï¼Œç„¶åå°†å®ƒä»¬è¿›è¡Œåˆæˆå¹¶å‘é€åˆ°æ˜¾ç¤ºå±ã€‚Â <code>Hardware Composer HAL (HWC)</code>Â ç¡®å®šä½¿ç”¨å¯ç”¨ç¡¬ä»¶åˆæˆç¼“å†²åŒºçš„æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œè™šæ‹Ÿæ˜¾ç¤ºå±ä½¿åˆæˆè¾“å‡ºå¯åœ¨ç³»ç»Ÿå†…ä½¿ç”¨ï¼ˆå½•åˆ¶å±å¹•æˆ–é€šè¿‡ç½‘ç»œå‘é€å±å¹•ï¼‰ã€‚</li>
<li><code>Surface, Canvas, SurfaceHolder</code>Â ã€‚Â <code>Surface</code>Â å¯ç”Ÿæˆä¸€ä¸ªé€šå¸¸ç”±Â <code>SurfaceFlinger</code>Â ä½¿ç”¨çš„ç¼“å†²åŒºé˜Ÿåˆ—ã€‚å½“æ¸²æŸ“åˆ°Â <code>Surface</code>Â ä¸Šæ—¶ï¼Œç»“æœæœ€ç»ˆå°†å‡ºç°åœ¨ä¼ é€ç»™æ¶ˆè´¹è€…çš„ç¼“å†²åŒºä¸­ã€‚Â <code>Canvas API</code>Â æä¾›ä¸€ç§è½¯ä»¶å®ç°æ–¹æ³•ï¼ˆæ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼‰ï¼Œç”¨äºç›´æ¥åœ¨Â <code>Surface</code>Â ä¸Šç»˜å›¾ï¼ˆÂ <code>OpenGL ES</code>Â çš„ä½çº§åˆ«æ›¿ä»£æ–¹æ¡ˆï¼‰ã€‚ä¸è§†å›¾æœ‰å…³çš„ä»»ä½•å†…å®¹å‡æ¶‰åŠåˆ°Â <code>SurfaceHolder</code>Â ï¼Œå…¶Â <code>API</code>Â å¯ç”¨äºè·å–å’Œè®¾ç½®Â <code>Surface</code>Â å‚æ•°ï¼ˆå¦‚å¤§å°å’Œæ ¼å¼ï¼‰ã€‚</li>
<li><code>EGLSurface, OpenGL ES</code>Â ã€‚Â <code>OpenGL ES (GLES)</code>Â å®šä¹‰äº†ç”¨äºä¸Â <code>EGL</code>Â ç»“åˆä½¿ç”¨çš„å›¾å½¢æ¸²æŸ“Â <code>API</code>Â ã€‚Â <code>EGI</code>Â æ˜¯ä¸€ä¸ªè§„å®šå¦‚ä½•é€šè¿‡æ“ä½œç³»ç»Ÿåˆ›å»ºå’Œè®¿é—®çª—å£çš„åº“ï¼ˆè¦ç»˜åˆ¶çº¹ç†å¤šè¾¹å½¢ï¼Œè¯·ä½¿ç”¨Â <code>GLES</code>Â è°ƒç”¨ï¼›è¦å°†æ¸²æŸ“æ”¾åˆ°å±å¹•ä¸Šï¼Œè¯·ä½¿ç”¨Â <code>EGL</code>Â è°ƒç”¨ï¼‰ã€‚Â <code>ANativeWindow</code>Â ï¼Œå®ƒæ˜¯Â <code>Java Surface</code>Â ç±»çš„Â <code>C/C++</code>Â ç­‰ä»·ç±»ï¼Œç”¨äºé€šè¿‡åŸç”Ÿä»£ç åˆ›å»ºÂ <code>EGL</code>Â çª—å£Â <code>Surface</code>Â ã€‚</li>
<li><code>Vulkan</code>Â ã€‚Â <code>Vulkan</code>Â æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½Â <code>3D</code>Â å›¾å½¢çš„ä½å¼€é”€ã€è·¨å¹³å°Â <code>API</code>Â ã€‚ä¸Â <code>OpenGL ES</code>Â ä¸€æ ·ï¼ŒÂ <code>Vulkan</code>Â æä¾›ç”¨äºåœ¨åº”ç”¨ä¸­åˆ›å»ºé«˜è´¨é‡å®æ—¶å›¾å½¢çš„å·¥å…·ã€‚Â <code>Vulkan</code>Â çš„ä¼˜åŠ¿åŒ…æ‹¬é™ä½Â <code>CPU</code>Â å¼€é”€ä»¥åŠæ”¯æŒÂ <code>SPIR-V</code>Â äºŒè¿›åˆ¶ä¸­é—´è¯­è¨€ã€‚</li>
</ul>
</li>
<li>é«˜çº§åˆ«ç»„ä»¶<ul>
<li><code>SurfaceView</code>Â å’ŒÂ <code>GLSurfaceView</code>Â ã€‚Â <code>SurfaceView</code>Â ç»“åˆäº†Â <code>Surface</code>Â å’ŒÂ <code>View</code>Â ã€‚Â <code>SurfaceView</code>Â çš„Â <code>View</code>Â ç»„ä»¶ç”±Â <code>SurfaceFlinger</code>Â ï¼ˆè€Œä¸æ˜¯åº”ç”¨ï¼‰åˆæˆï¼Œä»è€Œå¯ä»¥é€šè¿‡å•ç‹¬çš„çº¿ç¨‹ &#x2F; è¿›ç¨‹æ¸²æŸ“ï¼Œå¹¶ä¸åº”ç”¨ç•Œé¢æ¸²æŸ“éš”ç¦»ã€‚Â <code>GLSurfaceView</code>Â æä¾›å¸®åŠ©ç¨‹åºç±»æ¥ç®¡ç†Â <code>EGL</code>Â ä¸Šä¸‹æ–‡ã€çº¿ç¨‹é—´é€šä¿¡ä»¥åŠä¸Â <code>Activity</code>Â ç”Ÿå‘½å‘¨æœŸçš„äº¤äº’ï¼ˆä½†ä½¿ç”¨Â <code>GLES</code>Â æ—¶å¹¶ä¸éœ€è¦Â <code>GLSurfaceView</code>Â ï¼‰ã€‚</li>
<li><code>SurfaceTexture</code>Â ã€‚Â <code>SurfaceTexture</code>Â å°†Â <code>Surface</code>Â å’ŒÂ <code>GLES</code>Â çº¹ç†ç›¸ç»“åˆæ¥åˆ›å»ºÂ <code>BufferQueue</code>Â ï¼Œè€Œåº”ç”¨æ˜¯Â <code>BufferQueue</code>Â çš„æ¶ˆè´¹è€…ã€‚å½“ç”Ÿäº§è€…å°†æ–°çš„ç¼“å†²åŒºæ’å…¥é˜Ÿåˆ—æ—¶ï¼Œå®ƒä¼šé€šçŸ¥åº”ç”¨ã€‚åº”ç”¨ä¼šä¾æ¬¡é‡Šæ”¾å…ˆå‰å æœ‰çš„ç¼“å†²åŒºï¼Œä»é˜Ÿåˆ—ä¸­è·å–æ–°ç¼“å†²åŒºå¹¶æ‰§è¡ŒÂ <code>EGL</code>Â è°ƒç”¨ï¼Œä»è€Œä½¿Â <code>GLES</code>Â å¯å°†æ­¤ç¼“å†²åŒºä½œä¸ºå¤–éƒ¨çº¹ç†ä½¿ç”¨ã€‚Â <code>Android 7.0</code>Â å¢åŠ äº†å¯¹å®‰å…¨çº¹ç†è§†é¢‘æ’­æ”¾çš„æ”¯æŒï¼Œä»¥ä¾¿ç”¨æˆ·èƒ½å¤Ÿå¯¹å—ä¿æŠ¤çš„è§†é¢‘å†…å®¹è¿›è¡ŒÂ <code>GPU</code>Â åå¤„ç†ã€‚</li>
<li><code>TextureView</code>Â ã€‚Â <code>TextureView</code>Â ç»“åˆäº†Â <code>View</code>Â å’ŒÂ <code>SurfaceTexture</code>Â ã€‚Â <code>TextureView</code>Â å¯¹Â <code>SurfaceTexture</code>Â è¿›è¡ŒåŒ…è£…ï¼Œå¹¶è´Ÿè´£å“åº”å›è°ƒä»¥åŠè·å–æ–°çš„ç¼“å†²åŒºã€‚åœ¨ç»˜å›¾æ—¶ï¼ŒÂ <code>TextureView</code>Â ä½¿ç”¨æœ€è¿‘æ”¶åˆ°çš„ç¼“å†²åŒºçš„å†…å®¹ä½œä¸ºå…¶æ•°æ®æºï¼Œæ ¹æ®Â <code>View</code>Â çŠ¶æ€æŒ‡ç¤ºï¼Œåœ¨å®ƒåº”è¯¥æ¸²æŸ“çš„ä»»ä½•ä½ç½®å’Œä»¥å®ƒåº”è¯¥é‡‡ç”¨çš„ä»»ä½•æ¸²æŸ“æ–¹å¼è¿›è¡Œæ¸²æŸ“ã€‚Â <code>View</code>Â åˆæˆå§‹ç»ˆé€šè¿‡Â <code>GLES</code>Â æ¥æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å†…å®¹æ›´æ–°å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–Â <code>View</code>Â å…ƒç´ é‡ç»˜ã€‚</li>
</ul>
</li>
</ul>
<p>é«˜çº§åˆ«ç»„ä»¶å¯ä»¥ç›´æ¥åœ¨Â <code>APP</code>Â ä¸­ä½¿ç”¨ã€‚</p>
<h2 id="Buffer-Window-ä½“ç³»"><a href="#Buffer-Window-ä½“ç³»" class="headerlink" title="Buffer/WindowÂ ä½“ç³»"></a><code>Buffer/Window</code>Â ä½“ç³»</h2><h3 id="ä»£ç é€ŸæŸ¥è¡¨"><a href="#ä»£ç é€ŸæŸ¥è¡¨" class="headerlink" title="ä»£ç é€ŸæŸ¥è¡¨"></a>ä»£ç é€ŸæŸ¥è¡¨</h3><p>system&#x2F;core&#x2F;libcutils&#x2F;include&#x2F;cutils&#x2F;native_handle.h<br>hardware&#x2F;qcom&#x2F;display&#x2F;libgralloc&#x2F;gralloc_priv.h<br>frameworks&#x2F;native&#x2F;libs&#x2F;nativebase&#x2F;include&#x2F;nativebase&#x2F;nativebase.h<br>frameworks&#x2F;native&#x2F;libs&#x2F;nativewindow&#x2F;include&#x2F;system&#x2F;window.h<br>frameworks&#x2F;native&#x2F;libs&#x2F;ui&#x2F;include&#x2F;ui&#x2F;ANativeObjectBase.h<br>frameworks&#x2F;native&#x2F;libs&#x2F;ui&#x2F;include&#x2F;ui&#x2F;GraphicBuffer.h<br>frameworks&#x2F;native&#x2F;libs&#x2F;gui&#x2F;include&#x2F;gui&#x2F;Surface.h</p>
<h3 id="native-handle-buffer-handle-t"><a href="#native-handle-buffer-handle-t" class="headerlink" title="native_handle/buffer_handle_t"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#native-handle-buffer-handle-t" title="native_handle/buffer_handle_t"></a><code>native_handle/buffer_handle_t</code></h3><p>å…ˆçœ‹Â <code>native_handle</code>Â è¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; native_handle.h<br>typedef struct native_handle<br>{<br>    int version;        &#x2F;* sizeof(native_handle_t) <em>&#x2F;<br>    int numFds;         &#x2F;</em> number of file-descriptors at &amp;data[0] <em>&#x2F;<br>    int numInts;        &#x2F;</em> number of ints at &amp;data[numFds] <em>&#x2F;<br>#if defined(<strong>clang</strong>)<br>#pragma clang diagnostic push<br>#pragma clang diagnostic ignored â€œ-Wzero-length-arrayâ€<br>#endif<br>    int data[0];        &#x2F;</em> numFds + numInts ints *&#x2F;<br>#if defined(<strong>clang</strong>)<br>#pragma clang diagnostic pop<br>#endif<br>} native_handle_t;</p>
<p>typedef const native_handle_t* buffer_handle_t;</p>
<p><code>native_handle</code>Â è¿™ä¸ªç»“æ„ä½“ï¼Œæè¿°äº†ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯Â <code>data[0]</code>Â ï¼Œå®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 0 çš„æ•°ç»„ï¼Œå³Â <code>native_handle</code>Â æ˜¯ä¸€ä¸ªæŸ”æ€§æ•°ç»„ã€‚åœ¨æ ‡å‡†çš„Â <code>C/C++</code>Â ä¸­, é•¿åº¦ä¸º 0 çš„æ•°ç»„æ˜¯ä¸è¢«å…è®¸çš„ï¼Œç¼–è¯‘æ—¶ä¼šäº§ç”Ÿé”™è¯¯ï¼é•¿åº¦ä¸º 0 çš„æ•°ç»„æ˜¯Â <code>C/C++</code>Â çš„æ‰©å±•ï¼Œéœ€è¦å½“å‰ç¼–è¯‘å™¨æ”¯æŒè¿™ä¸ªæ‰©å±•ã€‚ä»å¤´æ–‡ä»¶æ³¨é‡Šä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå½“ä½¿ç”¨çš„æ˜¯Â <code>clang</code>Â ç¼–è¯‘å™¨æ—¶ï¼Œæ‰ä¼šå®šä¹‰Â <code>data[0]</code>Â å¹¶ä¸”å¿½ç•¥æ•°ç»„ä¸º 0 çš„è­¦å‘Šã€‚</p>
<p>ä»Â <code>C/C++</code>Â ä¸­æŸ”æ€§æ•°ç»„çš„ç”¨é€”æ¥çœ‹ï¼ŒÂ <code>native_handle</code>Â è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªä¸å®šé•¿æ•°æ®ç»“æ„ï¼Œå®é™…æ„ä¹‰æŒ‡å‘è¿ç»­åˆ†é…çš„å†…å­˜ç©ºé—´ï¼ˆé™¤äº†Â <code>native_handle</code>Â ä¹‹å¤–ï¼‰ä»£è¡¨çš„æ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯Â <code>private_handle_t</code>Â ï¼‰ã€‚è¿™é‡Œè¿™ä¹ˆåšï¼Œæ˜¯å› ä¸ºæ˜¾ç¤ºç³»ç»Ÿå’Œæ¯å®¶å®ç°å¹³å°ç›¸å…³åº¦å¾ˆé«˜ï¼ŒÂ <code>native_handle</code>Â å®šä¹‰ä¸€ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„ï¼Œè‡³äºæ˜¾ç¤ºç³»ç»Ÿå¦‚ä½•æ˜¾ç¤ºï¼Œæ¯å®¶è‡ªå·±å»å®ç°å¯¹åº”çš„Â <code>private_handle_t</code>Â ã€‚</p>
<p><code>native_handle</code>Â ç»“æ„ä½“ä¸­çš„æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼ŒÂ <code>numFds</code>Â è¡¨ç¤ºè¢«æŒ‡å‘æ•°æ®ç»“æ„åŒ…å«å‡ ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼›Â <code>numInts</code>Â è¡¨ç¤ºè¢«æŒ‡å‘æ•°æ®ç»“æ„é•¿åº¦æ˜¯å¤šå°‘ä¸ªæ•´å‹ï¼›æœ‰äº†è¿™ä¸¤ä¸ªä¿¡æ¯åï¼Œå†…å­˜åˆ†é…å°±å¾ˆå®¹æ˜“äº†ï¼Œå‚è€ƒÂ <code>native_handle_create</code>Â çš„æºç å®ç°ï¼š</p>
<p>&#x2F;&#x2F; native_handle.c<br>native_handle_t* native_handle_create(int numFds, int numInts) {<br>    if (numFds &lt; 0 || numInts &lt; 0 || numFds &gt; kMaxNativeFds<br>            || numInts &gt; kMaxNativeInts) {<br>        errno &#x3D; EINVAL;<br>        return NULL;<br>    }</p>
<pre><code>// ç»™ native_handle åˆ†é…è¿ç»­çš„å†…å­˜ç©ºé—´
// é™¤äº† native_handle è‡ªèº«æ‰€å ç©ºé—´ï¼Œè¿˜åŒ…å«è¢«æŒ‡å‘æ•°æ®ç»“æ„çš„é•¿åº¦  
size_t mallocSize = sizeof(native_handle_t) 
    + (sizeof(int) * (numFds + numInts));
native_handle_t* h = malloc(mallocSize);
if (h) &#123;
    h-&gt;version = sizeof(native_handle_t);
    h-&gt;numFds = numFds;
    h-&gt;numInts = numInts;
&#125;
return h;
</code></pre>
<p>}</p>
<p>å°ç»“ï¼šÂ <code>native_handle, native_handle_t</code>Â è¡¨ç¤ºä¸€ä¸ªä¸å®šé•¿æ•°æ®ç»“æ„ï¼Œè€ŒÂ <code>buffer_handle_t</code>Â è¡¨ç¤ºæŒ‡å‘Â <code>native_handle</code>Â çš„æŒ‡é’ˆã€‚</p>
<h3 id="private-handle-t"><a href="#private-handle-t" class="headerlink" title="private_handle_t"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#private-handle-t" title="private_handle_t"></a><code>private_handle_t</code></h3><p><code>private_handle_t</code>Â æè¿°çš„æ˜¯ä¸€å—ç¼“å­˜ï¼Œå› ä¸ºå’Œå®ç°å¹³å°é«˜åº¦ç›¸å…³ï¼Œæˆ‘è¿™é‡Œé€‰å–é«˜é€šå¹³å°ï¼Œå…ˆçœ‹å¤´æ–‡ä»¶å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; gralloc_priv.h<br>#ifdef __cplusplus<br>struct private_handle_t : public native_handle {<br>#else<br>    struct private_handle_t {<br>        native_handle_t nativeHandle;<br>#endif<br>        enum {<br>            PRIV_FLAGS_FRAMEBUFFER        &#x3D; 0x00000001,<br>            â€¦<br>        };</p>
<pre><code>    // file-descriptors
    int     fd;
    int     fd_metadata;          // fd for the meta-data
    // ints
    int     magic;
    int     flags;
    unsigned int  size;
    unsigned int  offset;
    int     bufferType;
    uint64_t base __attribute__((aligned(8)));
    unsigned int  offset_metadata;
    // The gpu address mapped into the mmu.
    uint64_t gpuaddr __attribute__((aligned(8)));
    int     format;
    int     width;   // holds aligned width of the actual buffer allocated
    int     height;  // holds aligned height of the  actual buffer allocated
    uint64_t base_metadata __attribute__((aligned(8)));
    int unaligned_width;   // holds width client asked to allocate
    int unaligned_height;  // holds height client asked to allocate
</code></pre>
<p>#ifdef __cplusplus<br>        static const int sNumFds &#x3D; 2;<br>        static inline int sNumInts() {<br>            return ((sizeof(private_handle_t) - sizeof(native_handle_t)) &#x2F;<br>                    sizeof(int)) - sNumFds;<br>        }<br>        static const int sMagic &#x3D; â€˜gmsmâ€™;<br>        â€¦<br>}</p>
<p><code>private_handle_t</code>Â æè¿°äº†ç¼“å­˜åŒºä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦Â <code>fd, fd_metadata</code>Â ã€å¤§å°ã€åç§»é‡ã€åŸºåœ°å€ã€é•¿å®½ã€æ ¼å¼ã€æ²¡æœ‰å¯¹é½çš„é•¿å®½ç­‰ç­‰ï¼Œè€ŒÂ <code>sNumFds</code>Â å¯¹åº”Â <code>nativeHandle.numFds</code>Â ï¼›Â <code>sNumInts</code>Â å¯¹åº”Â <code>nativeHandle.numInts</code>Â ï¼Œå³é™¤äº†æ–‡ä»¶æè¿°ç¬¦ä¹‹å¤–ï¼Œè¯¥æ•°æ®ç»“æ„çš„é•¿åº¦ã€‚<br>å°ç»“ï¼šÂ <code>private_handle_t</code>Â åœ¨å„ä¸ªæ¨¡å—ä¹‹é—´ä¼ é€’çš„æ—¶å€™å¾ˆä¸æ–¹ä¾¿ï¼Œè€Œå¦‚æœç”¨Â <code>native_handle</code>Â çš„æ¥ä¼ é€’ï¼Œå°±å¯ä»¥æ¶ˆé™¤å¹³å°çš„å·®å¼‚æ€§ã€‚ä¸€ä¸ªç®€å•ç¤ºæ„å›¾æè¿°ä¸¤è€…çš„å…³ç³»ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-5-hal-buffer_handle_t.png"></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ç†è§£ä¸ºÂ <code>native_handle, native_handle_t, private_handle_t, buffer_handle_t</code>Â è¡¨ç¤ºçš„æ˜¯åŒä¸€å—å†…å­˜ã€‚</p>
<h3 id="ANativeWindowBuffer"><a href="#ANativeWindowBuffer" class="headerlink" title="ANativeWindowBuffer"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#ANativeWindowBuffer" title="ANativeWindowBuffer"></a><code>ANativeWindowBuffer</code></h3><p>å…ˆäº†è§£Â <code>android_native_base_t</code>Â æ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p>
<p>typedef struct android_native_base_t<br>{<br>    &#x2F;* a magic value defined by the actual EGL native type *&#x2F;<br>    int magic;</p>
<pre><code>/* the sizeof() of the actual EGL native type */
int version;

void* reserved[4];

/* reference-counting interface */
void (*incRef)(struct android_native_base_t* base);
void (*decRef)(struct android_native_base_t* base);
</code></pre>
<p>} android_native_base_t;</p>
<p><code>android_native_base_t</code>Â ä¸­Â <code>incRef/decRef</code>Â ä¸»è¦åŠŸèƒ½æ˜¯ï¼šä¸ºäº†æŠŠæ´¾ç”Ÿç±»å’ŒÂ <code>Android</code>Â æ‰€æœ‰Â <code>class</code>Â çš„è€ç¥–å®—Â <code>RefBase</code>Â è”ç³»èµ·æ¥æ‰€é¢„ç•™çš„å‡½æ•°æŒ‡é’ˆã€‚</p>
<p>å†çœ‹Â <code>ANativeWindowBuffer</code>Â æ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; nativebase.h<br>typedef struct ANativeWindowBuffer<br>{<br>#ifdef __cplusplus<br>    ANativeWindowBuffer() {<br>        common.magic &#x3D; ANDROID_NATIVE_BUFFER_MAGIC;<br>        common.version &#x3D; sizeof(ANativeWindowBuffer);<br>        memset(common.reserved, 0, sizeof(common.reserved));<br>    }</p>
<pre><code>// Implement the methods that sp&lt;ANativeWindowBuffer&gt; expects so that it
// can be used to automatically refcount ANativeWindowBuffer&#39;s.
void incStrong(const void* /*id*/) const &#123;
    common.incRef(const_cast&lt;android_native_base_t*&gt;(&amp;common));
&#125;
void decStrong(const void* /*id*/) const &#123;
    common.decRef(const_cast&lt;android_native_base_t*&gt;(&amp;common));
&#125;
</code></pre>
<p>#endif</p>
<pre><code>struct android_native_base_t common;

int width;
int height;
int stride;
int format;
int usage_deprecated;
uintptr_t layerCount;

void* reserved[1];

const native_handle_t* handle;
uint64_t usage;

// we needed extra space for storing the 64-bits usage flags
// the number of slots to use from reserved_proc depends on the
// architecture.
void* reserved_proc[8 - (sizeof(uint64_t) / sizeof(void*))];
</code></pre>
<p>} ANativeWindowBuffer_t;</p>
<p>typedef struct ANativeWindowBuffer ANativeWindowBuffer;</p>
<p>&#x2F;&#x2F; Old typedef for backwards compatibility.<br>typedef ANativeWindowBuffer_t android_native_buffer_t;</p>
<p><code>ANativeWindowBuffer</code>Â ä¸­ä½¿ç”¨äº†Â <code>native_handle_t</code>Â æŒ‡é’ˆï¼ŒåŒæ—¶è¯¥ç»“æ„ä½“ä¸­ä¹Ÿæœ‰é•¿å®½ã€æ ¼å¼ã€æ­¥è¿›ç­‰åŸºæœ¬æè¿°ä¿¡æ¯ï¼›ä¹Ÿå°±æ˜¯Â <code>ANativeWindowBuffer</code>Â æè¿°çš„æ˜¯ä¸€å—Â <code>Window</code>Â ç›¸å…³çš„ç¼“å­˜åŒºã€‚</p>
<h3 id="ANativeWindow"><a href="#ANativeWindow" class="headerlink" title="ANativeWindow"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#ANativeWindow" title="ANativeWindow"></a><code>ANativeWindow</code></h3><p><code>ANativeWindow</code>Â æ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; window.h<br>struct ANativeWindow<br>{<br>#ifdef __cplusplus<br>    ANativeWindow()<br>        : flags(0), minSwapInterval(0), maxSwapInterval(0), xdpi(0), ydpi(0)<br>    {<br>        common.magic &#x3D; ANDROID_NATIVE_WINDOW_MAGIC;<br>        common.version &#x3D; sizeof(ANativeWindow);<br>        memset(common.reserved, 0, sizeof(common.reserved));<br>    }</p>
<pre><code>/* Implement the methods that sp&lt;ANativeWindow&gt; expects so that it
   can be used to automatically refcount ANativeWindow&#39;s. */
void incStrong(const void* /*id*/) const &#123;
    common.incRef(const_cast&lt;android_native_base_t*&gt;(&amp;common));
&#125;
void decStrong(const void* /*id*/) const &#123;
    common.decRef(const_cast&lt;android_native_base_t*&gt;(&amp;common));
&#125;
</code></pre>
<p>#endif</p>
<pre><code>struct android_native_base_t common;

/* flags describing some attributes of this surface or its updater */
const uint32_t flags;

/* min swap interval supported by this updated */
const int   minSwapInterval;

/* max swap interval supported by this updated */
const int   maxSwapInterval;

/* horizontal and vertical resolution in DPI */
const float xdpi;
const float ydpi;

/* Some storage reserved for the OEM&#39;s driver. */
intptr_t    oem[4];

int     (*setSwapInterval)(struct ANativeWindow* window,
            int interval);
int     (*dequeueBuffer_DEPRECATED)(struct ANativeWindow* window,
            struct ANativeWindowBuffer** buffer);
int     (*lockBuffer_DEPRECATED)(struct ANativeWindow* window,
            struct ANativeWindowBuffer* buffer);
int     (*queueBuffer_DEPRECATED)(struct ANativeWindow* window,
            struct ANativeWindowBuffer* buffer);
int     (*query)(const struct ANativeWindow* window,
            int what, int* value);
int     (*perform)(struct ANativeWindow* window,
            int operation, ... );
int     (*cancelBuffer_DEPRECATED)(struct ANativeWindow* window,
            struct ANativeWindowBuffer* buffer);
int     (*dequeueBuffer)(struct ANativeWindow* window,
            struct ANativeWindowBuffer** buffer, int* fenceFd);
int     (*queueBuffer)(struct ANativeWindow* window,
            struct ANativeWindowBuffer* buffer, int fenceFd);
int     (*cancelBuffer)(struct ANativeWindow* window,
            struct ANativeWindowBuffer* buffer, int fenceFd);
</code></pre>
<p>};</p>
<p> &#x2F;* Backwards compatibility: use ANativeWindow (struct ANativeWindow in C).</p>
<ul>
<li>android_native_window_t is deprecated.<br>  *&#x2F;<br>typedef struct ANativeWindow android_native_window_t __deprecated;</li>
</ul>
<p>ä»æ•°æ®ç»“æ„å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼ŒÂ <code>ANativeWindow</code>Â å’Œçª—å£å±æ€§ç›¸å…³ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªåº•å±‚å®ç°çš„çª—å£ï¼Œå®šä¹‰çš„å„ç§å‡½æ•°æŒ‡é’ˆéƒ½æ˜¯å¯¹Â <code>ANativeWindowBuffer</code>Â å†…å­˜çš„æ“ä½œï¼›è€ŒÂ <code>fenceFd</code>Â å¯ä»¥çœ‹æˆè¿™ä¸ªÂ <code>buffer</code>Â çš„é”ã€‚</p>
<p>å°ç»“ï¼šä¸ç®¡æ˜¯Â <code>ANativeWindow, ANativeWindowBuffer</code>Â å®ƒä»¬éƒ½åŒ…å«Â <code>android_native_base_t</code>Â ç»“æ„ä½“ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰å¯¹Â <code>incRef, decRef</code>Â èµ‹å€¼ï¼›å¯ä»¥è®¤ä¸ºÂ <code>ANativeWindow, ANativeWindowBuffer</code>Â ä¸ºæŠ½è±¡æ•°æ®ç»“æ„ã€‚</p>
<h3 id="ANativeObjectBase-æ¨¡æ¿"><a href="#ANativeObjectBase-æ¨¡æ¿" class="headerlink" title="ANativeObjectBaseÂ æ¨¡æ¿"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#ANativeObjectBase-%E6%A8%A1%E6%9D%BF" title="ANativeObjectBase æ¨¡æ¿"></a><code>ANativeObjectBase</code>Â æ¨¡æ¿</h3><p><code>ANativeObjectBase</code>Â æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>&#x2F;&#x2F; ANativeObjectBase.h<br>template &lt;typename NATIVE_TYPE, typename TYPE, typename REF,<br>        typename NATIVE_BASE &#x3D; android_native_base_t&gt;<br>class ANativeObjectBase : public NATIVE_TYPE, public REF<br>{<br>public:<br>    &#x2F;&#x2F; Disambiguate between the incStrong in REF and NATIVE_TYPE<br>    void incStrong(const void* id) const {<br>        REF::incStrong(id);<br>    }<br>    void decStrong(const void* id) const {<br>        REF::decStrong(id);<br>    }</p>
<p>protected:<br>    typedef ANativeObjectBase&lt;NATIVE_TYPE, TYPE, REF, NATIVE_BASE&gt; BASE;<br>    ANativeObjectBase() : NATIVE_TYPE(), REF() {<br>        NATIVE_TYPE::common.incRef &#x3D; incRef;<br>        NATIVE_TYPE::common.decRef &#x3D; decRef;<br>    }<br>    static inline TYPE* getSelf(NATIVE_TYPE* self) {<br>        return static_cast&lt;TYPE*&gt;(self);<br>    }<br>    static inline TYPE const* getSelf(NATIVE_TYPE const* self) {<br>        return static_cast&lt;TYPE const <em>&gt;(self);<br>    }<br>    static inline TYPE</em> getSelf(NATIVE_BASE* base) {<br>        return getSelf(reinterpret_cast&lt;NATIVE_TYPE*&gt;(base));<br>    }<br>    static inline TYPE const * getSelf(NATIVE_BASE const* base) {<br>        return getSelf(reinterpret_cast&lt;NATIVE_TYPE const*&gt;(base));<br>    }<br>    static void incRef(NATIVE_BASE* base) {<br>        ANativeObjectBase* self &#x3D; getSelf(base);<br>        self-&gt;incStrong(self);<br>    }<br>    static void decRef(NATIVE_BASE* base) {<br>        ANativeObjectBase* self &#x3D; getSelf(base);<br>        self-&gt;decStrong(self);<br>    }<br>};</p>
<p>} &#x2F;&#x2F; namespace android<br>#endif &#x2F;&#x2F; __cplusplus</p>
<p><code>ANativeObjectBase</code>Â æ¨¡æ¿ç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯å®ç°Â <code>incRef, decRef</code>Â å¼•ç”¨è®¡æ•°ï¼Œä»¥åŠçˆ¶ç±»å­ç±»çš„ç±»å‹è½¬æ¢ã€‚</p>
<h3 id="GraphicBuffer"><a href="#GraphicBuffer" class="headerlink" title="GraphicBuffer"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#GraphicBuffer" title="GraphicBuffer"></a><code>GraphicBuffer</code></h3><p>å…ˆçœ‹Â <code>GraphicBuffer</code>Â çš„å¤´æ–‡ä»¶å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; GraphicBuffer.h<br>class GraphicBuffer<br>    : public ANativeObjectBase&lt;ANativeWindowBuffer, GraphicBuffer, RefBase&gt;,<br>      public Flattenable<GraphicBuffer><br>{â€¦}</p>
<p><code>GraphicBuffer</code>Â ä½¿ç”¨Â <code>ANativeObjectBase</code>Â æ¨¡æ¿ï¼Œå³Â <code>GraphicBuffer</code>Â å°±æ˜¯Â <code>ANativeWindowBuffer</code>Â çš„ä¸€ç§å…·ä½“å®ç°ï¼›è€ŒÂ <code>ANativeWindowBuffer.common</code>Â æˆå‘˜çš„ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆÂ <code>incRef, decRef</code>Â æŒ‡å‘äº†Â <code>GraphicBuffer</code>Â çš„å¦ä¸€ä¸ªåŸºç±»Â <code>RefBase</code>Â çš„Â <code>incStrong, decStrong</code>Â ï¼›è€ŒÂ <code>ANativeWindowBuffer</code>Â å¯ä»¥çœ‹åšæ˜¯æŠŠÂ <code>buffer_handle_t</code>Â åŒ…äº†ä¸€å±‚ï¼Œæ‰€ä»¥Â <code>GraphicBuffer</code>Â ä¹Ÿæ˜¯æŒ‡å‘çš„ä¸€å—ç¼“å­˜åŒºã€‚</p>
<h3 id="Surface"><a href="#Surface" class="headerlink" title="Surface"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#Surface" title="Surface"></a><code>Surface</code></h3><p><code>Surface</code>Â çš„å¤´æ–‡ä»¶å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; Surface.h<br>class Surface<br>    : public ANativeObjectBase&lt;ANativeWindow, Surface, RefBase&gt;<br>{<br>    â€¦<br>protected:<br>    â€¦<br>    struct BufferSlot {<br>        sp<GraphicBuffer> buffer;<br>        Region dirtyRegion;<br>    };<br>    BufferSlot mSlots[NUM_BUFFER_SLOTS];<br>    â€¦<br>}</p>
<p><code>Surface</code>Â ä¹Ÿä½¿ç”¨äº†Â <code>ANativeObjectBase</code>Â æ¨¡æ¿ï¼Œå³Â <code>Surface</code>Â å°±æ˜¯Â <code>ANativeWindow</code>Â çš„ä¸€ç§å…·ä½“å®ç°ï¼ŒåŒæ ·ä¹Ÿç»§æ‰¿äº†Â <code>RefBase</code>Â å®ç°å¼•ç”¨è®¡æ•°ã€‚å¦å¤–æˆå‘˜æ•°æ®ç»“æ„Â <code>BufferSlot</code>Â æ˜¯å¯¹Â <code>GraphicBuffer</code>Â çš„åŒ…è£…ï¼Œè€ŒÂ <code>mSlots</code>Â æ•°ç»„è¡¨ç¤ºæ¯ä¸ªÂ <code>Surface</code>Â ä¸­åŒ…å«Â <code>NUM_BUFFER_SLOTS</code>Â ä¸ªÂ <code>GraphicBuffer</code>Â ç¼“å­˜ã€‚<br>è€ŒÂ <code>Surface</code>Â çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¹Ÿå°†Â <code>ANativeWindow</code>Â çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œäº†èµ‹å€¼ï¼š</p>
<p>&#x2F;&#x2F; Surface.cpp<br>Surface::Surface(const sp<IGraphicBufferProducer>&amp; bufferProducer,<br>    bool controlledByApp)<br>      : mGraphicBufferProducer(bufferProducer),<br>        mCrop(Rect::EMPTY_RECT),<br>        mBufferAge(0),<br>        mGenerationNumber(0),<br>        mSharedBufferMode(false),<br>        mAutoRefresh(false),<br>        mSharedBufferSlot(BufferItem::INVALID_BUFFER_SLOT),<br>        mSharedBufferHasBeenQueued(false),<br>        mQueriedSupportedTimestamps(false),<br>        mFrameTimestampsSupportsPresent(false),<br>        mEnableFrameTimestamps(false),<br>       mFrameEventHistory(std::make_unique<ProducerFrameEventHistory>()){<br>    &#x2F;&#x2F; Initialize the ANativeWindow function pointers.<br>    ANativeWindow::setSwapInterval  &#x3D; hook_setSwapInterval;<br>    ANativeWindow::dequeueBuffer    &#x3D; hook_dequeueBuffer;<br>    ANativeWindow::cancelBuffer     &#x3D; hook_cancelBuffer;<br>    ANativeWindow::queueBuffer      &#x3D; hook_queueBuffer;<br>    ANativeWindow::query            &#x3D; hook_query;<br>    ANativeWindow::perform          &#x3D; hook_perform;<br>    â€¦<br>}</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%B0%8F%E7%BB%93" title="å°ç»“"></a>å°ç»“</h3><ul>
<li><code>native_handle/native_handle_t</code>Â æ˜¯Â <code>private_handle_t</code>Â çš„æŠ½è±¡è¡¨ç¤ºæ–¹æ³•ï¼Œæ¶ˆé™¤å¹³å°ç›¸å…³æ€§ï¼›æ–¹ä¾¿Â <code>private_handle_t</code>Â æ‰€è¡¨ç¤ºçš„ç¼“å­˜åŒºå¯ä»¥åœ¨Â <code>Android</code>Â å„ä¸ªå±‚æ¬¡ä¹‹é—´ä¼ é€’ï¼›è€ŒÂ <code>buffer_handle_t</code>Â æ˜¯æŒ‡å‘ä»–ä»¬çš„æŒ‡é’ˆ</li>
<li><code>ANativeWindowBuffer</code>Â å°†Â <code>buffer_handle_t</code>Â è¿›è¡Œäº†åŒ…è£…ï¼›<code>ANativeWindow, ANativeWindowBuffer</code>Â éƒ½ç»§æ‰¿äºÂ <code>android_native_base_t</code>Â ï¼Œå®ƒå®šä¹‰äº†å¼•ç”¨è®¡æ•°ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼›å¯ä»¥è®¤ä¸ºÂ <code>ANativeWindow, ANativeWindowBuffer</code>Â ä¸ºæŠ½è±¡æ•°æ®ç»“æ„ï¼Œè¡¨ç¤ºçª—å£å’Œå…¶å¯¹åº”ç¼“å­˜</li>
<li><code>GraphicBuffer, Surface</code>Â éƒ½ä½¿ç”¨äº†æ¨¡ç‰ˆç±»Â <code>ANativeObjectBase</code>Â ï¼Œéƒ½ç»§æ‰¿äº†Â <code>RefBase</code>Â å®ç°Â <code>incRef, decRef</code>Â å¼•ç”¨è®¡æ•°ï¼›å®ƒä»¬æ˜¯å…·ä½“çš„å®ç°ç±»ï¼Œå³å®ç°å…·ä½“çš„çª—å£ç¼“å­˜å’Œçª—å£</li>
<li><code>Surface</code>Â çš„æˆå‘˜Â <code>BufferSlot mSlots[NUM_BUFFER_SLOTS];</code>Â å¯ä»¥çœ‹ä½œæ˜¯Â <code>sp&lt;GraphicBuffer&gt;</code>Â ç±»å‹çš„æ•°ç»„ï¼›ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªÂ <code>Surface</code>Â ä¸­éƒ½åŒ…å«æœ‰Â <code>NUM_BUFFER_SLOTS</code>Â ä¸ªÂ <code>GraphicBuffer</code></li>
<li><code>Surface, GraphicBuffer</code>Â æ˜¯å›¾å½¢æ˜¾ç¤ºç³»ç»Ÿçš„é«˜å±‚ç±»ï¼Œåç»­ä¸»è¦å›´ç»•è¿™ä¸¤ä¸ªç±»æ¥ä»‹ç»ï¼›ä¸€ä¸ªä»£è¡¨çª—å£ï¼Œä¸€ä¸ªä»£è¡¨çª—å£å¯¹åº”çš„ç¼“å­˜</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://upload-images.jianshu.io/upload_images/606437-20bbb0ebba7fd244.png">Buffer&#x2F;Window ä½“ç³»ç¼“å­˜ï¼ŒæŸ¥çœ‹å¤§å›¾</a></p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-surface-buffer.png"></p>
<p><code>BufferQueue</code>Â ä¸­çš„Â <code>Buffer</code>Â å¯¹è±¡ï¼Œæˆ‘ä»¬ç”¨çš„éƒ½æ˜¯Â <code>GraphicBuffer</code>Â ã€‚Â <code>Surface</code>Â æ˜¯Â <code>Andorid</code>Â çª—å£çš„æè¿°ï¼Œæ˜¯Â <code>ANativeWindow</code>Â çš„å®ç°ï¼›åŒæ ·Â <code>GraphicBuffer</code>Â æ˜¯Â <code>Android</code>Â ä¸­å›¾å½¢Â <code>Buffer</code>Â çš„æè¿°ï¼Œæ˜¯Â <code>ANativeWindowBuffer</code>Â çš„å®ç°ã€‚è€Œä¸€ä¸ªçª—å£å¯ä»¥æœ‰å¤šä¸ªÂ <code>Buffer</code>Â ã€‚</p>
<h2 id="libui-åº“"><a href="#libui-åº“" class="headerlink" title="libuiÂ åº“"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#libui-%E5%BA%93" title="libui åº“"></a><code>libui</code>Â åº“</h2><p><code>libui.so</code>Â åº“ä¸»è¦æ˜¯Â <code>GraphicBuffer</code>Â ç¼“å­˜ç›¸å…³çš„ä»£ç ï¼ŒåŒ…å«ç¼“å­˜åˆ†é…ï¼Œæ˜ å°„å½“å½“å‰è¿›ç¨‹ç­‰ç­‰ï¼Œè€ŒÂ <code>IAllocator, IMapper</code>Â å…·ä½“æ˜¯åœ¨Â <code>HAL</code>Â ä¸­å®ç°çš„ã€‚</p>
<h3 id="ä»£ç ç›®å½•ç»“æ„"><a href="#ä»£ç ç›®å½•ç»“æ„" class="headerlink" title="ä»£ç ç›®å½•ç»“æ„"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" title="ä»£ç ç›®å½•ç»“æ„"></a>ä»£ç ç›®å½•ç»“æ„</h3><p><code>frameworks/native/libs/ui</code>Â ç›®å½•ç»“æ„ï¼š</p>
<p>ui<br>â”œâ”€â”€ Android.bp<br>â”œâ”€â”€ ColorSpace.cpp<br>â”œâ”€â”€ DebugUtils.cpp<br>â”œâ”€â”€ Fence.cpp<br>â”œâ”€â”€ FenceTime.cpp<br>â”œâ”€â”€ FrameStats.cpp<br>â”œâ”€â”€ Gralloc2.cpp<br>â”œâ”€â”€ GraphicBufferAllocator.cpp<br>â”œâ”€â”€ GraphicBuffer.cpp<br>â”œâ”€â”€ GraphicBufferMapper.cpp<br>â”œâ”€â”€ HdrCapabilities.cpp<br>â”œâ”€â”€ include<br>â”‚Â Â  â””â”€â”€ ui<br>â”‚Â Â      â”œâ”€â”€ ANativeObjectBase.h<br>â”‚Â Â      â”œâ”€â”€ BufferQueueDefs.h<br>â”‚Â Â      â”œâ”€â”€ ColorSpace.h<br>â”‚Â Â      â”œâ”€â”€ DebugUtils.h<br>â”‚Â Â      â”œâ”€â”€ DisplayInfo.h<br>â”‚Â Â      â”œâ”€â”€ DisplayStatInfo.h<br>â”‚Â Â      â”œâ”€â”€ Fence.h<br>â”‚Â Â      â”œâ”€â”€ FenceTime.h<br>â”‚Â Â      â”œâ”€â”€ FloatRect.h<br>â”‚Â Â      â”œâ”€â”€ FrameStats.h<br>â”‚Â Â      â”œâ”€â”€ Gralloc2.h<br>â”‚Â Â      â”œâ”€â”€ GraphicBufferAllocator.h<br>â”‚Â Â      â”œâ”€â”€ GraphicBuffer.h<br>â”‚Â Â      â”œâ”€â”€ GraphicBufferMapper.h<br>â”‚Â Â      â”œâ”€â”€ HdrCapabilities.h<br>â”‚Â Â      â”œâ”€â”€ PixelFormat.h<br>â”‚Â Â      â”œâ”€â”€ Point.h<br>â”‚Â Â      â”œâ”€â”€ Rect.h<br>â”‚Â Â      â”œâ”€â”€ Region.h<br>â”‚Â Â      â””â”€â”€ UiConfig.h<br>â”œâ”€â”€ MODULE_LICENSE_APACHE2<br>â”œâ”€â”€ NOTICE<br>â”œâ”€â”€ PixelFormat.cpp<br>â”œâ”€â”€ Rect.cpp<br>â”œâ”€â”€ Region.cpp<br>â”œâ”€â”€ tests<br>â”‚Â Â  â”œâ”€â”€ Android.bp<br>â”‚Â Â  â”œâ”€â”€ colorspace_test.cpp<br>â”‚Â Â  â””â”€â”€ Region_test.cpp<br>â”œâ”€â”€ tools<br>â”‚Â Â  â”œâ”€â”€ Android.bp<br>â”‚Â Â  â””â”€â”€ lutgen.cpp<br>â””â”€â”€ UiConfig.cpp</p>
<p>4 directories, 42 files</p>
<h3 id="GraphicBufferAllocator-GraphicBufferMapper"><a href="#GraphicBufferAllocator-GraphicBufferMapper" class="headerlink" title="GraphicBufferAllocator/GraphicBufferMapper"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#GraphicBufferAllocator-GraphicBufferMapper" title="GraphicBufferAllocator/GraphicBufferMapper"></a><code>GraphicBufferAllocator/GraphicBufferMapper</code></h3><p>å®ƒä»¬ä¸¤ä¸ªéƒ½æ˜¯åŒ…è£…ç±»ï¼ŒåŒ…è£…äº†Â <code>IAllocator, IMapper</code>Â ï¼Œè€Œè¿™ä¸¤ä¸ªç±»éƒ½æ˜¯åœ¨Â <code>HAL Gralloc2</code>Â ä¸­å®ç°çš„ã€‚</p>
<ul>
<li><code>GraphicBufferAllocator</code><br>  ç¼“å­˜åˆ†é…ï¼ŒåŒ…è£…äº†Â <code>IAllocator</code>Â ç±»ã€‚</li>
<li><code>GraphicBufferMapper</code><br>  ç¼“å­˜æ˜ å°„åˆ°å½“å‰è¿›ç¨‹ï¼ŒåŒ…è£…äº†Â <code>IMapper</code>Â ç±»ã€‚</li>
</ul>
<h3 id="GraphicBuffer-1"><a href="#GraphicBuffer-1" class="headerlink" title="GraphicBuffer"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#GraphicBuffer-1" title="GraphicBuffer"></a><code>GraphicBuffer</code></h3><p><code>GraphicBuffer</code>Â ç»§æ‰¿Â <code>ANativeWindowBuffer</code>Â ï¼Œå¹¶æŒæœ‰Â <code>GraphicBufferMapper</code>Â æ˜ å°„å¯¹åº”çš„ç¼“å­˜åŒºã€‚</p>
<p>class GraphicBuffer :<br>    public ANativeObjectBase&lt;ANativeWindowBuffer, GraphicBuffer,RefBase&gt;,<br>    public Flattenable<GraphicBuffer><br>{<br>public:<br>    static sp<GraphicBuffer> from(ANativeWindowBuffer *);<br>    â€¦<br>private:<br>    GraphicBufferMapper&amp; mBufferMapper;<br>    ssize_t mInitCheck;<br>    uint64_t mId;<br>    uint32_t mGenerationNumber;<br>};</p>
<h3 id="Fence-æœºåˆ¶"><a href="#Fence-æœºåˆ¶" class="headerlink" title="FenceÂ æœºåˆ¶"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#Fence-%E6%9C%BA%E5%88%B6" title="Fence æœºåˆ¶"></a><code>Fence</code>Â æœºåˆ¶</h3><p><code>Fence</code>Â æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œä¸»è¦ç”¨äºÂ <code>GraphicBuffer</code>Â çš„åŒæ­¥ã€‚å®ƒä¸»è¦è¢«ç”¨æ¥å¤„ç†è·¨ç¡¬ä»¶çš„æƒ…å†µï¼Œå°¤å…¶æ˜¯Â <code>CPU, GPU, HWC</code>Â ä¹‹é—´çš„åŒæ­¥ï¼Œå¦å¤–å®ƒè¿˜å¯ä»¥ç”¨äºå¤šä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„åŒæ­¥ã€‚Â <code>GPU</code>Â ç¼–ç¨‹å’Œçº¯Â <code>CPU</code>Â ç¼–ç¨‹ä¸€ä¸ªå¾ˆå¤§çš„ä¸åŒæ˜¯å®ƒæ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬è°ƒç”¨Â <code>GL command</code>Â è¿”å›æ—¶è¿™æ¡å‘½ä»¤å¹¶ä¸ä¸€å®šå®Œæˆäº†ï¼Œåªæ˜¯æŠŠè¿™ä¸ªå‘½ä»¤æ”¾åœ¨æœ¬åœ°çš„Â <code>command buffer</code>Â é‡Œï¼Œè€ŒÂ <code>Fence</code>Â æœºåˆ¶å°±æ˜¯è§£å†³è¿™äº›åŒæ­¥é—®é¢˜çš„ã€‚<br><code>Fence</code>Â é¡¾åæ€ä¹‰å°±æ˜¯æŠŠå…ˆåˆ°çš„æ‹¦ä½ï¼Œç­‰åæ¥çš„ï¼Œä¸¤è€…æ­¥è°ƒä¸€è‡´äº†å†å¾€å‰èµ°ã€‚æŠ½è±¡åœ°è¯´ï¼Œ<code>Fence</code>Â åŒ…å«äº†åŒä¸€æˆ–ä¸åŒæ—¶é—´è½´ä¸Šçš„å¤šä¸ªæ—¶é—´ç‚¹ï¼Œåªæœ‰å½“è¿™äº›ç‚¹åŒæ—¶åˆ°è¾¾æ—¶Â <code>Fence</code>Â æ‰ä¼šè¢«è§¦å‘ã€‚Â <code>Fence</code>Â å¯ä»¥ç”±ç¡¬ä»¶å®ç°Â <code>Graphic driver</code>ï¼Œä¹Ÿå¯ä»¥ç”±è½¯ä»¶å®ç°Â <code>Android kernel</code>Â ä¸­çš„Â <code>sw_sync</code>Â ã€‚</p>
<p><code>Fence</code>Â çš„ä¸»è¦å®ç°ä»£ç è·¯å¾„ï¼š</p>
<p>frameworks&#x2F;native&#x2F;libs&#x2F;ui&#x2F;Fence.cpp<br>system&#x2F;core&#x2F;libsync&#x2F;sync.c<br>kernel&#x2F;drivers&#x2F;base&#x2F;sync.c<br>frameworks&#x2F;native&#x2F;libs&#x2F;gui&#x2F;SyncFeatures.cpp</p>
<p>æ€»å¾—æ¥è¯´ï¼ŒÂ <code>kernel driver</code>Â éƒ¨åˆ†æ˜¯åŒæ­¥çš„ä¸»è¦å®ç°ï¼Œ<code>libsync</code>Â æ˜¯å¯¹Â <code>driver</code>Â æ¥å£çš„å°è£…ï¼ŒÂ <code>Fence</code>Â æ˜¯å¯¹Â <code>libsync</code>Â çš„è¿›ä¸€æ­¥çš„Â <code>C++</code>Â å°è£…ã€‚Â <code>Fence</code>Â ä¼šè¢«ä½œä¸ºÂ <code>GraphicBuffer</code>Â çš„é™„å±éšç€Â <code>GraphicBuffer</code>Â åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹é—´ä¼ è¾“ï¼›Â <code>SyncFeatures</code>Â ç”¨ä»¥æŸ¥è¯¢ç³»ç»Ÿæ”¯æŒçš„åŒæ­¥æœºåˆ¶ã€‚</p>
<h3 id="DisplayInfo-æ˜¾ç¤ºä¿¡æ¯"><a href="#DisplayInfo-æ˜¾ç¤ºä¿¡æ¯" class="headerlink" title="DisplayInfoÂ æ˜¾ç¤ºä¿¡æ¯"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#DisplayInfo-%E6%98%BE%E7%A4%BA%E4%BF%A1%E6%81%AF" title="DisplayInfo æ˜¾ç¤ºä¿¡æ¯"></a><code>DisplayInfo</code>Â æ˜¾ç¤ºä¿¡æ¯</h3><p>&#x2F;&#x2F; DisplayInfo.h<br>struct DisplayInfo {<br>    uint32_t w{0};                      &#x2F;&#x2F; å±å¹•çš„å®½<br>    uint32_t h{0};                      &#x2F;&#x2F; å±å¹•çš„é«˜<br>    float xdpi{0};                      &#x2F;&#x2F; å±å¹• x æ–¹å‘æ¯è‹±å¯¸çš„åƒç´ ç‚¹<br>    float ydpi{0};                      &#x2F;&#x2F; å±å¹• y æ–¹å‘æ¯è‹±å¯¸çš„åƒç´ ç‚¹<br>    float fps{0};                       &#x2F;&#x2F; FPS å±å¹•çš„åˆ·æ–°ç‡<br>    float density{0};                   &#x2F;&#x2F; å±å¹•çš„å¯†åº¦<br>    uint8_t orientation{0};             &#x2F;&#x2F; å±å¹•çš„æ—‹è½¬æ–¹å¼<br>    bool secure{false};                 &#x2F;&#x2F; å±å¹•æ˜¯å¦æ˜¯å®‰å…¨çš„<br>    nsecs_t appVsyncOffset{0};          &#x2F;&#x2F; App çš„ Vsync çš„åç§»<br>    nsecs_t presentationDeadline{0};    &#x2F;&#x2F; æ˜¾ç¤ºçš„æœ€åæ—¶é—´<br>};</p>
<p>&#x2F;* Display orientations as defined in Surface.java<br>    and ISurfaceComposer.h. *&#x2F;<br>enum {<br>    DISPLAY_ORIENTATION_0 &#x3D; 0,<br>    DISPLAY_ORIENTATION_90 &#x3D; 1,<br>    DISPLAY_ORIENTATION_180 &#x3D; 2,<br>    DISPLAY_ORIENTATION_270 &#x3D; 3<br>};</p>
<p>}; &#x2F;&#x2F; namespace android</p>
<p><code>DisplayInfo</code>Â ç»“æ„ä½“åŒ…å«äº†æ˜¾ç¤ºå±å¹•çš„åŸºæœ¬ä¿¡æ¯ï¼š</p>
<ul>
<li><p>å±å¹•åˆ†è¾¨ç‡Â <code>Resolution</code><br>  å±å¹•çš„å®½é«˜æ˜¯ç”¨åˆ†è¾¨ç‡Â <code>Resolution</code>Â æ¥æè¿°çš„ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªåƒç´ ç‚¹ã€‚å±å¹•å®½åº¦ï¼Œå³å±å¹•æ¨ªå‘å¯ä»¥æ˜¾ç¤ºå¤šå°‘ä¸ªåƒç´ ç‚¹ï¼›å±å¹•é«˜åº¦ï¼Œå³å±å¹•çºµå‘å¯ä»¥æ˜¾ç¤ºå¤šå°‘ç»™åƒç´ ç‚¹ã€‚å¹³å¸¸æ‰€è¯´çš„Â <code>720P: 1080x720</code>Â å±å¹•ï¼Œå³æ¨ªå‘å¯ä»¥æ˜¾ç¤º 1080 ä¸ªåƒç´ ç‚¹ï¼Œçºµå‘å¯ä»¥æ˜¾ç¤º 720 ä¸ªåƒç´ ç‚¹ã€‚å¦‚ä¸‹ä¸ºå¸¸è§å±å¹•åˆ†è¾¨ç‡ï¼š  </p>
<p>  <img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-resolution.png"></p>
</li>
<li><p>å±å¹•Â <code>DPI</code><br>  <code>DPI: Dots Per Inch</code>Â æ¯è‹±å¯¸ç‚¹æ•°ï¼Œæ˜¯ä¸€ä¸ªåº¦é‡å•ä½ï¼Œè¡¨ç¤ºå±å¹•æ¯è‹±å¯¸ä¸Šæœ‰å¤šå°‘ä¸ªç‰©ç†ç‚¹ã€‚å¸¸è§å±å¹•ç‰©ç†å¤§å°ï¼Œæ˜¯ç”¨è‹±å¯¸æ¥æè¿°å±å¹•å¯¹è§’çº¿çš„é•¿åº¦ï¼Œæ¯”å¦‚Â <code>IPhone X</code>Â çš„å¤§å° 5.8 å¯¸ï¼Œå³å±å¹•å¯¹è§’çº¿é•¿åº¦ä¸º 5.8 è‹±å¯¸ã€‚*Â _æ ‡å‡†Â <code>DPI</code>Â ä¸ºÂ <code>160dpi</code>Â *_ï¼Œäººç±»è§†ç½‘è†œçº§é€šå¸¸ä¸ºÂ <code>300dpi</code>Â ã€‚<br>  <code>PPI: Pixel Per Inch</code>Â æ¯è‹±å¯¸åƒç´ ï¼Œä¹Ÿæ˜¯åº¦é‡å•ä½ï¼Œè¡¨ç¤ºæ¯è‹±å¯¸æ˜¾ç¤ºå¤šå°‘ä¸ªåƒç´ ã€‚é€šå¸¸æƒ…å†µä¸‹Â <code>DPI, PPI</code>Â è®¾ä¸ºç›¸åŒï¼Œè¡¨ç¤ºæ¯ä¸ªç‰©ç†ç‚¹æ˜¾ç¤ºä¸€ä¸ªåƒç´ ï¼›ä½†æ˜¯å¥½ä¸€ç‚¹çš„æ˜¾ç¤ºå™¨ï¼Œå¯èƒ½Â <code>DPI</code>Â æ¯”Â <code>PPI</code>Â å¤§ï¼Œå³ä¸€ä¸ªåƒç´ ç”±å¤šä¸ªç‰©ç†ç‚¹æ¥æ˜¾ç¤ºã€‚</p>
</li>
<li><p>å¯†åº¦Â <code>Density</code><br>  <code>DIP: Density Independent Pixels</code>Â è®¾å¤‡æ— å…³åƒç´ ï¼Œé€šå¸¸ç®€å†™ä¸ºÂ <code>DP=DIP</code>ï¼Œè¯·æ³¨æ„Â <code>DPI</code>Â åšå¥½åŒºåˆ†ã€‚Â <code>DP</code>Â è¡¨ç¤ºè¿™ä¸ªåƒç´ çš„æ•°å€¼æ˜¯å’Œè®¾å¤‡æ— å…³çš„ï¼Œé‚£å®é™…è½¬æ¢æ—¶æ€ä¹ˆè½¬æ¢å‘¢ï¼Ÿ<br>  <code>Density</code>Â å¯†åº¦ï¼Œå®é™…æ˜¯ä¸€ä¸ªç¼©æ”¾å› å­ï¼Œå®ƒè¡¨ç¤ºå½“å‰è®¾å¤‡å®é™…Â <code>DPI</code>Â å’Œæ ‡å‡†Â <code>DPI</code>Â çš„æ¯”ä¾‹å€¼ï¼›æ¯”å¦‚è®¾å¤‡å®é™…Â <code>DPI</code>Â ä¸ºÂ <code>320dpi</code>Â ï¼Œé‚£ä¹ˆÂ <code>density=320/160=2</code>Â ï¼Œå³Â <code>density</code>Â ä¸º 2 ã€‚æœ‰äº†Â <code>density</code>Â ä¹‹åï¼ŒÂ <code>dp, px</code>Â å¯ä»¥ä½¿ç”¨å…¬å¼æ¥è½¬æ¢Â <code>px=density*dp</code>Â ã€‚<br>  æ‰€ä»¥æˆ‘ä»¬åœ¨Â <code>APP</code>Â å¸ƒå±€è®¾è®¡ä¸­ï¼Œæ‰€æœ‰æ˜¾ç¤ºè®¾ç½®çš„è·ç¦»ï¼Œé€šå¸¸ä½¿ç”¨Â <code>dp</code>Â æ¥è®¡ç®—ï¼Œæ¥è§„é¿ä¸åŒå±å¹•ç‰¹æ€§ã€‚</p>
</li>
<li><p>å±å¹•åˆ·æ–°ç‡Â <code>FPS</code><br>  è¿™é‡Œå±å¹•åˆ·æ–°ç‡ä½¿ç”¨Â <code>FPS</code>Â æ¥è¡¨ç¤ºï¼Œä¸æ˜¯Â <code>Hz</code>Â ï¼Œè¡¨ç¤ºå±å¹•æ¯ç§’èƒ½æ˜¾ç¤ºå¤šå°‘å¸§æ•°æ®ï¼›é€šå¸¸ä¸º 60 fps ï¼Œå³ 16 ms åˆ·æ–°ä¸€æ¬¡ã€‚</p>
</li>
<li><p>å±å¹•æ—‹è½¬æ–¹å‘Â <code>orientations</code><br>  æ‰‹æœºé»˜è®¤ç«–å±ï¼Œ0 è¡¨ç¤ºç«–å±ï¼Œ 180 è¡¨ç¤ºæ¨ªå±ã€‚</p>
</li>
<li><p>å±å¹•å®‰å…¨æ€§Â <code>secure</code><br>  è¿™ä¸»è¦æ˜¯ç”¨äºÂ <code>DRM</code>Â æ•°å­—ç‰ˆæƒä¿æŠ¤æ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºçš„è®¾å¤‡æ˜¯å®‰å…¨çš„ï¼Œä»¥é˜²æ­¢Â <code>DRM</code>Â çš„å†…å®¹è¢«åœ¨æ˜¾ç¤ºçš„è¿‡ç¨‹ä¸­è¢«æˆªå–ï¼Œåªæœ‰å®‰å…¨çš„è®¾å¤‡æ‰èƒ½æ˜¾ç¤ºÂ <code>DRM</code>Â çš„å†…å®¹ã€‚Â <code>Android</code>Â é»˜è®¤æ‰€æœ‰çš„éè™šæ‹Ÿæ˜¾ç¤ºéƒ½æ˜¯å®‰å…¨çš„ã€‚</p>
</li>
<li><p><code>appVsyncOffset, presentationDeadline</code><br>  è¿™ä¸¤ä¸ªéƒ½å’ŒÂ <code>Vsync</code>Â æœ‰å…³ï¼›Â <code>appVsyncOffset</code>Â æ˜¯ä¸€ä¸ªåç§»é‡ï¼Œåœ¨ç³»ç»Ÿæˆ–ç¡¬ä»¶Â <code>Vsync</code>Â çš„åŸºç¡€ä¸Šåšä¸€äº›åç§»ï¼›Â <code>presentationDeadline</code>Â è¡¨ç¤ºï¼Œä¸€å¸§æ•°æ®å¿…ç°åœ¨è¿™ä¸ªæ—¶é—´å†…æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
</li>
</ul>
<h2 id="libgui-åº“"><a href="#libgui-åº“" class="headerlink" title="libguiÂ åº“"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#libgui-%E5%BA%93" title="libgui åº“"></a><code>libgui</code>Â åº“</h2><h3 id="ä»£ç ç›®å½•ç»“æ„-1"><a href="#ä»£ç ç›®å½•ç»“æ„-1" class="headerlink" title="ä»£ç ç›®å½•ç»“æ„"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1" title="ä»£ç ç›®å½•ç»“æ„"></a>ä»£ç ç›®å½•ç»“æ„</h3><p><code>frameworks/native/libs/gui</code>Â ç›®å½•ç»“æ„ï¼š</p>
<p>gui&#x2F;<br>â”œâ”€â”€ Android.bp<br>â”œâ”€â”€ BitTube.cpp<br>â”œâ”€â”€ BufferItemConsumer.cpp<br>â”œâ”€â”€ BufferItem.cpp<br>â”œâ”€â”€ bufferqueue<br>â”‚Â Â  â””â”€â”€ 1.0<br>â”‚Â Â      â”œâ”€â”€ B2HProducerListener.cpp<br>â”‚Â Â      â””â”€â”€ H2BGraphicBufferProducer.cpp<br>â”œâ”€â”€ BufferQueueConsumer.cpp<br>â”œâ”€â”€ BufferQueueCore.cpp<br>â”œâ”€â”€ BufferQueue.cpp<br>â”œâ”€â”€ BufferQueueProducer.cpp<br>â”œâ”€â”€ BufferSlot.cpp<br>â”œâ”€â”€ CleanSpec.mk<br>â”œâ”€â”€ ConsumerBase.cpp<br>â”œâ”€â”€ CpuConsumer.cpp<br>â”œâ”€â”€ DisplayEventReceiver.cpp<br>â”œâ”€â”€ FrameTimestamps.cpp<br>â”œâ”€â”€ GLConsumer.cpp<br>â”œâ”€â”€ GuiConfig.cpp<br>â”œâ”€â”€ IConsumerListener.cpp<br>â”œâ”€â”€ IDisplayEventConnection.cpp<br>â”œâ”€â”€ IGraphicBufferConsumer.cpp<br>â”œâ”€â”€ IGraphicBufferProducer.cpp<br>â”œâ”€â”€ include<br>â”‚Â Â  â”œâ”€â”€ gui<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferItemConsumer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferItem.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ bufferqueue<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ 1.0<br>â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ B2HProducerListener.h<br>â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ H2BGraphicBufferProducer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferQueueConsumer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferQueueCore.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferQueueDefs.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferQueue.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferQueueProducer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BufferSlot.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ConsumerBase.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ CpuConsumer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DisplayEventReceiver.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FrameTimestamps.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ GLConsumer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ GuiConfig.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IConsumerListener.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IDisplayEventConnection.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IGraphicBufferConsumer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IGraphicBufferProducer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IProducerListener.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ISurfaceComposerClient.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ISurfaceComposer.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OccupancyTracker.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ StreamSplitter.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ SurfaceComposerClient.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ SurfaceControl.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Surface.h<br>â”‚Â Â  â”‚Â Â  â””â”€â”€ view<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ Surface.h<br>â”‚Â Â  â””â”€â”€ private<br>â”‚Â Â      â””â”€â”€ gui<br>â”‚Â Â          â”œâ”€â”€ BitTube.h<br>â”‚Â Â          â”œâ”€â”€ ComposerService.h<br>â”‚Â Â          â”œâ”€â”€ LayerState.h<br>â”‚Â Â          â””â”€â”€ SyncFeatures.h<br>â”œâ”€â”€ IProducerListener.cpp<br>â”œâ”€â”€ ISurfaceComposerClient.cpp<br>â”œâ”€â”€ ISurfaceComposer.cpp<br>â”œâ”€â”€ LayerState.cpp<br>â”œâ”€â”€ OccupancyTracker.cpp<br>â”œâ”€â”€ StreamSplitter.cpp<br>â”œâ”€â”€ SurfaceComposerClient.cpp<br>â”œâ”€â”€ SurfaceControl.cpp<br>â”œâ”€â”€ Surface.cpp<br>â”œâ”€â”€ SyncFeatures.cpp<br>â”œâ”€â”€ tests<br>â”‚Â Â  â”œâ”€â”€ â€¦<br>â””â”€â”€ view<br>    â””â”€â”€ Surface.cpp</p>
<p>11 directories, 96 files</p>
<p>å…¶ä¸­Â <code>H2B, B2H</code>Â è¡¨ç¤ºÂ <code>Framework Buffer</code>Â å’ŒÂ <code>HAL</code>Â å±‚æ•°æ®ç»“æ„çš„ç›¸äº’è½¬æ¢ï¼›å®é™…ä¸Šä»£è¡¨çš„æ˜¯åŒä¸€æ ·ä¸œè¥¿ï¼Œæ–¹ä¾¿å„å±‚å†…éƒ¨ä½¿ç”¨ã€‚</p>
<h3 id="IGraphicBufferProducer-IProducerListener-ç”Ÿäº§è€…"><a href="#IGraphicBufferProducer-IProducerListener-ç”Ÿäº§è€…" class="headerlink" title="IGraphicBufferProducer/IProducerListenerÂ ç”Ÿäº§è€…"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#IGraphicBufferProducer-IProducerListener-%E7%94%9F%E4%BA%A7%E8%80%85" title="IGraphicBufferProducer/IProducerListener ç”Ÿäº§è€…"></a><code>IGraphicBufferProducer/IProducerListener</code>Â ç”Ÿäº§è€…</h3><p><code>IGraphicBufferProducer</code>Â æ˜¯ç”Ÿäº§è€…æ¥å£ï¼Œå®ç°äº†Â <code>IInterface</code>Â å¯ä»¥ç”¨äºè·¨è¿›ç¨‹é€šä¿¡ã€‚</p>
<p>&#x2F;&#x2F; IGraphicBufferProducer.h<br>class IGraphicBufferProducer : public IInterface<br>{<br>public:<br>    DECLARE_HYBRID_META_INTERFACE(GraphicBufferProducer,<br>        HGraphicBufferProducer)<br>    â€¦<br>    &#x2F;&#x2F; æ ¹æ®æŒ‡å®šå‚æ•°ç”³è¯·ä¸€å— Buffer ï¼Œç´¢å¼•å€¼ä¸º slot ï¼ŒåŒæ­¥ä¸º fence<br>    &#x2F;&#x2F; ä» BufferQueue ä¸­å‡ºé˜Ÿä¸€å—ç¼“å­˜ GraphicBuffer<br>    virtual status_t dequeueBuffer(int* slot, sp<Fence>* fence,<br>        uint32_t w, uint32_t h,<br>        PixelFormat format, uint64_t usage, uint64_t* outBufferAge,<br>        FrameEventHistoryDelta* outTimestamps) &#x3D; 0;<br>    &#x2F;&#x2F; è·å– slot ä½ç½®çš„ GraphicBuffer<br>    virtual status_t requestBuffer(int slot, sp<GraphicBuffer>* buf) &#x3D; 0;<br>    &#x2F;&#x2F; å®¢æˆ·ç«¯å·²ç»å‘ slot ä½ç½®çš„ Buffer å¡«å……å®Œæ•°æ®<br>    &#x2F;&#x2F; IGraphicBufferProducer å¾—åˆ° Buffer çš„è¾“å…¥ä¿¡æ¯ï¼Œ<br>    &#x2F;&#x2F; slot è¿™å—ç¼“å­˜ GraphicBuffer è¿›å…¥é˜Ÿåˆ— BufferQueue<br>    virtual status_t queueBuffer(int slot, const QueueBufferInput&amp; input,<br>            QueueBufferOutput* output) &#x3D; 0;<br>    &#x2F;&#x2F; é‡Šæ”¾ slot ä½ç½®çš„ GraphicBuffer<br>    virtual status_t detachBuffer(int slot) &#x3D; 0;<br>    virtual status_t detachNextBuffer(sp<GraphicBuffer>* outBuffer,<br>            sp<Fence>* outFence) &#x3D; 0;<br>    &#x2F;&#x2F; æ ¹æ®æŒ‡å®šçš„ buffer è·å– slot<br>    virtual status_t attachBuffer(int* outSlot,<br>            const sp<GraphicBuffer>&amp; buffer) &#x3D; 0;<br>    &#x2F;&#x2F; é‡Šæ”¾ slot ä½ç½®çš„ buffer<br>    virtual status_t cancelBuffer(int slot, const sp<Fence>&amp; fence) &#x3D; 0;<br>    â€¦<br>    &#x2F;&#x2F; å®¢æˆ·ç«¯æ ¹æ® api ç±»å‹ï¼Œè¿æ¥ IGraphicBufferProducer ï¼Œ<br>    &#x2F;&#x2F; å®¢æˆ·ç«¯å¾—åˆ°ç¼“å­˜çš„ç›¸å…³ä¿¡æ¯ QueueBufferOutput<br>    virtual status_t connect(const sp<IProducerListener>&amp; listener,<br>            int api, bool producerControlledByApp,<br>            QueueBufferOutput* output) &#x3D; 0;<br>    &#x2F;&#x2F; æ–­å¼€è¿æ¥<br>    virtual status_t disconnect(int api,<br>        DisconnectMode mode &#x3D; DisconnectMode::Api) &#x3D; 0;<br>    &#x2F;&#x2F; è·å–æ¶ˆè´¹è€…åç§°<br>    virtual String8 getConsumerName() const &#x3D; 0;<br>    â€¦<br>};</p>
<p><code>IProducerListener</code>Â æ˜¯Â <code>IGraphicBufferProducer</code>Â å¯¹åº”çš„å›è°ƒæ¥å£ã€‚</p>
<p>&#x2F;&#x2F; IProducerListener.h<br>class ProducerListener : public virtual RefBase<br>{<br>public:<br>    ProducerListener() {}<br>    virtual ~ProducerListener();</p>
<pre><code>virtual void onBufferReleased() = 0; // Asynchronous
virtual bool needsReleaseNotify() = 0;
</code></pre>
<p>};</p>
<p>class IProducerListener : public ProducerListener, public IInterface<br>{<br>public:<br>    DECLARE_META_INTERFACE(ProducerListener)<br>};</p>
<p>class BnProducerListener : public BnInterface<IProducerListener><br>{<br>public:<br>    virtual status_t onTransact(uint32_t code, const Parcel&amp; data,<br>            Parcel* reply, uint32_t flags &#x3D; 0);<br>    virtual bool needsReleaseNotify();<br>};</p>
<p>class DummyProducerListener : public BnProducerListener<br>{<br>public:<br>    virtual ~DummyProducerListener();<br>    virtual void onBufferReleased() {}<br>    virtual bool needsReleaseNotify() { return false; }<br>};</p>
<h3 id="IGraphicBufferConsumer-IConsumerListener-æ¶ˆè´¹è€…"><a href="#IGraphicBufferConsumer-IConsumerListener-æ¶ˆè´¹è€…" class="headerlink" title="IGraphicBufferConsumer/IConsumerListenerÂ æ¶ˆè´¹è€…"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#IGraphicBufferConsumer-IConsumerListener-%E6%B6%88%E8%B4%B9%E8%80%85" title="IGraphicBufferConsumer/IConsumerListener æ¶ˆè´¹è€…"></a><code>IGraphicBufferConsumer/IConsumerListener</code>Â æ¶ˆè´¹è€…</h3><p><code>IGraphicBufferConsumer</code>Â æ˜¯æ¶ˆè´¹è€…æ¥å£ï¼Œå®ç°äº†Â <code>IInterface</code>Â å¯ä»¥ç”¨äºè·¨è¿›ç¨‹é€šä¿¡ã€‚</p>
<p>&#x2F;&#x2F; IGraphicBufferConsumer.h<br>class IGraphicBufferConsumer : public IInterface {<br>public:<br>    DECLARE_META_INTERFACE(GraphicBufferConsumer)<br>    â€¦<br>    &#x2F;&#x2F; ä» BufferQueue ä¸­è·å–ä¸€å—å‡†å¤‡å¥½äº†çš„ç¼“å­˜ GraphicBuffer<br>    virtual status_t acquireBuffer(BufferItem* buffer,<br>        nsecs_t presentWhen, uint64_t maxFrameNumber &#x3D; 0) &#x3D; 0;<br>    &#x2F;&#x2F; é‡Šæ”¾ slot ä½ç½®çš„ç¼“å­˜<br>    virtual status_t detachBuffer(int slot) &#x3D; 0;<br>    &#x2F;&#x2F; æ ¹æ®æŒ‡å®šçš„ GraphicBuffer è·å– slot<br>    virtual status_t attachBuffer(int* outSlot,<br>        const sp<GraphicBuffer>&amp; buffer) &#x3D; 0;<br>    &#x2F;&#x2F; ç§»é™¤æŒ‡å®š slot ä½ç½®çš„ç¼“å­˜<br>    virtual status_t releaseBuffer(int buf, uint64_t frameNumber,<br>        EGLDisplay display, EGLSyncKHR fence,<br>        const sp<Fence>&amp; releaseFence) &#x3D; 0;<br>    â€¦<br>    &#x2F;&#x2F; è¿æ¥ä¸€ä¸ªæ¶ˆè´¹è€…è¿›å…¥ BufferQueue<br>    virtual status_t consumerConnect(const sp<IConsumerListener>&amp; consumer,<br>                                     bool controlledByApp) &#x3D; 0;<br>    &#x2F;&#x2F; ä» BufferQueue æ–­å¼€è¿æ¥<br>    virtual status_t consumerDisconnect() &#x3D; 0;<br>    â€¦<br>};</p>
<p><code>IConsumerListener</code>Â æ˜¯Â <code>IGraphicBufferConsumer</code>Â å¯¹åº”çš„å›è°ƒæ¥å£ï¼š</p>
<p>&#x2F;&#x2F; IConsumerListener.h<br>class ConsumerListener : public virtual RefBase {<br>public:<br>    ConsumerListener() {}<br>    virtual ~ConsumerListener();</p>
<pre><code>virtual void onDisconnect() &#123;&#125; /* Asynchronous */
virtual void onFrameAvailable(const BufferItem&amp; item) 
    = 0; /* Asynchronous */
virtual void onFrameReplaced(const BufferItem&amp; /* item */)
    &#123;&#125; /* Asynchronous */
virtual void onBuffersReleased() = 0; /* Asynchronous */
virtual void onSidebandStreamChanged() = 0; /* Asynchronous */
virtual void addAndGetFrameTimestamps(const NewFrameEventsEntry* 
    /*newTimestamps*/, FrameEventHistoryDelta* /*outDelta*/) &#123;&#125;
</code></pre>
<p>};</p>
<p>class IConsumerListener : public ConsumerListener, public IInterface {<br>public:<br>    DECLARE_META_INTERFACE(ConsumerListener)<br>};</p>
<h3 id="BufferItem"><a href="#BufferItem" class="headerlink" title="BufferItem"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#BufferItem" title="BufferItem"></a><code>BufferItem</code></h3><p><code>BufferItem</code>Â æè¿°äº†ä¸€å—ç¼“å­˜Â <code>GraphicBuffer</code>Â ï¼Œä»¥åŠä½ç½®Â <code>mSlot</code>Â ï¼ŒåŒæ­¥Â <code>mFence</code>Â ç­‰ç­‰ä¿¡æ¯ã€‚</p>
<p>&#x2F;&#x2F; BufferItem.h<br>class BufferItem : public Flattenable<BufferItem> {<br>    â€¦<br>    sp<GraphicBuffer> mGraphicBuffer;<br>    sp<Fence> mFence;<br>    Rect mCrop;<br>    â€¦<br>    android_dataspace mDataSpace;<br>    uint64_t mFrameNumber;<br>    int mSlot;<br>    â€¦<br>}</p>
<h3 id="BufferSlot"><a href="#BufferSlot" class="headerlink" title="BufferSlot"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#BufferSlot" title="BufferSlot"></a><code>BufferSlot</code></h3><p><code>BufferSlot</code>Â è®°å½•äº†å½“å‰Â <code>slot</code>Â ä½ç½®çš„ç¼“å­˜Â <code>GraphicBuffer</code>Â ï¼Œä»¥åŠå¯¹åº”çŠ¶æ€ï¼ŒÂ <code>EGL</code>Â ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>&#x2F;&#x2F; BufferSlot.h<br>struct BufferSlot {</p>
<pre><code>BufferSlot()
: mGraphicBuffer(nullptr),
  mEglDisplay(EGL_NO_DISPLAY),
  mBufferState(),
  mRequestBufferCalled(false),
  mFrameNumber(0),
  mEglFence(EGL_NO_SYNC_KHR),
  mFence(Fence::NO_FENCE),
  mAcquireCalled(false),
  mNeedsReallocation(false) &#123;
&#125;

sp&lt;GraphicBuffer&gt; mGraphicBuffer;
EGLDisplay mEglDisplay;
BufferState mBufferState;
bool mRequestBufferCalled;
uint64_t mFrameNumber;
EGLSyncKHR mEglFence;
sp&lt;Fence&gt; mFence;
bool mAcquireCalled;
bool mNeedsReallocation;
</code></pre>
<p>};</p>
<p><code>BufferQueueDefs</code>Â ä¸­å®šä¹‰äº†ä¸€ä¸ªÂ <code>BufferSlot</code>Â çš„æ•°ç»„ç»“æ„ç±»å‹Â <code>SlotsType</code>Â ã€‚</p>
<p>&#x2F;&#x2F; BufferQueueDefs.h<br>namespace android {<br>    class BufferQueueCore;</p>
<pre><code>namespace BufferQueueDefs &#123;
    typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS];
&#125; // namespace BufferQueueDefs
</code></pre>
<p>} &#x2F;&#x2F; namespace android</p>
<h3 id="BufferQueueCore"><a href="#BufferQueueCore" class="headerlink" title="BufferQueueCore"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#BufferQueueCore" title="BufferQueueCore"></a><code>BufferQueueCore</code></h3><p><code>BufferQueueCore</code>Â æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹æ¨¡å‹çš„æ ¸å¿ƒï¼Œå¦‚ä¸‹æ˜¯å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š</p>
<p>&#x2F;&#x2F; BufferQueueCore.h<br>class BufferQueueCore : public virtual RefBase {<br>public:<br>    â€¦<br>    typedef Vector<BufferItem> Fifo;<br>private:<br>    â€¦<br>    String8 mConsumerName;<br>    sp<IConsumerListener> mConsumerListener;<br>    sp<IProducerListener> mConnectedProducerListener;</p>
<pre><code>BufferQueueDefs::SlotsType mSlots;
Fifo mQueue;
...
</code></pre>
<p>}</p>
<ul>
<li><code>mQueue</code><br>  æ˜¯ä¸€ä¸ªæ–°å»ºå…ˆå‡ºé˜Ÿåˆ—ï¼Œå­˜å‚¨äº†ä¸€é˜ŸÂ <code>BufferItem</code>Â æ•°æ®ï¼Œå³ä¸€ç»„ç¼“å­˜åŒºã€‚</li>
<li><code>mSlots</code><br>  ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜äº†Â <code>BufferSlot</code>Â æ•°æ®ï¼Œæ¯ä¸ªÂ <code>slot</code>Â ä½ç½®å¯¹åº”ä¸€ä¸ªç¼“å­˜ã€‚</li>
<li><code>mConsumerListener</code><br>  å½“å‰ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ä¸­çš„ï¼Œæ¶ˆè´¹è€…å›è°ƒæ¥å£ã€‚</li>
<li><code>mConnectedProducerListener</code><br>  å½“å‰ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ä¸­çš„ï¼Œç”Ÿäº§è€…å›è°ƒæ¥å£ã€‚</li>
</ul>
<h3 id="BufferQueueProducer-BufferQueueConsumer-ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®ç°ç±»"><a href="#BufferQueueProducer-BufferQueueConsumer-ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®ç°ç±»" class="headerlink" title="BufferQueueProducer/BufferQueueConsumerÂ ç”Ÿäº§è€… &#x2F; æ¶ˆè´¹è€…å®ç°ç±»"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#BufferQueueProducer-BufferQueueConsumer-%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E5%AE%9E%E7%8E%B0%E7%B1%BB" title="BufferQueueProducer/BufferQueueConsumer ç”Ÿäº§è€…/æ¶ˆè´¹è€…å®ç°ç±»"></a><code>BufferQueueProducer/BufferQueueConsumer</code>Â ç”Ÿäº§è€… &#x2F; æ¶ˆè´¹è€…å®ç°ç±»</h3><p><code>BufferQueueProducer</code>Â æ˜¯Â <code>IGraphicBufferConsumer</code>Â çš„å®ç°ç±»ï¼Œå®ç°äº†ç”Ÿäº§è€…å¯¹åº”çš„åŠŸèƒ½ã€‚</p>
<p>&#x2F;&#x2F; BufferQueueProducer.h<br>class BufferQueueProducer : public BnGraphicBufferProducer,<br>                            private IBinder::DeathRecipient {<br>    â€¦<br>private:<br>    â€¦<br>    sp<BufferQueueCore> mCore;<br>    &#x2F;&#x2F; This references mCore-&gt;mSlots.<br>    BufferQueueDefs::SlotsType&amp; mSlots;<br>    String8 mConsumerName;<br>    â€¦<br>    sp<Fence> mLastQueueBufferFence;<br>    Rect mLastQueuedCrop;<br>    uint32_t mLastQueuedTransform;<br>}</p>
<p><code>BufferQueueProducer</code>Â ä¸­æŒæœ‰Â <code>BufferQueueCore</code>Â å¯¹è±¡ï¼›Â <code>mSlots</code>Â æŒ‡å‘Â <code>mCore-&gt;mSlots</code>Â ï¼›åŒæ—¶ä¿æŒäº†ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ä¸­ï¼Œå¯¹åº”æ¶ˆè´¹è€…çš„åç§°ã€‚</p>
<p><code>BufferQueueConsumer</code>Â æ˜¯Â <code>IGraphicBufferConsumer</code>Â çš„å®ç°ç±»ï¼Œå®ç°äº†æ¶ˆè´¹è€…å¯¹åº”çš„åŠŸèƒ½ã€‚</p>
<p>&#x2F;&#x2F; BufferQueueConsumer.h<br>class BufferQueueConsumer : public BnGraphicBufferConsumer {<br>    â€¦<br>private:<br>    sp<BufferQueueCore> mCore;<br>    &#x2F;&#x2F; This references mCore-&gt;mSlots.<br>    BufferQueueDefs::SlotsType&amp; mSlots;<br>    String8 mConsumerName;<br>}</p>
<p><code>BufferQueueConsumer</code>Â ä¸­æŒæœ‰Â <code>BufferQueueCore</code>Â å¯¹è±¡ï¼›Â <code>mSlots</code>Â æŒ‡å‘Â <code>mCore-&gt;mSlots</code>Â ã€‚</p>
<h3 id="BufferQueue-æ¨¡å‹"><a href="#BufferQueue-æ¨¡å‹" class="headerlink" title="BufferQueueÂ æ¨¡å‹"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#BufferQueue-%E6%A8%A1%E5%9E%8B" title="BufferQueue æ¨¡å‹"></a><code>BufferQueue</code>Â æ¨¡å‹</h3><p><code>BufferQueue</code>Â ç±»æ˜¯Â <code>Android</code>Â ä¸­æ‰€æœ‰å›¾å½¢å¤„ç†æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„ä½œç”¨å¾ˆç®€å•ï¼šå°†ç”Ÿæˆå›¾å½¢æ•°æ®ç¼“å†²åŒºçš„ä¸€æ–¹ï¼ˆç”Ÿäº§è€…ï¼‰è¿æ¥åˆ°æ¥å—æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºæˆ–è¿›ä¸€æ­¥å¤„ç†çš„ä¸€æ–¹ï¼ˆæ¶ˆè´¹è€…ï¼‰ã€‚å‡ ä¹æ‰€æœ‰åœ¨ç³»ç»Ÿä¸­ç§»åŠ¨å›¾å½¢æ•°æ®ç¼“å†²åŒºçš„å†…å®¹éƒ½ä¾èµ–äºÂ <code>BufferQueue</code>Â ã€‚<br>åŸºæœ¬ç”¨æ³•å¾ˆç®€å•ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€ä¸ªå¯ç”¨çš„ç¼“å†²åŒºÂ <code>dequeueBuffer</code>Â ï¼Œå¹¶æŒ‡å®šä¸€ç»„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å®½åº¦ã€é«˜åº¦ã€åƒç´ æ ¼å¼å’Œç”¨æ³•æ ‡è®°ï¼›ç”Ÿäº§è€…å¡«å……ç¼“å†²åŒºå¹¶å°†å…¶è¿”å›åˆ°é˜Ÿåˆ—Â <code>queueBuffer</code>Â ã€‚éšåæ¶ˆè´¹è€…è·å–è¯¥ç¼“å†²åŒºÂ <code>acquireBuffer</code>Â ï¼Œå¹¶ä½¿ç”¨è¯¥ç¼“å†²åŒºçš„å†…å®¹ã€‚å½“æ¶ˆè´¹è€…æ“ä½œå®Œæ¯•åï¼Œå°†è¯¥ç¼“å†²åŒºè¿”å›åˆ°é˜Ÿåˆ—Â <code>releaseBuffer</code>Â ã€‚<br>æœ€æ–°çš„ Android è®¾å¤‡æ”¯æŒ â€œåŒæ­¥æ¡†æ¶â€ï¼Œè¿™ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿåœ¨ä¸å¯ä»¥å¼‚æ­¥å¤„ç†å›¾å½¢æ•°æ®çš„ç¡¬ä»¶ç»„ä»¶ç»“åˆä½¿ç”¨æ—¶æé«˜å·¥ä½œæ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œç”Ÿäº§è€…å¯ä»¥æäº¤ä¸€ç³»åˆ—Â <code>OpenGL ES</code>Â ç»˜åˆ¶å‘½ä»¤ï¼Œç„¶ååœ¨æ¸²æŸ“å®Œæˆä¹‹å‰å°†è¾“å‡ºç¼“å†²åŒºåŠ å…¥é˜Ÿåˆ—ã€‚è¯¥ç¼“å†²åŒºä¼´æœ‰ä¸€ä¸ªæ …æ ï¼Œå½“å†…å®¹å‡†å¤‡å°±ç»ªæ—¶ï¼Œæ …æ ä¼šå‘å‡ºä¿¡å·ã€‚å½“è¯¥ç¼“å†²åŒºè¿”å›åˆ°ç©ºé—²åˆ—è¡¨æ—¶ï¼Œä¼šä¼´æœ‰ç¬¬äºŒä¸ªæ …æ ï¼Œå› æ­¤æ¶ˆè´¹è€…å¯ä»¥åœ¨å†…å®¹ä»åœ¨ä½¿ç”¨æœŸé—´é‡Šæ”¾è¯¥ç¼“å†²åŒºã€‚è¯¥æ–¹æ³•ç¼©çŸ­äº†ç¼“å†²åŒºé€šè¿‡ç³»ç»Ÿæ—¶çš„å»¶è¿Ÿæ—¶é—´ï¼Œå¹¶æé«˜äº†ååé‡ã€‚<br>é˜Ÿåˆ—çš„ä¸€äº›ç‰¹æ€§ï¼ˆä¾‹å¦‚å¯ä»¥å®¹çº³çš„æœ€å¤§ç¼“å†²åŒºæ•°ï¼‰ç”±ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è”åˆå†³å®šã€‚ä½†æ˜¯Â <code>BufferQueue</code>Â è´Ÿè´£æ ¹æ®éœ€è¦åˆ†é…ç¼“å†²åŒºã€‚é™¤éç‰¹æ€§å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™å°†ä¼šä¿ç•™ç¼“å†²åŒºï¼›ä¾‹å¦‚ï¼Œå¦‚æœç”Ÿäº§è€…è¯·æ±‚å…·æœ‰ä¸åŒå¤§å°çš„ç¼“å†²åŒºï¼Œåˆ™ç³»ç»Ÿä¼šé‡Šæ”¾æ—§çš„ç¼“å†²åŒºï¼Œå¹¶æ ¹æ®éœ€è¦åˆ†é…æ–°çš„ç¼“å†²åŒºã€‚<br>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥å­˜åœ¨äºä¸åŒçš„è¿›ç¨‹ä¸­ï¼›Â <code>BufferQueue</code>Â æ°¸è¿œä¸ä¼šå¤åˆ¶ç¼“å†²åŒºå†…å®¹ï¼ˆç§»åŠ¨å¦‚æ­¤å¤šçš„æ•°æ®æ˜¯éå¸¸ä½æ•ˆçš„æ“ä½œï¼‰ï¼Œç¼“å†²åŒºå§‹ç»ˆé€šè¿‡å¥æŸ„è¿›è¡Œä¼ é€’ã€‚</p>
<p>&#x2F;&#x2F; BufferQueue.h<br>class BufferQueue {<br>public:<br>    â€¦<br>    typedef ::android::ConsumerListener ConsumerListener;</p>
<pre><code>// ProxyConsumerListener æ˜¯ ConsumerListener å¼±å¼•ç”¨å®ç°
class ProxyConsumerListener : public BnConsumerListener &#123;
public:
    explicit ProxyConsumerListener(const wp&lt;ConsumerListener&gt;&amp; 
        consumerListener);
    ~ProxyConsumerListener() override;
    void onDisconnect() override;
    void onFrameAvailable(const BufferItem&amp; item) override;
    void onFrameReplaced(const BufferItem&amp; item) override;
    void onBuffersReleased() override;
    void onSidebandStreamChanged() override;
    void addAndGetFrameTimestamps(
            const NewFrameEventsEntry* newTimestamps,
            FrameEventHistoryDelta* outDelta) override;
private:
    // å¼±å¼•ç”¨
    wp&lt;ConsumerListener&gt; mConsumerListener;
&#125;;

// BufferQueue manages a pool of gralloc memory slots to be used by
// producers and consumers. allocator is used to allocate all the
// needed gralloc buffers.
static void createBufferQueue(
        sp&lt;IGraphicBufferProducer&gt;* outProducer,
        sp&lt;IGraphicBufferConsumer&gt;* outConsumer,
        bool consumerIsSurfaceFlinger = false);

BufferQueue() = delete; // Create through createBufferQueue
</code></pre>
<p>};</p>
<p><code>BufferQueue</code>Â çš„å¤´æ–‡ä»¶å®šä¹‰å¾ˆç®€å•ï¼š</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ªÂ <code>ConsumerListener</code>Â çš„å¼±å¼•ç”¨</li>
<li>æ•´ä¸ªç±»åªæœ‰ä¸€ä¸ªå‡½æ•°Â <code>createBufferQueue</code>Â ï¼Œå®ƒå°†å‚æ•°ä¸­çš„Â <code>IGraphicBufferProducer, IGraphicBufferConsumer</code>Â æ¶ˆè´¹è€…å…³è”èµ·æ¥</li>
<li>æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œåªèƒ½é€šè¿‡Â <code>createBufferQueue</code>Â æ¥åˆ›å»ºå¯¹è±¡</li>
<li><code>BufferQueue</code>Â ä¸­å¹¶ä¸åŒ…å«é˜Ÿåˆ—æ•°æ®ç»“æ„æ¥å­˜å‚¨ç¼“å­˜ï¼Œä»…ä»…è¿æ¥äº†ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ä¸¤è€…çš„å…³ç³»</li>
</ul>
<p>æ¥çœ‹Â <code>createBufferQueue</code>Â çš„å…·ä½“å®ç°ï¼š</p>
<p>&#x2F;&#x2F; BufferQueue.cp<br>void BufferQueue::createBufferQueue(<br>        sp<IGraphicBufferProducer>* outProducer,<br>        sp<IGraphicBufferConsumer>* outConsumer,<br>        bool consumerIsSurfaceFlinger) {<br>    â€¦<br>    sp<BufferQueueCore> core(new BufferQueueCore());<br>    sp<IGraphicBufferProducer> producer(<br>        new BufferQueueProducer(core, consumerIsSurfaceFlinger));<br>    â€¦<br>    sp<IGraphicBufferConsumer> consumer(new BufferQueueConsumer(core));<br>    â€¦<br>    *outProducer &#x3D; producer;<br>    *outConsumer &#x3D; consumer;<br>}</p>
<p>ä¸Šé¢ä»£ç åˆ æ‰äº†Â <code>LOG</code>Â æ‰“å°åŠç©ºåˆ¤æ–­ï¼Œæ•´ä¸ªä»£ç æµç¨‹éå¸¸ç®€å•ï¼š</p>
<ul>
<li>æ–°å»ºÂ <code>BufferQueueCore core</code></li>
<li>ç”±Â <code>core</code>Â æ–°å»ºç”Ÿäº§è€…Â <code>IGraphicBufferProducer</code></li>
<li>ç”±Â <code>core</code>Â æ–°å»ºæ¶ˆè´¹è€…Â <code>IGraphicBufferConsumer</code></li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´Â <code>BufferQueueCore</code>Â æ˜¯æœ€ç»ˆçš„çº½å¸¦ï¼Œä¿å­˜äº†ç”Ÿäº§è€…æ¶ˆè´¹è€…å¯¹åº”çš„ç¼“å­˜åŒºï¼Œè¿æ¥äº†ä¸¤è€…çš„å…³ç³»ã€‚</p>
<h3 id="Surface-1"><a href="#Surface-1" class="headerlink" title="Surface"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#Surface-1" title="Surface"></a><code>Surface</code></h3><p><code>Surface</code>Â ä»£è¡¨ç€çª—å£ï¼Œå®ƒåŒ…å«ä¸€ä¸ªç”Ÿäº§è€…Â <code>IGraphicBufferProducer</code>Â ç”¨æ¥å¡«å……ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯çª—å£ä¸­ç”¨æ¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å†…å®¹ï¼Œ<code>mSlot</code>Â æ•°ç»„è¡¨ç¤ºå¯ä»¥æœ‰å¤šä¸ªç¼“å­˜åŒºã€‚</p>
<p>&#x2F;&#x2F; Surface.h<br>class Surface<br>    : public ANativeObjectBase&lt;ANativeWindow, Surface, RefBase&gt;<br>{<br>public:<br>    â€¦<br>    sp<IGraphicBufferProducer> getIGraphicBufferProducer() const;<br>    String8 getConsumerName() const;<br>    â€¦<br>protected:<br>    â€¦<br>    struct BufferSlot {<br>        sp<GraphicBuffer> buffer;<br>        Region dirtyRegion;<br>    };<br>    sp<IGraphicBufferProducer> mGraphicBufferProducer;<br>    BufferSlot mSlots[NUM_BUFFER_SLOTS];<br>    uint32_t mReqWidth;<br>    uint32_t mReqHeight;<br>    PixelFormat mReqFormat;<br>    â€¦<br>    &#x2F;&#x2F; must be used from the lock&#x2F;unlock thread<br>    sp<GraphicBuffer>           mLockedBuffer;<br>    sp<GraphicBuffer>           mPostedBuffer;<br>    â€¦<br>private:<br>    â€¦<br>}</p>
<h3 id="ISurfaceComposer-ISurfaceComposerClient"><a href="#ISurfaceComposer-ISurfaceComposerClient" class="headerlink" title="ISurfaceComposer/ISurfaceComposerClient"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#ISurfaceComposer-ISurfaceComposerClient" title="ISurfaceComposer/ISurfaceComposerClient"></a><code>ISurfaceComposer/ISurfaceComposerClient</code></h3><p><code>ISurfaceComposerClient/ISurfaceComposer</code>Â éƒ½ç»§æ‰¿äº†Â <code>IInterface</code>Â ï¼Œå®ƒä»¬ä¿©åˆ†åˆ«ä»£è¡¨Â <code>Surface</code>Â åˆæˆçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œå…·ä½“åœ¨Â <code>SurfaceFlinger</code>Â æœåŠ¡è¿›ç¨‹ä¸­å®ç°ï¼ŒÂ <code>libgui</code>Â ä¸­åªå¯¹åˆæˆèƒ½åŠ›ï¼ˆå‡½æ•°ï¼‰åšäº†å®šä¹‰ã€‚</p>
<p>&#x2F;&#x2F; ISurfaceComposerClient.h<br>class ISurfaceComposerClient : public IInterface {<br>public:<br>    DECLARE_META_INTERFACE(SurfaceComposerClient)<br>    â€¦<br>    virtual status_t createSurface(const String8&amp; name, uint32_t w,<br>        uint32_t h, PixelFormat format, uint32_t flags,<br>        const sp<IBinder>&amp; parent, uint32_t windowType,<br>        uint32_t ownerUid, sp<IBinder>* handle,<br>        sp<IGraphicBufferProducer>* gbp) &#x3D; 0;<br>    virtual status_t destroySurface(const sp<IBinder>&amp; handle) &#x3D; 0;<br>    virtual status_t clearLayerFrameStats(const sp<IBinder>&amp; handle)<br>        const &#x3D; 0;<br>    virtual status_t getLayerFrameStats(const sp<IBinder>&amp; handle,<br>        FrameStats* outStats) const &#x3D; 0;<br>};</p>
<p>&#x2F;&#x2F; ISurfaceComposer.h<br>class ISurfaceComposer: public IInterface {<br>public:<br>    DECLARE_META_INTERFACE(SurfaceComposer)<br>    â€¦<br>    virtual sp<ISurfaceComposerClient> createConnection() &#x3D; 0;<br>    virtual sp<ISurfaceComposerClient> createScopedConnection(<br>            const sp<IGraphicBufferProducer>&amp; parent) &#x3D; 0;<br>    virtual sp<IDisplayEventConnection> createDisplayEventConnection(<br>            VsyncSource vsyncSource &#x3D; eVsyncSourceApp) &#x3D; 0;<br>    virtual sp<IBinder> createDisplay(const String8&amp; displayName,<br>            bool secure) &#x3D; 0;<br>    virtual void destroyDisplay(const sp<IBinder>&amp; display) &#x3D; 0;<br>    â€¦<br>    virtual status_t captureScreen(const sp<IBinder>&amp; display,<br>            const sp<IGraphicBufferProducer>&amp; producer,<br>            Rect sourceCrop, uint32_t reqWidth, uint32_t reqHeight,<br>            int32_t minLayerZ, int32_t maxLayerZ,<br>            bool useIdentityTransform,<br>            Rotation rotation &#x3D; eRotateNone) &#x3D; 0;<br>}</p>
<p>å¦‚ä¸‹æ˜¯Â <code>ISurfaceComposerClient</code>Â ç›¸å…³çš„ç±»å›¾ç»“æ„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/01113-android-graphics-display-ISurfaceComposerClient.png"></p>
<p>å…ˆçœ‹Â <code>ComposerService</code>Â ï¼Œå®ƒä»£è¡¨ç€Â <code>SurfaceFlinger</code>Â æœåŠ¡ç«¯ï¼Œå¤´æ–‡ä»¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>&#x2F;&#x2F; ComposerService.h<br>class ComposerService : public Singleton<ComposerService><br>{<br>    sp<ISurfaceComposer> mComposerService;<br>    sp<a href="IBinder::DeathRecipient">IBinder::DeathRecipient</a> mDeathObserver;<br>    Mutex mLock;</p>
<pre><code>ComposerService();
void connectLocked();
void composerServiceDied();
friend class Singleton&lt;ComposerService&gt;;
</code></pre>
<p>public:</p>
<pre><code>// Get a connection to the Composer Service.  This will block until
// a connection is established.
static sp&lt;ISurfaceComposer&gt; getComposerService();
</code></pre>
<p>};</p>
<p>æŸ¥çœ‹Â <code>connectLocked, getComposerService</code>Â ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š</p>
<p>&#x2F;&#x2F; SurfaceComposerClient.cpp<br>void ComposerService::connectLocked() {<br>    const String16 name(â€œSurfaceFlingerâ€);<br>    while (getService(name, &amp;mComposerService) !&#x3D; NO_ERROR) {<br>        usleep(250000);<br>    }<br>    assert(mComposerService !&#x3D; NULL);<br>    â€¦<br>}</p>
<p>&#x2F;<em>static</em>&#x2F; sp<ISurfaceComposer> ComposerService::getComposerService() {<br>    ComposerService&amp; instance &#x3D; ComposerService::getInstance();<br>    Mutex::Autolock _l(instance.mLock);<br>    if (instance.mComposerService &#x3D;&#x3D; NULL) {<br>        ComposerService::getInstance().connectLocked();<br>        assert(instance.mComposerService !&#x3D; NULL);<br>        ALOGD(â€œComposerService reconnectedâ€);<br>    }<br>    return instance.mComposerService;<br>}</p>
<p><code>connectLocked</code>Â è¿æ¥è¿‡ç¨‹å°±æ˜¯ç­‰å¾…Â <code>SurfaceFlinger</code>Â æœåŠ¡å¯åŠ¨åå¹¶è·å–å®ƒï¼›Â <code>getComposerService</code>Â ç›´æ¥è¿”å›å·²ç»è¿æ¥æˆåŠŸçš„å®ä¾‹Â <code>mComposerService</code>Â ã€‚</p>
<p>å†çœ‹Â <code>SurfaceComposerClient</code>Â ï¼Œå¯ä»¥å°†å®ƒç†è§£ä¸ºåº”ç”¨ç«¯ï¼Œæ˜¯Â <code>SurfaceFlinger</code>Â æœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œå®ƒå°†å»ºç«‹å’ŒÂ <code>SurfaceFlinger</code>Â æœåŠ¡çš„é€šä¿¡ï¼Œå¤´æ–‡ä»¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>&#x2F;&#x2F; SurfaceComposerClient.h<br>class SurfaceComposerClient : public RefBase<br>{<br>public:<br>    &#x2F;&#x2F; Return the connection of this client<br>    sp<IBinder> connection() const;<br>    â€¦<br>    &#x2F;&#x2F;! Create a surface<br>    sp<SurfaceControl> createSurface(<br>            const String8&amp; name,&#x2F;&#x2F; name of the surface<br>            uint32_t w,         &#x2F;&#x2F; width in pixel<br>            uint32_t h,         &#x2F;&#x2F; height in pixel<br>            PixelFormat format, &#x2F;&#x2F; pixel-format desired<br>            uint32_t flags &#x3D; 0, &#x2F;&#x2F; usage flags<br>            SurfaceControl* parent &#x3D; nullptr, &#x2F;&#x2F; parent<br>            uint32_t windowType &#x3D; 0,<br>            uint32_t ownerUid &#x3D; 0 &#x2F;&#x2F; UID of the task<br>    );<br>    status_t    destroySurface(const sp<IBinder>&amp; id);</p>
<pre><code>//! Create a virtual display
static sp&lt;IBinder&gt; createDisplay(const String8&amp; displayName,
    bool secure);
//! Destroy a virtual display
static void destroyDisplay(const sp&lt;IBinder&gt;&amp; display);
...
</code></pre>
<p>private:<br>    virtual void onFirstRef();<br>    Composer&amp; getComposer();<br>    â€¦<br>    sp<ISurfaceComposerClient>  mClient;<br>    Composer&amp;                   mComposer;<br>    wp<IGraphicBufferProducer>  mParent;<br>};</p>
<p><code>mClient</code>Â å®é™…å¯¹åº”çš„æ˜¯Â <code>SurfaceFlinger</code>Â è¿›ç¨‹ä¸­çš„Â <code>Client.cpp</code>Â ï¼ŒæŸ¥çœ‹Â <code>SurfaceComposerClient::onFirstRef</code>Â æºç ï¼š</p>
<p>&#x2F;&#x2F; SurfaceComposerClient.cpp<br>void SurfaceComposerClient::onFirstRef() {<br>    sp<ISurfaceComposer> sm(ComposerService::getComposerService());<br>    if (sm !&#x3D; 0) {<br>        auto rootProducer &#x3D; mParent.promote();<br>        sp<ISurfaceComposerClient> conn;<br>        conn &#x3D; (rootProducer !&#x3D; nullptr) ?<br>                sm-&gt;createScopedConnection(rootProducer) :<br>                sm-&gt;createConnection();<br>        if (conn !&#x3D; 0) {<br>            mClient &#x3D; conn;<br>            mStatus &#x3D; NO_ERROR;<br>        }<br>    }<br>}</p>
<p>&#x2F;&#x2F; SurfaceFlinger.cpp<br>sp<ISurfaceComposerClient> SurfaceFlinger::createScopedConnection(<br>        const sp<IGraphicBufferProducer>&amp; gbp) {<br>    if (authenticateSurfaceTexture(gbp) &#x3D;&#x3D; false) {<br>        return nullptr;<br>    }<br>    const auto&amp; layer &#x3D; (static_cast&lt;MonitoredProducer*&gt;(<br>        gbp.get()))-&gt;getLayer();<br>    if (layer &#x3D;&#x3D; nullptr) {<br>        return nullptr;<br>    }</p>
<p>   return initClient(new Client(this, layer));<br>}</p>
<p><code>SurfaceComposerClient</code>Â ä¸­æœ‰ä¸€ä¸ªé‡è¦åŠŸèƒ½å°±æ˜¯åˆ›å»ºÂ <code>Surface</code>Â ï¼Œå¯¹åº”æºç ï¼š</p>
<p>&#x2F;&#x2F; SurfaceComposerClient.cpp<br>sp<SurfaceControl> SurfaceComposerClient::createSurface(<br>        const String8&amp; name,<br>        uint32_t w,<br>        uint32_t h,<br>        PixelFormat format,<br>        uint32_t flags,<br>        SurfaceControl* parent,<br>        uint32_t windowType,<br>        uint32_t ownerUid)<br>{<br>    sp<SurfaceControl> sur;<br>    if (mStatus &#x3D;&#x3D; NO_ERROR) {<br>        sp<IBinder> handle;<br>        sp<IBinder> parentHandle;<br>        sp<IGraphicBufferProducer> gbp;</p>
<pre><code>    if (parent != nullptr) &#123;
        parentHandle = parent-&gt;getHandle();
    &#125;
    status_t err = mClient-&gt;createSurface(name, w, h, format, 
            flags, parentHandle,
            windowType, ownerUid, &amp;handle, &amp;gbp);
    ALOGE_IF(err, &quot;SurfaceComposerClient::createSurface error..&quot;);
    if (err == NO_ERROR) &#123;
        sur = new SurfaceControl(this, handle, gbp);
    &#125;
&#125;
return sur;
</code></pre>
<p>}</p>
<p>æœ€ç»ˆä¼šè°ƒç”¨Â <code>SurfaceFlinger</code>Â ä¸­çš„Â <code>mClient</code>Â æ¥åˆ›å»ºÂ <code>Layer, IGraphicBufferProducer</code>Â ï¼›è€Œå…·ä½“çš„Â <code>Surface</code>Â åˆ™ç”±Â <code>SurfaceControl</code>Â æ¥åˆ›å»ºã€‚</p>
<h3 id="SurfaceControl"><a href="#SurfaceControl" class="headerlink" title="SurfaceControl"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#SurfaceControl" title="SurfaceControl"></a><code>SurfaceControl</code></h3><p><code>SurfaceControl</code>Â æŒæœ‰åˆ›å»ºçš„Â <code>Surface</code>Â çš„å¼ºå¼•ç”¨ï¼Œå¤´æ–‡ä»¶å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; SurfaceControl.h<br>class SurfaceControl : public RefBase<br>{<br>    â€¦<br>private:<br>    â€¦<br>    sp<SurfaceComposerClient>   mClient;<br>    sp<IBinder>                 mHandle;<br>    sp<IGraphicBufferProducer>  mGraphicBufferProducer;<br>    mutable sp<Surface>         mSurfaceData;<br>};<br>}</p>
<p><code>mHandle</code>Â æŒ‡å‘Â <code>SurfaceFlinger</code>Â åˆ›å»ºçš„Â <code>Layer</code>Â ã€‚è€ŒÂ <code>SurfaceControl::createSurface</code>Â ç›´æ¥Â <code>new</code>Â äº†ä¸€ä¸ªÂ <code>Surface</code>Â å¯¹è±¡ã€‚</p>
<p>&#x2F;&#x2F; SurfaceControl.cpp<br>sp<Surface> SurfaceControl::generateSurfaceLocked() const<br>{<br>    &#x2F;&#x2F; This surface is always consumed by SurfaceFlinger, so the<br>    &#x2F;&#x2F; producerControlledByApp value doesnâ€™t matter; using false.<br>    mSurfaceData &#x3D; new Surface(mGraphicBufferProducer, false);</p>
<pre><code>return mSurfaceData;
</code></pre>
<p>}</p>
<p>sp<Surface> SurfaceControl::createSurface() const<br>{<br>    Mutex::Autolock _l(mLock);<br>    return generateSurfaceLocked();<br>}</p>
<h3 id="IDisplayEventConnection-æ˜¾ç¤ºè¿æ¥"><a href="#IDisplayEventConnection-æ˜¾ç¤ºè¿æ¥" class="headerlink" title="IDisplayEventConnectionÂ æ˜¾ç¤ºè¿æ¥"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#IDisplayEventConnection-%E6%98%BE%E7%A4%BA%E8%BF%9E%E6%8E%A5" title="IDisplayEventConnection æ˜¾ç¤ºè¿æ¥"></a><code>IDisplayEventConnection</code>Â æ˜¾ç¤ºè¿æ¥</h3><p><code>IDisplayEventConnection</code>Â ç»§æ‰¿äº†Â <code>IInterface</code>Â ï¼Œå®¢æˆ·ç«¯Â <code>APP</code>Â é€šè¿‡å®ƒå‘æœåŠ¡ç«¯Â <code>SurfaceFlinger</code>Â å‘é€åˆ·æ–°è¯·æ±‚ã€‚</p>
<p>class IDisplayEventConnection : public IInterface {<br>public:<br>    DECLARE_META_INTERFACE(DisplayEventConnection)</p>
<pre><code>/*
 * stealReceiveChannel() returns a BitTube to receive events from. 
 *Only the receive file descriptor of outChannel will be initialized,
 * and this effectively &quot;steals&quot; the receive channel from the remote
 * end (such that the remote end can only use its send channel).
 */
virtual status_t stealReceiveChannel(gui::BitTube* outChannel) = 0;

/*
 * setVsyncRate() sets the vsync event delivery rate. 
 * A value of 1 returns every vsync event.
 * A value of 2 returns every other event, etc. 
 * A value of 0 returns no event unless
 * requestNextVsync() has been called.
 */
virtual status_t setVsyncRate(uint32_t count) = 0;

/*
 * requestNextVsync() schedules the next vsync event. 
 * It has no effect if the vsync rate is &gt; 0.
 */
virtual void requestNextVsync() = 0; // Asynchronous
</code></pre>
<p>};</p>
<p><code>IDisplayEventConnection</code>Â çš„ç±»å›¾ç»“æ„</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-create-IDisplayEventConnection.png"></p>
<p><code>IDisplayEventConnection</code>Â çš„å…·ä½“å®ç°æ˜¯åœ¨Â <code>SurfaceFlinger</code>Â è¿›ç¨‹ä¸­çš„Â <code>EventThread::Connection</code>Â ï¼›<code>DisplayEventReceiver</code>Â æŒæœ‰è¯¥å®ä¾‹ã€‚</p>
<h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%B0%8F%E7%BB%93-1" title="å°ç»“"></a>å°ç»“</h3><ul>
<li><code>libgui</code>Â ä¸­ä¸€å…±æä¾›äº† 4 ç»„Â <code>IInterface</code>Â æ¥å£ï¼šÂ <code>IGraphicBufferProducer/IProducerListener, IGraphicBufferConsumer/IConsumerListener, ISurfaceComposerClient/ISurfaceComposer, IDisplayEventConnection</code></li>
<li><code>IGraphicBufferProducer/IProducerListener</code>Â ç”Ÿäº§è€…æ¨¡å‹</li>
<li><code>IGraphicBufferConsumer/IConsumerListener</code>Â æ¶ˆè´¹è€…æ¨¡å‹</li>
<li><code>ISurfaceComposerClient/ISurfaceComposer</code>Â æä¾›åˆ›å»ºÂ <code>Surface</code>Â çš„åŠŸèƒ½ï¼ŒåŠç›¸å…³ç®¡ç†</li>
<li><code>IDisplayEventConnection</code>Â æä¾›äº†Â <code>APP</code>Â å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯Â <code>SurfaceFlinger</code>Â åˆ·æ–°çš„æ¥å£</li>
</ul>
<h2 id="SurfaceFlinger"><a href="#SurfaceFlinger" class="headerlink" title="SurfaceFlinger"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#SurfaceFlinger" title="SurfaceFlinger"></a><code>SurfaceFlinger</code></h2><h3 id="ä»£ç é€ŸæŸ¥è¡¨-1"><a href="#ä»£ç é€ŸæŸ¥è¡¨-1" class="headerlink" title="ä»£ç é€ŸæŸ¥è¡¨"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E4%BB%A3%E7%A0%81%E9%80%9F%E6%9F%A5%E8%A1%A8-1" title="ä»£ç é€ŸæŸ¥è¡¨"></a>ä»£ç é€ŸæŸ¥è¡¨</h3><p>surfaceflinger&#x2F;<br>â”œâ”€â”€ Android.bp<br>â”œâ”€â”€ Android.mk<br>â”œâ”€â”€ Barrier.h<br>â”œâ”€â”€ Client.cpp<br>â”œâ”€â”€ Client.h<br>â”œâ”€â”€ clz.h<br>â”œâ”€â”€ Colorizer.h<br>â”œâ”€â”€ DdmConnection.cpp<br>â”œâ”€â”€ DdmConnection.h<br>â”œâ”€â”€ DisplayDevice.cpp<br>â”œâ”€â”€ DisplayDevice.h<br>â”œâ”€â”€ DisplayHardware<br>â”‚Â Â  â”œâ”€â”€ ComposerHal.cpp<br>â”‚Â Â  â”œâ”€â”€ ComposerHal.h<br>â”‚Â Â  â”œâ”€â”€ DisplaySurface.h<br>â”‚Â Â  â”œâ”€â”€ FramebufferSurface.cpp<br>â”‚Â Â  â”œâ”€â”€ FramebufferSurface.h<br>â”‚Â Â  â”œâ”€â”€ HWC2.cpp<br>â”‚Â Â  â”œâ”€â”€ HWC2.h<br>â”‚Â Â  â”œâ”€â”€ HWComposerBufferCache.cpp<br>â”‚Â Â  â”œâ”€â”€ HWComposerBufferCache.h<br>â”‚Â Â  â”œâ”€â”€ HWComposer.cpp<br>â”‚Â Â  â”œâ”€â”€ HWComposer.h<br>â”‚Â Â  â”œâ”€â”€ HWComposer_hwc1.cpp<br>â”‚Â Â  â”œâ”€â”€ HWComposer_hwc1.h<br>â”‚Â Â  â”œâ”€â”€ PowerHAL.cpp<br>â”‚Â Â  â”œâ”€â”€ PowerHAL.h<br>â”‚Â Â  â”œâ”€â”€ VirtualDisplaySurface.cpp<br>â”‚Â Â  â””â”€â”€ VirtualDisplaySurface.h<br>â”œâ”€â”€ DisplayUtils.cpp<br>â”œâ”€â”€ DisplayUtils.h<br>â”œâ”€â”€ DispSync.cpp<br>â”œâ”€â”€ DispSync.h<br>â”œâ”€â”€ Effects<br>â”‚Â Â  â”œâ”€â”€ Daltonizer.cpp<br>â”‚Â Â  â””â”€â”€ Daltonizer.h<br>â”œâ”€â”€ EventControlThread.cpp<br>â”œâ”€â”€ EventControlThread.h<br>â”œâ”€â”€ EventLog<br>â”‚Â Â  â”œâ”€â”€ EventLog.cpp<br>â”‚Â Â  â”œâ”€â”€ EventLog.h<br>â”‚Â Â  â””â”€â”€ EventLogTags.logtags<br>â”œâ”€â”€ EventThread.cpp<br>â”œâ”€â”€ EventThread.h<br>â”œâ”€â”€ ExSurfaceFlinger<br>â”‚Â Â  â”œâ”€â”€ ExLayer.cpp<br>â”‚Â Â  â”œâ”€â”€ ExLayer.h<br>â”‚Â Â  â”œâ”€â”€ ExSurfaceFlinger.cpp<br>â”‚Â Â  â”œâ”€â”€ ExSurfaceFlinger.h<br>â”‚Â Â  â”œâ”€â”€ ExVirtualDisplaySurface.cpp<br>â”‚Â Â  â””â”€â”€ ExVirtualDisplaySurface.h<br>â”œâ”€â”€ FrameTracker.cpp<br>â”œâ”€â”€ FrameTracker.h<br>â”œâ”€â”€ GpuService.cpp<br>â”œâ”€â”€ GpuService.h<br>â”œâ”€â”€ Layer.cpp<br>â”œâ”€â”€ LayerDim.cpp<br>â”œâ”€â”€ LayerDim.h<br>â”œâ”€â”€ Layer.h<br>â”œâ”€â”€ LayerRejecter.cpp<br>â”œâ”€â”€ LayerRejecter.h<br>â”œâ”€â”€ LayerVector.cpp<br>â”œâ”€â”€ LayerVector.h<br>â”œâ”€â”€ main_surfaceflinger.cpp<br>â”œâ”€â”€ MessageQueue.cpp<br>â”œâ”€â”€ MessageQueue.h<br>â”œâ”€â”€ MODULE_LICENSE_APACHE2<br>â”œâ”€â”€ MonitoredProducer.cpp<br>â”œâ”€â”€ MonitoredProducer.h<br>â”œâ”€â”€ RenderEngine<br>â”‚Â Â  â”œâ”€â”€ Description.cpp<br>â”‚Â Â  â”œâ”€â”€ Description.h<br>â”‚Â Â  â”œâ”€â”€ GLES20RenderEngine.cpp<br>â”‚Â Â  â”œâ”€â”€ GLES20RenderEngine.h<br>â”‚Â Â  â”œâ”€â”€ GLExtensions.cpp<br>â”‚Â Â  â”œâ”€â”€ GLExtensions.h<br>â”‚Â Â  â”œâ”€â”€ Mesh.cpp<br>â”‚Â Â  â”œâ”€â”€ Mesh.h<br>â”‚Â Â  â”œâ”€â”€ ProgramCache.cpp<br>â”‚Â Â  â”œâ”€â”€ ProgramCache.h<br>â”‚Â Â  â”œâ”€â”€ Program.cpp<br>â”‚Â Â  â”œâ”€â”€ Program.h<br>â”‚Â Â  â”œâ”€â”€ RenderEngine.cpp<br>â”‚Â Â  â”œâ”€â”€ RenderEngine.h<br>â”‚Â Â  â”œâ”€â”€ Texture.cpp<br>â”‚Â Â  â””â”€â”€ Texture.h<br>â”œâ”€â”€ StartPropertySetThread.cpp<br>â”œâ”€â”€ StartPropertySetThread.h<br>â”œâ”€â”€ SurfaceFlingerConsumer.cpp<br>â”œâ”€â”€ SurfaceFlingerConsumer.h<br>â”œâ”€â”€ SurfaceFlinger.cpp<br>â”œâ”€â”€ SurfaceFlinger.h<br>â”œâ”€â”€ SurfaceFlinger_hwc1.cpp<br>â”œâ”€â”€ surfaceflinger.rc<br>â”œâ”€â”€ SurfaceInterceptor.cpp<br>â”œâ”€â”€ SurfaceInterceptor.h<br>â”œâ”€â”€ Transform.cpp<br>â””â”€â”€ Transform.h</p>
<p>9 directories, 117 files</p>
<h3 id="surfaceflinger-è¿›ç¨‹"><a href="#surfaceflinger-è¿›ç¨‹" class="headerlink" title="surfaceflingerÂ è¿›ç¨‹"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#surfaceflinger-%E8%BF%9B%E7%A8%8B" title="surfaceflinger è¿›ç¨‹"></a><code>surfaceflinger</code>Â è¿›ç¨‹</h3><p><code>SurfaceFlinger</code>Â æ˜¯ä»¥ç‹¬ç«‹è¿›ç¨‹è¿è¡Œçš„ï¼Œè¿›ç¨‹åä¸ºÂ <code>surfaceflinger</code>Â ï¼Œå¯¹åº”çš„Â <code>rc</code>Â æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<p>&#x2F;&#x2F; surfaceflinger.rc<br>service surfaceflinger &#x2F;system&#x2F;bin&#x2F;surfaceflinger<br>    class core animation<br>    user system<br>    group graphics drmrpc readproc<br>    onrestart restart zygote<br>    writepid &#x2F;dev&#x2F;stune&#x2F;foreground&#x2F;tasks<br>    socket pdx&#x2F;system&#x2F;vr&#x2F;display&#x2F;client     stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0<br>    socket pdx&#x2F;system&#x2F;vr&#x2F;display&#x2F;manager    stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0<br>    socket pdx&#x2F;system&#x2F;vr&#x2F;display&#x2F;vsync      stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0</p>
<p><code>surfaceflinger</code>Â æœåŠ¡å±äºæ ¸å¿ƒç±»Â <code>core</code>ï¼Œå½“Â <code>surfaceflinger</code>Â é‡å¯æ—¶ä¼šè§¦å‘Â <code>zygote</code>Â çš„é‡å¯ã€‚æ¥ä¸‹æ¥çœ‹è¿›ç¨‹Â <code>main</code>Â æ–¹æ³•å¯¹åº”æ–‡ä»¶ä¸ºï¼š</p>
<p>&#x2F;&#x2F; main_surfaceflinger.cpp<br>int main(int, char**) {<br>    &#x2F;&#x2F; å¯åŠ¨ IAllocator, DisplayService ä¸¤ä¸ªæœåŠ¡<br>    startHidlServices();</p>
<pre><code>signal(SIGPIPE, SIG_IGN);

ProcessState::self()-&gt;setThreadPoolMaxThreadCount(4);
sp&lt;ProcessState&gt; ps(ProcessState::self());
ps-&gt;startThreadPool();

// 1. new SurfaceFlinger å®ä¾‹
sp&lt;SurfaceFlinger&gt; flinger = 
    DisplayUtils::getInstance()-&gt;getSFInstance();

setpriority(PRIO_PROCESS, 0, PRIORITY_URGENT_DISPLAY);
set_sched_policy(0, SP_FOREGROUND);
if (cpusets_enabled()) set_cpuset_policy(0, SP_SYSTEM);

// 2. SurfaceFlinger åˆå§‹åŒ–
flinger-&gt;init();

// 3. å‘å¸ƒ SurfaceFlinger, GpuService ä¸¤ä¸ªæœåŠ¡
// publish surface flinger
sp&lt;IServiceManager&gt; sm(defaultServiceManager());
sm-&gt;addService(String16(SurfaceFlinger::getServiceName()), 
    flinger, false);

// publish GpuService
sp&lt;GpuService&gt; gpuservice = new GpuService();
sm-&gt;addService(String16(GpuService::SERVICE_NAME),gpuservice,false);

struct sched_param param = &#123;0&#125;;
param.sched_priority = 2;
if (sched_setscheduler(0, SCHED_FIFO, Â¶m) != 0) &#123;
    ALOGE(&quot;Couldn&#39;t set SCHED_FIFO&quot;);
&#125;

// run surface flinger in this thread
// 4. SurfaceFlinger æ— é™å¾ªç¯ç­‰å¾…äº‹ä»¶
flinger-&gt;run();

return 0;
</code></pre>
<p>}</p>
<p><code>surfaceflinger</code>Â è¿›ç¨‹çš„Â <code>main</code>Â å‡½æ•°ä¸­ä¸»è¦åšäº† 4 ä»¶äº‹ï¼š</p>
<ul>
<li>é€šè¿‡Â <code>DisplayUtils</code>Â åˆ›å»ºÂ <code>SurfaceFlinger</code>Â å¯¹è±¡</li>
<li><code>SurfaceFlinger</code>Â å¯¹è±¡è°ƒç”¨Â <code>init</code>Â æ–¹æ³•ï¼Œå®ç°åˆå§‹åŒ–</li>
<li><code>SurfaceFlinger</code>Â å‘ç³»ç»Ÿæ³¨å†ŒÂ <code>Binder</code>Â æœåŠ¡</li>
<li><code>SurfaceFlinger</code>Â å¯¹è±¡è°ƒç”¨Â <code>run</code>Â æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªÂ <code>do-while</code>Â æ— é™å¾ªç¯</li>
</ul>
<h3 id="åˆå§‹åŒ–æµç¨‹"><a href="#åˆå§‹åŒ–æµç¨‹" class="headerlink" title="åˆå§‹åŒ–æµç¨‹"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B" title="åˆå§‹åŒ–æµç¨‹"></a>åˆå§‹åŒ–æµç¨‹</h3><p><a target="_blank" rel="noopener" href="https://upload-images.jianshu.io/upload_images/606437-92984e2a12a8b3d0.png">SurfaceFlinger åˆå§‹åŒ–æµç¨‹ï¼ŒæŸ¥çœ‹å¤§å›¾</a></p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-SurfaceFlinger-init.png"></p>
<h3 id="DisplayDevice-æ˜¾ç¤ºè®¾å¤‡"><a href="#DisplayDevice-æ˜¾ç¤ºè®¾å¤‡" class="headerlink" title="DisplayDeviceÂ æ˜¾ç¤ºè®¾å¤‡"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#DisplayDevice-%E6%98%BE%E7%A4%BA%E8%AE%BE%E5%A4%87" title="DisplayDevice æ˜¾ç¤ºè®¾å¤‡"></a><code>DisplayDevice</code>Â æ˜¾ç¤ºè®¾å¤‡</h3><p>&#x2F;&#x2F; DisplayDevice.h<br>class DisplayDevice : public LightRefBase<DisplayDevice><br>{<br>public:<br>    â€¦<br>    enum DisplayType {<br>        DISPLAY_ID_INVALID &#x3D; -1,<br>        DISPLAY_PRIMARY     &#x3D; HWC_DISPLAY_PRIMARY,      &#x2F;&#x2F; ä¸»æ˜¾<br>        DISPLAY_EXTERNAL    &#x3D; HWC_DISPLAY_EXTERNAL,     &#x2F;&#x2F; å¤–æ˜¾<br>        DISPLAY_VIRTUAL     &#x3D; HWC_DISPLAY_VIRTUAL,      &#x2F;&#x2F; è™šæ˜¾<br>        NUM_BUILTIN_DISPLAY_TYPES &#x3D; HWC_NUM_PHYSICAL_DISPLAY_TYPES,<br>    };<br>    â€¦<br>}</p>
<p>æ˜¾ç¤ºè®¾å¤‡æœ‰ä¸‰ç§ç±»å‹ï¼šä¸»æ˜¾ã€å¤–æ˜¾ã€è™šæ˜¾ï¼›æ¯æ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºå±ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªÂ <code>DisplayDevice</code>Â ã€‚</p>
<h3 id="Layer-å±‚"><a href="#Layer-å±‚" class="headerlink" title="LayerÂ å±‚"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#Layer-%E5%B1%82" title="Layer å±‚"></a><code>Layer</code>Â å±‚</h3><p><code>Layer</code>Â æ˜¯Â <code>SurfaceFlinger</code>Â è¿›è¡Œåˆæˆçš„åŸºæœ¬æ“ä½œå•å…ƒã€‚<code>Layer</code>Â åœ¨åº”ç”¨è¯·æ±‚åˆ›å»ºÂ <code>Surface</code>Â çš„æ—¶å€™åœ¨Â <code>SurfaceFlinger</code>Â å†…éƒ¨åˆ›å»ºï¼Œå› æ­¤ä¸€ä¸ªÂ <code>Surface</code>Â å¯¹åº”ä¸€ä¸ªÂ <code>Layer</code>Â ã€‚æ¯ä¸ªÂ <code>Layer</code>Â åŒ…å«å¸¸è§å±æ€§ï¼š</p>
<ul>
<li><code>Z order</code></li>
<li><code>Alpha value from 0 to 255</code></li>
<li><code>visibleRegion</code></li>
<li><code>crop region</code></li>
<li><code>transformation: rotate 0, 90, 180, 270: flip H, V: scale</code></li>
</ul>
<p>å½“å¤šä¸ªÂ <code>Layer</code>Â è¿›è¡Œåˆæˆçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯æ•´ä¸ªÂ <code>Layer</code>Â çš„ç©ºé—´éƒ½ä¼šè¢«å®Œå…¨æ˜¾ç¤ºï¼Œæ ¹æ®è¿™ä¸ªÂ <code>Layer</code>Â æœ€ç»ˆçš„æ˜¾ç¤ºæ•ˆæœï¼Œä¸€ä¸ªÂ <code>Layer</code>Â å¯ä»¥è¢«åˆ’åˆ†æˆå¾ˆå¤šçš„Â <code>Region</code>Â ï¼Œ åœ¨Â <code>SurfaceFlinger</code>Â ä¸­å®šä¹‰äº†ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p>
<ul>
<li><code>TransparantRegion</code>Â ï¼šå®Œå…¨é€æ˜çš„åŒºåŸŸï¼Œåœ¨å®ƒä¹‹ä¸‹çš„åŒºåŸŸå°†è¢«æ˜¾ç¤ºå‡ºæ¥</li>
<li><code>OpaqueRegion</code>Â ï¼šå®Œå…¨ä¸é€æ˜çš„åŒºåŸŸï¼Œæ˜¯å¦æ˜¾ç¤ºå–å†³äºå®ƒä¸Šé¢æ˜¯å¦æœ‰é®æŒ¡æˆ–æ˜¯å¦é€æ˜</li>
<li><code>VisibleRegion</code>Â ï¼šå¯è§åŒºåŸŸï¼ŒåŒ…æ‹¬å®Œå…¨ä¸é€æ˜æ— é®æŒ¡åŒºåŸŸæˆ–åŠé€æ˜åŒºåŸŸï¼›å³Â <code>visibleRegion = Region - above OpaqueRegion.</code></li>
<li><code>CoveredRegion</code>Â ï¼šè¢«é®æŒ¡åŒºåŸŸï¼Œåœ¨å®ƒä¹‹ä¸Šï¼Œæœ‰ä¸é€æ˜æˆ–åŠé€æ˜åŒºåŸŸ</li>
<li><code>DirtyRegion</code>Â ï¼šå¯è§éƒ¨åˆ†æ”¹å˜åŒºåŸŸï¼ŒåŒ…æ‹¬æ–°çš„è¢«é®æŒ¡åŒºåŸŸï¼Œå’Œæ–°çš„éœ²å‡ºåŒºåŸŸ</li>
</ul>
<p>å¤´æ–‡ä»¶å®šä¹‰ï¼š</p>
<p>&#x2F;&#x2F; Layer.h<br>class Layer : public SurfaceFlingerConsumer::ContentsChangedListener {<br>public:<br>    â€¦<br>    &#x2F;&#x2F; regions below are in window-manager space<br>    Region visibleRegion;<br>    Region coveredRegion;<br>    Region visibleNonTransparentRegion;<br>    Region surfaceDamageRegion;</p>
<pre><code>// Layer serial number.  This gives layers an explicit ordering, so we
// have a stable sort order when their layer stack and Z-order are
// the same.
int32_t sequence;
...
</code></pre>
<p>private:<br>    â€¦<br>    &#x2F;&#x2F; constants<br>    sp<SurfaceFlingerConsumer> mSurfaceFlingerConsumer;<br>    sp<IGraphicBufferProducer> mProducer;<br>    uint32_t mTextureName;      &#x2F;&#x2F; from GLES<br>    bool mPremultipliedAlpha;<br>    String8 mName;<br>    String8 mTransactionName; &#x2F;&#x2F; A cached version of â€œTX - â€œ + mName for systraces<br>    PixelFormat mFormat;<br>    â€¦<br>    FenceTimeline mAcquireTimeline;<br>    FenceTimeline mReleaseTimeline;<br>    â€¦<br>    &#x2F;&#x2F; The mesh used to draw the layer in GLES composition mode<br>    mutable Mesh mMesh;<br>    &#x2F;&#x2F; The texture used to draw the layer in GLES composition mode<br>    mutable Texture mTexture;<br>    Vector<BufferItem> mQueueItems;<br>    &#x2F;&#x2F; Child list about to be committed&#x2F;used for editing.<br>    LayerVector mCurrentChildren;<br>    &#x2F;&#x2F; Child list used for rendering.<br>    LayerVector mDrawingChildren;</p>
<pre><code>wp&lt;Layer&gt; mCurrentParent;
wp&lt;Layer&gt; mDrawingParent;
</code></pre>
<p>}</p>
<p><code>SurfaceFlinger</code>Â æ¥æ”¶æ‰€æœ‰Â <code>Surface</code>Â ä½œä¸ºè¾“å…¥ï¼Œæ ¹æ®Â <code>Z-Order</code>ï¼Œ é€æ˜åº¦ï¼Œå¤§å°ï¼Œä½ç½®ç­‰å‚æ•°ï¼Œè®¡ç®—å‡ºæ¯ä¸ªÂ <code>Surface</code>Â åœ¨æœ€ç»ˆåˆæˆå›¾åƒä¸­çš„ä½ç½®ï¼Œç„¶åäº¤ç”±Â <code>HWComposer, OpenGL</code>Â ç”Ÿæˆæœ€ç»ˆçš„æ˜¾ç¤ºÂ <code>Buffer</code>Â , ç„¶åæ˜¾ç¤ºåˆ°ç‰¹å®šçš„æ˜¾ç¤ºè®¾å¤‡ä¸Šã€‚<br><code>Layer</code>Â çš„åˆæˆåˆ†ä¸ºä¸¤ç§ï¼Œç¦»çº¿åˆæˆå’Œåœ¨çº¿åˆæˆï¼š</p>
<ul>
<li>ç¦»çº¿åˆæˆ<br>  å…ˆå°†æ‰€æœ‰å›¾å±‚ç”»åˆ°ä¸€ä¸ªæœ€ç»ˆå±‚Â <code>FrameBuffer</code>Â ä¸Šï¼Œå†å°†Â <code>FrameBuffer</code>Â é€åˆ°Â <code>LCD</code>Â æ˜¾ç¤ºã€‚ç”±äºåˆæˆÂ <code>FrameBuffer</code>Â ä¸é€Â <code>LCD</code>Â æ˜¾ç¤ºä¸€èˆ¬æ˜¯å¼‚æ­¥çš„ï¼ˆçº¿ä¸‹ç”ŸæˆÂ <code>FrameBuffer</code>Â ï¼Œéœ€è¦æ—¶çº¿ä¸Šçš„Â <code>LCD</code>Â å»å–ï¼‰ï¼Œå› æ­¤å«ç¦»çº¿åˆæˆã€‚</li>
<li>åœ¨çº¿åˆæˆ<br>  ä¸ä½¿ç”¨Â <code>FrameBuffer</code>Â ï¼Œåœ¨Â <code>LCD</code>Â éœ€è¦æ˜¾ç¤ºæŸä¸€è¡Œçš„åƒç´ æ—¶ï¼Œç”¨æ˜¾ç¤ºæ§åˆ¶å™¨å°†æ‰€æœ‰å›¾å±‚ä¸è¯¥è¡Œç›¸å…³çš„æ•°æ®å–å‡ºï¼Œåˆæˆä¸€è¡Œåƒç´ é€è¿‡å»ã€‚åªæœ‰ä¸€ä¸ªå›¾å±‚æ—¶ï¼Œåˆå«Â <code>Overlay</code>Â æŠ€æœ¯ã€‚<br>  ç”±äºçœå»åˆæˆÂ <code>FrameBuffer</code>Â æ—¶è¯»å›¾å±‚ï¼Œå†™Â <code>FrameBuffer</code>Â çš„æ­¥éª¤ï¼Œå¤§å¹…é™ä½äº†å†…å­˜ä¼ è¾“é‡ï¼Œå‡å°‘äº†åŠŸè€—ï¼Œä½†è¿™ä¸ªéœ€è¦ç¡¬ä»¶æ”¯æŒã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-layer-composer.jpg"></p>
<h3 id="Surface-åˆ›å»ºæµç¨‹å›¾"><a href="#Surface-åˆ›å»ºæµç¨‹å›¾" class="headerlink" title="SurfaceÂ åˆ›å»ºæµç¨‹å›¾"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#Surface-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE" title="Surface åˆ›å»ºæµç¨‹å›¾"></a><code>Surface</code>Â åˆ›å»ºæµç¨‹å›¾</h3><p>ç”±å®¢æˆ·ç«¯Â <code>SurfaceComposerClient</code>Â å‘èµ·åˆ›å»ºæµç¨‹ï¼Œç„¶åç”±æœåŠ¡ç«¯Â <code>SurfaceFlinger</code>Â åˆ›å»ºå¯¹åº”çš„Â <code>Layer</code>Â ï¼Œè€ŒÂ <code>Layer</code>Â åœ¨è¢«å¼•ç”¨æ—¶ä¼šåˆ›å»ºç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çš„Â <code>BufferQueue</code>Â ï¼Œç„¶åå†ç”±å®¢æˆ·ç«¯å°†æ‹¿åˆ°çš„ç»“æœä¼ å…¥Â <code>SurfaceControl</code>Â ï¼Œæœ€åç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªÂ <code>Surface</code>Â ã€‚</p>
<p>åˆ›å»ºç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹Â <code>BufferQueue</code>Â çš„å…³é”®ä»£ç ï¼š</p>
<p>&#x2F;&#x2F; Layer.cpp<br>void Layer::onFirstRef() {<br>    &#x2F;&#x2F; Creates a custom BufferQueue for SurfaceFlingerConsumer to use<br>    sp<IGraphicBufferProducer> producer;<br>    sp<IGraphicBufferConsumer> consumer;<br>    BufferQueue::createBufferQueue(&amp;producer, &amp;consumer, true);<br>    mProducer &#x3D; new MonitoredProducer(producer, mFlinger, this);<br>    mSurfaceFlingerConsumer &#x3D;<br>        new SurfaceFlingerConsumer(consumer, mTextureName, this);<br>    mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(0));<br>    mSurfaceFlingerConsumer-&gt;setContentsChangedListener(this);<br>    mSurfaceFlingerConsumer-&gt;setName(mName);</p>
<pre><code>if (mFlinger-&gt;isLayerTripleBufferingDisabled()) &#123;
    mProducer-&gt;setMaxDequeuedBufferCount(2);
&#125;

const sp&lt;const DisplayDevice&gt; hw(mFlinger-&gt;getDefaultDisplayDevice());
updateTransformHint(hw);
</code></pre>
<p>}</p>
<p><a target="_blank" rel="noopener" href="https://upload-images.jianshu.io/upload_images/606437-645921566ffd77c6.png">åˆ›å»º Surface æµç¨‹ï¼ŒæŸ¥çœ‹å¤§å›¾</a></p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-create-surface.png"></p>
<h3 id="VSYNC-å‚ç›´åˆ·æ–°-1"><a href="#VSYNC-å‚ç›´åˆ·æ–°-1" class="headerlink" title="VSYNCÂ å‚ç›´åˆ·æ–°"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#VSYNC-%E5%9E%82%E7%9B%B4%E5%88%B7%E6%96%B0-1" title="VSYNC å‚ç›´åˆ·æ–°"></a><code>VSYNC</code>Â å‚ç›´åˆ·æ–°</h3><p><code>Android</code>Â ä¸­æœ‰ 2 ç§Â <code>VSync</code>Â ä¿¡å·ï¼šå±å¹•äº§ç”Ÿçš„ç¡¬ä»¶Â <code>VSync</code>Â å’Œç”±Â <code>SurfaceFlinger</code>Â å°†å…¶è½¬æˆçš„è½¯ä»¶Â <code>Vsync</code>Â ä¿¡å·ï¼›è½¯ä»¶Â <code>Vsync</code>Â åè€…ç»ç”±Â <code>Binder</code>Â ä¼ é€’ç»™Â <code>Choreographer</code>Â ã€‚<br><code>Vsync</code>Â ä¿¡å·å¯å°†æŸäº›äº‹ä»¶åŒæ­¥åˆ°æ˜¾ç¤ºè®¾å¤‡çš„åˆ·æ–°å‘¨æœŸã€‚åº”ç”¨æ€»æ˜¯åœ¨Â <code>VSYNC</code>Â è¾¹ç•Œä¸Šå¼€å§‹ç»˜åˆ¶ï¼Œè€ŒÂ <code>SurfaceFlinger</code>Â æ€»æ˜¯åœ¨Â <code>VSYNC</code>Â è¾¹ç•Œä¸Šè¿›è¡Œåˆæˆã€‚è¿™æ ·å¯ä»¥æ¶ˆé™¤å¡é¡¿ï¼Œå¹¶æå‡å›¾å½¢çš„è§†è§‰è¡¨ç°ã€‚Â <code>HWComposer</code>Â å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ï¼Œä¼šæ³¨å†Œä¸€äº›å›è°ƒæ–¹æ³•ï¼›å½“ç¡¬ä»¶äº§ç”ŸÂ <code>VSYNC</code>Â ä¿¡å·æ—¶ï¼Œåˆ™ä¼šå›è°ƒÂ <code>HWC2::ComposerCallbackBridge::onVsync</code>Â æ–¹æ³•ï¼Œç„¶åé€çº§å›è°ƒï¼Œä¸‹å›¾æ˜¯æ•´ä¸ªå›è°ƒæµç¨‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-VsyncCallback.png"></p>
<ul>
<li>ç¡¬ä»¶Â <code>Vsync</code>Â ä¿¡å·å‘é€è¿‡æ¥ï¼Œä¸€è·¯æ‰§è¡Œåˆ°Â <code>DispSyncThread.updateModel</code>Â æ–¹æ³•ä¸­è°ƒç”¨Â <code>mCond.signal</code>Â ï¼Œå”¤é†’Â <code>DispSyncThread</code>Â çº¿ç¨‹</li>
<li><code>DispSyncThread</code>Â çº¿ç¨‹ä¸­æ‰§è¡ŒÂ <code>EventThread::onVSyncEvent</code>Â ä¸­è°ƒç”¨Â <code>mCondition.broadcast</code>Â å”¤é†’Â <code>EventThread</code>Â çº¿ç¨‹</li>
<li><code>EventThread</code>Â çº¿ç¨‹ä¸­æ‰§è¡ŒÂ <code>DisplayEventReceiver::sendEvents</code>Â æ–¹æ³•ï¼Œä¼šè°ƒç”¨Â <code>BitTube::sendObjects</code>Â ï¼›åœ¨Â <code>MessageQueue::setEventThread</code>Â ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†Â <code>BitTube</code>Â äº‹ä»¶çš„å›è°ƒï¼Œå½“æ”¶åˆ°æ•°æ®ä¼šè§¦å‘Â <code>MQ.cb_eventReceiver</code>Â ï¼›æ ¹æ®Â <code>Handler</code>Â æ¶ˆæ¯æœºåˆ¶ï¼Œè¿›å…¥Â <code>SurfaceFlinger</code>Â ä¸»çº¿ç¨‹</li>
<li><code>SurfaceFlinger</code>Â ä¸»çº¿ç¨‹è¿›å…¥åˆ°Â <code>MesageQueueçš„handleMessage</code>Â ï¼Œæœ€ç»ˆè°ƒç”¨Â <code>SurfaceFlinger::handleMessageRefresh</code></li>
</ul>
<h3 id="å®¢æˆ·ç«¯é€šçŸ¥-SurfaceFlinger-åˆ·æ–°"><a href="#å®¢æˆ·ç«¯é€šçŸ¥-SurfaceFlinger-åˆ·æ–°" class="headerlink" title="å®¢æˆ·ç«¯é€šçŸ¥Â SurfaceFlingerÂ åˆ·æ–°"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E7%9F%A5-SurfaceFlinger-%E5%88%B7%E6%96%B0" title="å®¢æˆ·ç«¯é€šçŸ¥ SurfaceFlinger åˆ·æ–°"></a>å®¢æˆ·ç«¯é€šçŸ¥Â <code>SurfaceFlinger</code>Â åˆ·æ–°</h3><p><code>BufferQueueProducer::queueBuffer</code>Â å‡½æ•°ä¸­ä¼šè°ƒç”¨Â <code>listener-&gt;onFrameAvailable</code>Â ï¼Œè€Œè¿™æœ€ç»ˆä¼šè§¦å‘æœåŠ¡ç«¯çš„Â <code>Layer::onFrameAvailable</code>Â ï¼Œä»è€Œé€šçŸ¥Â <code>SurfaceFlinger</code>Â åˆæˆå›¾åƒã€‚æˆ‘ä»¬å…ˆçœ‹Â <code>onFrameAvailable</code>Â æ¥å£çš„ç»§æ‰¿å…³ç³»ï¼š</p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-onFrameAvailable-class-uml.png"></p>
<p>ä»Â <code>Surface</code>Â åˆ›å»ºæµç¨‹ä¸­è´´å‡ºçš„Â <code>Layer::onFirstRef</code>Â ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Â <code>Layer</code>Â ä¸­è®¾ç½®äº†Â <code>mSurfaceFlingerConsumer-&gt;setContentsChangedListener</code>Â ç›‘å¬äº‹ä»¶ï¼Œæ‰€ä»¥Â <code>BufferQueueProducer::queueBuffer</code>Â ä¼šè§¦å‘Â <code>Layer::onFrameAvailable</code>Â äº‹ä»¶ï¼Œä¸‹é¢æ˜¯å®Œæ•´çš„è¯·æ±‚æµç¨‹ã€‚<br>å®¢æˆ·ç«¯åœ¨Â <code>BufferQueue</code>Â ä¸­ç”Ÿäº§å®Œå›¾åƒæ•°æ®åï¼Œé€šçŸ¥Â <code>SurfaceFlinger</code>Â åˆ·æ–°ç•Œé¢çš„æµç¨‹å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://upload-images.jianshu.io/upload_images/606437-4f8a5a419984488c.png">å®¢æˆ·ç«¯é€šçŸ¥ SurfaceFlinger åˆ·æ–°ï¼ŒæŸ¥çœ‹å¤§å›¾</a></p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0113-android-graphics-display-requestNextVsync.png"></p>
<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%90%8E%E7%BB%AD" title="åç»­"></a>åç»­</h2><ul>
<li><code>WMS</code></li>
<li><code>Layer</code>Â åˆæˆæµç¨‹</li>
<li>ç»“åˆÂ <code>Camera</code>Â ç†Ÿæ‚‰å›¾å½¢æ˜¾ç¤ºä¸­Â <code>Buffer</code>Â ç›¸å…³æµç¨‹</li>
<li><code>Choreographer</code>Â åŠæ‰å¸§åˆ†æ<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dd32ec35db1d">Choreographer ç®€æ</a></li>
</ul>
</li>
<li>è¯¦è¿°Â <code>SurfaceTexture, SurfaceView, GLSurfaceView</code>Â ç­‰åŒºåˆ«</li>
<li>å·¥å…·Â <code>dumpsys SurfaceFlinger</code>Â è¾“å‡ºçš„Â <code>LOG</code>Â åˆ†æ</li>
<li><code>screencap</code>Â å‘½ä»¤åŠæºç åˆ†æ</li>
<li><code>Systrace</code>Â æ€§èƒ½å·¥å…·åˆ†æ<ul>
<li><a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/tech/debug/systrace">Systrace å®˜ç½‘</a></li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul>
<li><a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/graphics">Android å›¾å½¢æ˜¾ç¤º - å®˜ç½‘</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ear5cm/article/details/45458683">Android ä¸­ native_handle private_handle_t çš„å…³ç³»</a></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/f92447ae8445">å¤•é˜³é£ - å›¾å½¢æ˜¾ç¤ºç³»åˆ—æ–‡ç« </a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="http://windrunnerlihuan.com/2017/04/27/Android-SurfaceFlinger-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF-%E4%BA%8C-SurfaceFlinger%E6%A6%82%E8%BF%B0/">SurfaceFlinger ç³»åˆ—</a></strong></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaizu/article/details/51882768">ç†è§£ VSYNC</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yaozhongxiao/archive/2014/07/14/3842908.html">dp, dpi, px, density çš„å…³ç³»</a></li>
<li><a target="_blank" rel="noopener" href="http://gityuan.com/2017/02/18/surface_flinger_2/">gityuan: SurfaceFlinger ç›¸å…³</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/innost/article/details/47208337">é˜¿æ‹‰ç¥å†œï¼šæ·±å…¥ç†è§£ Surface ç³»ç»Ÿ</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/freekiteyu/article/details/79483406">å›¾è§£ Surface, SurfaceFlinger å…³ç³»</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/grafika">Google Grafika</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013928208/article/details/82999075">å›¾å½¢å¼•æ“çš„æ ¸å¿ƒ - BufferQueue</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xisuzun7960/article/details/81212721">surfaceflinger æ¡†æ¶ - æµç¨‹å›¾å¤§å…¨</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/armwind/article/details/73436532">BufferQueue ä»‹ç»</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jinzhuojun/article/details/39698317/">GraphicBuffer åŒæ­¥æœºåˆ¶ - Fence</a></li>
</ul>
<p>å…¨æ–‡å®Œ</p>
<p>æœ¬æ–‡ç”±Â <a target="_blank" rel="noopener" href="http://ksria.com/simpread">ç®€æ‚¦ SimpRead</a>Â ä¼˜åŒ–ï¼Œç”¨ä»¥æå‡é˜…è¯»ä½“éªŒ</p>
<p>ä½¿ç”¨äº†Â å…¨æ–°çš„ç®€æ‚¦è¯æ³•åˆ†æå¼•æ“Â betaï¼Œ<a target="_blank" rel="noopener" href="http://ksria.com/simpread/docs/#/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E">ç‚¹å‡»æŸ¥çœ‹</a>è¯¦ç»†è¯´æ˜</p>
<p><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-0">æ¦‚å¿µ</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-1">EGL</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-2">Surface å’Œ SurfaceFlinger</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-3">WMS: WindowManagerServices</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-4">FrameBuffer</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-5">Gralloc</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-6">HWC</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-7">VSYNC å‚ç›´åˆ·æ–°</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-8">60Hz å’Œ 16 ms</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-9">BufferQueue</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-10">æ•°æ®æµ</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-11">ç»„ä»¶å°ç»“</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-12">Buffer&#x2F;Window ä½“ç³»</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-13">ä»£ç é€ŸæŸ¥è¡¨</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-14">native_handle&#x2F;buffer_handle_t</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-15">private_handle_t</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-16">ANativeWindowBuffer</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-17">ANativeWindow</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-18">ANativeObjectBase æ¨¡æ¿</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-19">GraphicBuffer</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-20">Surface</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-21">å°ç»“</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-22">libui åº“</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-23">ä»£ç ç›®å½•ç»“æ„</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-24">GraphicBufferAllocator&#x2F;GraphicBufferMapper</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-25">GraphicBuffer</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-26">Fence æœºåˆ¶</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-27">DisplayInfo æ˜¾ç¤ºä¿¡æ¯</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-28">libgui åº“</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-29">ä»£ç ç›®å½•ç»“æ„</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-30">IGraphicBufferProducer&#x2F;IProducerListener ç”Ÿäº§è€…</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-31">IGraphicBufferConsumer&#x2F;IConsumerListener æ¶ˆè´¹è€…</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-32">BufferItem</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-33">BufferSlot</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-34">BufferQueueCore</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-35">BufferQueueProducer&#x2F;BufferQueueConsumer ç”Ÿäº§è€… &#x2F; æ¶ˆè´¹è€…å®ç°ç±»</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-36">BufferQueue æ¨¡å‹</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-37">Surface</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-38">ISurfaceComposer&#x2F;ISurfaceComposerClient</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-39">SurfaceControl</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-40">IDisplayEventConnection æ˜¾ç¤ºè¿æ¥</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-41">å°ç»“</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-42">SurfaceFlinger</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-43">ä»£ç é€ŸæŸ¥è¡¨</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-44">surfaceflinger è¿›ç¨‹</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-45">åˆå§‹åŒ–æµç¨‹</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-46">DisplayDevice æ˜¾ç¤ºè®¾å¤‡</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-47">Layer å±‚</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-48">Surface åˆ›å»ºæµç¨‹å›¾</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-49">VSYNC å‚ç›´åˆ·æ–°</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-50">å®¢æˆ·ç«¯é€šçŸ¥ SurfaceFlinger åˆ·æ–°</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-51">åç»­</a><a target="_blank" rel="noopener" href="https://redspider110.github.io/2019/04/17/0113-android-graphics-display/#sr-toc-52">å‚è€ƒæ–‡æ¡£</a></p>

      </section>

      
      
        <nav class="article-nav">
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/2024/01/10/OpenGL/OpenGL/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">OpenGL</h2>
        </a>
      
      <div class="card-text--row">Newer</div>
    </div>
  </article>
</div>
          
          
        </nav>
      

      <section class="page-message-container layout-padding">
        


  
  

  
  


      </section>
    </div>
    <div class="widget-info">
      <section class="widget-author widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-body">
    
      <img src="https://github.com/BlairRenaissance/ImageHost/blob/main/WeCom20240109-193846@2x.png?raw=true" class="soft-size--round soft-style--box" alt="Renaissance">
    
    
      <h2>Renaissance</h2>
    
    
      <p>è°çš„èº«å½± å°½é€é‡æ¥¼</p>
    

    <div class="count-box">
      <div class="count-box--item">
        <svg class="icon icon-article" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M240.51564747 647.74217627h196.07203239c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806V165.10332731c0-33.18142087-30.16492806-60.32985613-60.32985612-60.32985611H245.04038668C225.43318342 104.7734712 210.35071939 119.85593522 210.35071939 139.46313845V617.57724821c0 16.59071043 13.57421762 30.16492806 30.16492808 30.16492806z m663.62841731-452.47392089v482.63884894c0 33.18142087-27.14843525 60.32985613-60.32985612 60.32985613H180.18579134c-33.18142087 0-60.32985613-27.14843525-60.32985612-60.32985613V195.26825538c-49.77213131 0-90.49478418 40.72265287-90.49478417 90.49478417v452.4739209c0 49.77213131 40.72265287 90.49478418 90.49478417 90.49478417h286.56681657c16.59071043 0 30.16492806 13.57421762 30.16492807 30.16492807s13.57421762 30.16492806 30.16492805 30.16492806h90.49478418c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806s13.57421762-30.16492806 30.16492807-30.16492807h286.56681657c49.77213131 0 90.49478418-40.72265287 90.49478417-90.49478417V285.76303955c0-49.77213131-40.72265287-90.49478418-90.49478417-90.49478417zM587.41232014 647.74217627h191.54729318c19.60720323 0 34.68966726-15.08246403 34.68966729-34.68966727V134.93839925c0-16.59071043-13.57421762-30.16492806-30.16492808-30.16492805H617.57724821c-30.16492806 0-60.32985613 27.14843525-60.32985612 60.32985611v452.4739209c0 16.59071043 13.57421762 30.16492806 30.16492805 30.16492806z" fill="currentColor"></path>
</svg>
        <span>3</span>
      </div>
      <div class="count-box--item">
        <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
        3
      </div>
      <div class="count-box--item">
        <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
        3
      </div>
    </div>
  </div>
</section>

      

      
<section class="widet-notice widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-notice" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 945.02305225v28.15620663a24.27259221 24.27259221 0 0 1-24.27259221 24.27259335H394.0352a48.54518557 48.54518557 0 0 1-41.74885888-23.78714112l-110.68302222-184.47170332a132.04290333 132.04290333 0 0 1-17.47626667-48.54518557h118.4502511a200.97706667 200.97706667 0 0 1 76.21594113 14.56355556l20.38897777 133.49925888a48.54518557 48.54518557 0 0 0 36.40888888 27.67075555l16.01991111 2.91271112a24.27259221 24.27259221 0 0 1 20.38897778 25.72894889zM997.45185223 463.45481443a194.18074112 194.18074112 0 0 1-38.8361489 116.50844445 24.75804445 24.75804445 0 0 1-36.4088889 0l-34.95253333-34.95253333a24.27259221 24.27259221 0 0 1-2.91271111-30.58346667 97.09036999 97.09036999 0 0 0 0-106.79940665 24.27259221 24.27259221 0 0 1 2.91271111-30.58346666l34.95253333-34.95253334a24.75804445 24.75804445 0 0 1 18.93262223-7.28177777 26.2144 26.2144 0 0 1 17.47626667 9.70903665A194.18074112 194.18074112 0 0 1 997.45185223 463.45481443z m-194.18074112-388.36148111v776.72296335a48.54518557 48.54518557 0 0 1-48.54518556 48.54518443h-28.64165888a48.54518557 48.54518557 0 0 1-33.98163001-14.07810332l-145.63555556-143.20829668A291.27111111 291.27111111 0 0 0 342.57730333 657.63555556H172.18370333a145.63555556 145.63555556 0 0 1-145.63555556-145.63555556v-97.09036999a145.63555556 145.63555556 0 0 1 145.63555556-145.63555556h170.3936a291.27111111 291.27111111 0 0 0 206.31703779-85.43952668l145.63555555-143.20829554a48.54518557 48.54518557 0 0 1 33.98162888-14.07810446H754.72592555a48.54518557 48.54518557 0 0 1 48.54518556 48.54518555z" fill="currentColor"></path>
</svg>
    <span>NOTICE</span>
  </div>
  <div class="widget-body">
    <p>STUDYæ¨¡å¼ï¼</p>
  </div>
</section>


      <section class="widget-categorys widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
    <span>CATEGORYS</span>
  </div>
  <div class="widget-body">
    <ul class="categorys-list">
      
        <li class="categorys-list-item">
          <a href="/category/OpenGL/">
            OpenGL (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/category/Android%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/">
            Androidå›¾å½¢æ˜¾ç¤º (0)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/category/Android/">
            Android (2)
          </a>
        </li>
      
    </ul>
  </div>
</section>

      <section class="widget-tags widget-item  layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
    <span>TAGS</span>
  </div>
  <div class="widget-body">
    <div class="tags-cloud">
      <a href="/tag/Android/" style="font-size: 20px;" class="tags-cloud-10">Android</a> <a href="/tag/Android%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/" style="font-size: 10px;" class="tags-cloud-0">Androidå›¾å½¢æ˜¾ç¤º</a> <a href="/tag/OpenGL/" style="font-size: 15px;" class="tags-cloud-5">OpenGL</a>
    </div>
  </div>
</section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons">
      
        
      
        
      
        
      
        
          <a href="https://github.com/BlairRenaissance" class="soft-size--primary soft-style--box" target="_blank" rel="noopener noreferrer">
            <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
</svg>
          </a>
        
      
        
      
    </div>
     
    <p>&copy; 2024 <a href="/" target="_blank">Blair Ren</a></p>

    

    <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p>

    <p>
      <a href="javascript:;" id="theme-light">ğŸŒ æµ…è‰²</a>
      <a href="javascript:;" id="theme-dark">ğŸŒ› æ·±è‰²</a>
      <a href="javascript:;" id="theme-auto">ğŸ¤–ï¸ è‡ªåŠ¨</a>
    </p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed soft-size--round soft-style--box">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
      <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
      <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
    </svg>
  </div>

  
  <!-- aplayer -->


<!-- dplayer -->


<!-- copy button  -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

<!-- https://clipboardjs.com/ -->









  


  


  




<script src="/js/script.js"></script>


  
  <!-- å°¾éƒ¨ç”¨æˆ·è‡ªå®šä¹‰ç›¸å…³å†…å®¹ -->
</body>
</html>
